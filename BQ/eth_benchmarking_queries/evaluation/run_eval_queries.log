+ echo -e 'Query_Name\tJob_ID\tDuration_ms\tBytes_Processed\tSlot_Milliseconds'
++ date
+ echo 'Script started at Fri Nov  7 10:44:34 AM UTC 2025. Logging output to run_eval_queries.log'
Script started at Fri Nov  7 10:44:34 AM UTC 2025. Logging output to run_eval_queries.log
+ echo 'Summary will be written to execution_summary.tsv'
Summary will be written to execution_summary.tsv
+ echo ===========================================================
===========================================================
+ echo 'Checking for prerequisites...'
Checking for prerequisites...
+ command -v bq
+ command -v jq
+ echo 'Prerequisites '\''bq'\'' and '\''jq'\'' found.'
Prerequisites 'bq' and 'jq' found.
+ echo --------------------------------------------------
--------------------------------------------------
++ cat
+ QUERY_DAILY_AVG_UNOPTIMIZED='SELECT
    -- Calculating averages
    AVG(CAST(t.gas_price AS NUMERIC)) AS avg_gas_price_wei,
    AVG(t.value) AS avg_transaction_value_wei
FROM
    -- Scan the entire transactions table first
    `bigquery-public-data.crypto_ethereum_classic.transactions` AS t
WHERE
    -- 1. Find the latest date by re-calculating the MAX date for every row,
    -- or by joining the max_date CTE without an explicit ON clause,
    -- leading to a non-sargable predicate against the entire table.
    DATE(t.block_timestamp) = (
        SELECT MAX(DATE(block_timestamp))
        FROM `bigquery-public-data.crypto_ethereum_classic.transactions`
    )'
++ cat
+ QUERY_DAILY_AVG_OPTIMIZED='WITH max_date AS (
    -- 1. Determine the latest date once in an efficient, independent step.
    -- This operation is fast because it'\''s a single aggregation over the table.
    SELECT MAX(DATE(block_timestamp)) AS max_dt
    FROM `bigquery-public-data.crypto_ethereum_classic.transactions`
)
SELECT
    -- 2. Calculate the average gas price (casting INTEGER to NUMERIC for precision)
    AVG(CAST(t.gas_price AS NUMERIC)) AS avg_gas_price_wei,
    -- 3. Calculate the average transaction value (using the existing NUMERIC value column)
    AVG(t.value) AS avg_transaction_value_wei
FROM
    `bigquery-public-data.crypto_ethereum_classic.transactions` AS t
INNER JOIN
    -- 4. Join the main table to the single-row CTE, ensuring the filter is pushed down
    -- and the table is only scanned for the single target date.
    max_date AS m ON DATE(t.block_timestamp) = m.max_dt'
++ cat
+ QUERY_ERC20_UNOPTIMIZED='WITH ERC20_Contracts AS (
    -- CTE 1: Filters the small '\''contracts'\'' dimension table once to identify ERC20s.
    SELECT address 
    FROM `bigquery-public-data.crypto_ethereum_classic.contracts` 
    WHERE is_erc20 = TRUE
),
MonthlyLogCounts AS (
    -- CTE 2: Filters early and aggregates the massive '\''logs'\'' table to find high-activity contracts (> 1,000 logs/month).
    SELECT
        t1.address,
        FORMAT_DATE('\''%Y-%m'\'', t1.block_timestamp) AS transaction_month, 
        COUNT(t1.log_index) AS log_event_count 
    FROM
        `bigquery-public-data.crypto_ethereum_classic.logs` AS t1
    INNER JOIN
        ERC20_Contracts AS t2 ON t1.address = t2.address
    GROUP BY
        1, 2
    HAVING
        log_event_count > 1000
),
FrequentTopics AS (
    -- CTE 3: Joins the already filtered, small result from CTE 2 back to the '\''logs'\'' table
    -- only for the relevant contracts/months to find the topic frequency (event signature).
    SELECT
        t1.address,
        t1.transaction_month,
        topic,
        -- Applies a rank over the small, relevant subset of data.
        ROW_NUMBER() OVER (PARTITION BY t1.address, t1.transaction_month ORDER BY COUNT(topic) DESC) AS topic_rank
    FROM
        MonthlyLogCounts AS t1
    INNER JOIN
        `bigquery-public-data.crypto_ethereum_classic.logs` AS t2 
        ON t1.address = t2.address AND FORMAT_DATE('\''%Y-%m'\'', t2.block_timestamp) = t1.transaction_month
    CROSS JOIN
        UNNEST(t2.topics) AS topic WITH OFFSET AS topic_index
    WHERE
        topic_index = 0 -- Isolates the event signature hash (topics[0])
    GROUP BY
        1, 2, 3
)
-- Final Query: Selects the result ranked 1 (the most frequent event hash) for each contract/month.
SELECT
    COUNT(DISTINCT address) AS unique_erc20_contracts_exceeding_1k,
    ARRAY_AGG(
        STRUCT(t1.address, t1.transaction_month, t1.topic AS most_frequent_signature_hash) 
        ORDER BY t1.address, t1.transaction_month
    ) AS details_by_contract_and_month
FROM FrequentTopics AS t1
WHERE t1.topic_rank = 1'
++ cat
+ QUERY_ERC20_OPTIMIZED='WITH ERC20_Contracts AS (
    SELECT address FROM `bigquery-public-data.crypto_ethereum_classic.contracts` WHERE is_erc20 = TRUE
),
MonthlyLogCounts AS (
    SELECT
        t1.address,
        FORMAT_DATE('\''%Y-%m'\'', t1.block_timestamp) AS transaction_month, 
        COUNT(t1.log_index) AS log_event_count 
    FROM
        `bigquery-public-data.crypto_ethereum_classic.logs` AS t1
    INNER JOIN
        ERC20_Contracts AS t2 ON t1.address = t2.address
    GROUP BY
        1, 2
    HAVING
        log_event_count > 1000
),
FrequentTopics AS (
    SELECT
        t1.address,
        t1.transaction_month,
        topic,
        ROW_NUMBER() OVER (PARTITION BY t1.address, t1.transaction_month ORDER BY COUNT(topic) DESC) AS topic_rank
    FROM
        MonthlyLogCounts AS t1 -- Joins the already filtered and aggregated small list
    INNER JOIN
        `bigquery-public-data.crypto_ethereum_classic.logs` AS t2 
        ON t1.address = t2.address AND FORMAT_DATE('\''%Y-%m'\'', t2.block_timestamp) = t1.transaction_month
    CROSS JOIN
        UNNEST(t2.topics) AS topic WITH OFFSET AS topic_index
    WHERE
        topic_index = 0
    GROUP BY
        1, 2, 3
)
SELECT
    COUNT(DISTINCT address) AS unique_erc20_contracts_exceeding_1k,
    ARRAY_AGG(
        STRUCT(t1.address, t1.transaction_month, t1.topic AS most_frequent_signature_hash) 
        ORDER BY t1.address, t1.transaction_month
    ) AS details_by_contract_and_month
FROM FrequentTopics AS t1
WHERE t1.topic_rank = 1'
++ cat
+ QUERY_PEAK_SECURITY_UNOPTIMIZED='SELECT
    t1.miner,
    t1.gas_limit
FROM
    `bigquery-public-data.crypto_ethereum_classic.blocks` AS t1
WHERE
    t1.total_difficulty = (
        -- This forces a scan of the blocks table
        SELECT
            MAX(total_difficulty)
        FROM
            `bigquery-public-data.crypto_ethereum_classic.blocks`
    )
LIMIT 1'
++ cat
+ QUERY_PEAK_SECURITY_OPTIMIZED='SELECT
    t1.miner,
    t1.gas_limit
FROM
    (
        SELECT
            miner,
            gas_limit,
            ROW_NUMBER() OVER (ORDER BY total_difficulty DESC) AS rank_by_difficulty
        FROM
            `bigquery-public-data.crypto_ethereum_classic.blocks`
    ) AS t1
WHERE
    t1.rank_by_difficulty = 1
LIMIT 1'
++ cat
+ QUERY_TOP_INTERNAL_UNOPTIMIZED='SELECT
    t.to_address,
    SUM(t.value) AS total_value_received_wei
FROM
    `bigquery-public-data.crypto_ethereum_classic.traces` AS t
WHERE
    t.trace_type = '\''call'\''
    AND t.status = 1
    AND (t.call_type NOT IN ('\''delegatecall'\'', '\''callcode'\'', '\''staticcall'\'') OR t.call_type IS NULL)
    AND t.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''
    AND t.block_timestamp < '\''2020-01-08 00:00:00 UTC'\''
    AND t.to_address IS NOT NULL
GROUP BY
    t.to_address
ORDER BY
    total_value_received_wei DESC
LIMIT 10'
++ cat
+ QUERY_TOP_INTERNAL_OPTIMIZED='SELECT
    to_address,
    SUM(value) AS total_value_received_wei
FROM
    `bigquery-public-data.crypto_ethereum_classic.traces`
WHERE
    trace_type = '\''call'\''
    AND status = 1
    AND (call_type NOT IN ('\''delegatecall'\'', '\''callcode'\'', '\''staticcall'\'') OR call_type IS NULL)
    AND block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''
    AND block_timestamp < '\''2020-01-08 00:00:00 UTC'\''
    AND to_address IS NOT NULL
GROUP BY
    to_address
QUALIFY
    ROW_NUMBER() OVER (ORDER BY total_value_received_wei DESC) <= 10'
++ cat
+ QUERY_TOP_SENDER_UNOPTIMIZED='WITH TopSenders AS (
    -- CTE 1: Identify the top 5 addresses based on the count of successful transactions
    SELECT
        t.from_address AS address,
        COUNT(t.hash) AS transaction_count
    FROM
        `bigquery-public-data.crypto_ethereum_classic.transactions` AS t
    WHERE
        t.receipt_status = 1 
        AND t.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\'' 
        AND t.block_timestamp < '\''2020-04-01 00:00:00 UTC'\''  
    GROUP BY
        1
    ORDER BY
        transaction_count DESC
    LIMIT 5
),

TotalFees AS (
    -- CTE 2: Requires a second scan of the '\''transactions'\'' table unnecessarily
    SELECT
        t.from_address AS address,
        SUM(CAST(t.gas_price AS NUMERIC) * CAST(t.receipt_gas_used AS NUMERIC)) AS total_fees_paid
    FROM
        `bigquery-public-data.crypto_ethereum_classic.transactions` AS t
    INNER JOIN
        TopSenders AS s ON t.from_address = s.address
    WHERE
        t.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''
        AND t.block_timestamp < '\''2020-04-01 00:00:00 UTC'\''
        AND t.receipt_status = 1
    GROUP BY
        1
),

TotalValueSent AS (
    -- CTE 3: Scans the '\''traces'\'' table
    SELECT
        tr.from_address AS address,
        SUM(tr.value) AS total_value_sent
    FROM
        `bigquery-public-data.crypto_ethereum_classic.traces` AS tr
    INNER JOIN
        TopSenders AS s ON tr.from_address = s.address
    WHERE
        tr.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''  
        AND tr.block_timestamp < '\''2020-04-01 00:00:00 UTC'\'' 
    GROUP BY
        1
)

-- Final SELECT: Joins the calculated fees and values to find the net ether flow
SELECT
    f.address,
    v.total_value_sent,
    f.total_fees_paid,
    v.total_value_sent - f.total_fees_paid AS net_ether_flow_wei
FROM
    TotalFees AS f
INNER JOIN
    TotalValueSent AS v ON f.address = v.address
ORDER BY
    net_ether_flow_wei DESC
LIMIT 100'
++ cat
+ QUERY_TOP_SENDER_OPTIMIZED='WITH TransactionSummary AS (
    -- CTE 1 (Optimized): Single scan of the transactions table to calculate fees and rank all relevant senders.
    SELECT
        t.from_address,
        SUM(CAST(t.gas_price AS NUMERIC) * CAST(t.receipt_gas_used AS NUMERIC)) AS total_fees_paid,
        ROW_NUMBER() OVER (
            ORDER BY COUNT(t.hash) DESC
        ) AS rn_transaction_count
    FROM
        `bigquery-public-data.crypto_ethereum_classic.transactions` AS t
    WHERE
        t.receipt_status = 1 
        AND t.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''
        AND t.block_timestamp < '\''2020-04-01 00:00:00 UTC'\''
    GROUP BY
        1
),

TraceSummary AS (
    -- CTE 2 (Optimized): Single scan of the traces table to calculate the total value sent
    SELECT
        tr.from_address,
        SUM(tr.value) AS total_value_sent
    FROM
        `bigquery-public-data.crypto_ethereum_classic.traces` AS tr
    WHERE
        tr.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''  
        AND tr.block_timestamp < '\''2020-04-01 00:00:00 UTC'\''
    GROUP BY
        1
)

-- Final SELECT: Filter to the top 5 addresses (using the rank) and join the two pre-aggregated summaries.
SELECT
    ts.from_address,
    ts.total_fees_paid,
    vs.total_value_sent,
    vs.total_value_sent - ts.total_fees_paid AS net_ether_flow_wei
FROM
    TransactionSummary AS ts
INNER JOIN
    TraceSummary AS vs ON ts.from_address = vs.from_address
WHERE
    ts.rn_transaction_count <= 5 -- Filter down to the top 5 addresses
ORDER BY
    net_ether_flow_wei DESC
LIMIT 100'
+ echo '--- Running queries from daily_avg_value_and_fees_eval.sql ---'
--- Running queries from daily_avg_value_and_fees_eval.sql ---
+ run_query 'Daily Avg Unoptimized' 'SELECT
    -- Calculating averages
    AVG(CAST(t.gas_price AS NUMERIC)) AS avg_gas_price_wei,
    AVG(t.value) AS avg_transaction_value_wei
FROM
    -- Scan the entire transactions table first
    `bigquery-public-data.crypto_ethereum_classic.transactions` AS t
WHERE
    -- 1. Find the latest date by re-calculating the MAX date for every row,
    -- or by joining the max_date CTE without an explicit ON clause,
    -- leading to a non-sargable predicate against the entire table.
    DATE(t.block_timestamp) = (
        SELECT MAX(DATE(block_timestamp))
        FROM `bigquery-public-data.crypto_ethereum_classic.transactions`
    )'
+ local 'query_name=Daily Avg Unoptimized'
+ local 'query=SELECT
    -- Calculating averages
    AVG(CAST(t.gas_price AS NUMERIC)) AS avg_gas_price_wei,
    AVG(t.value) AS avg_transaction_value_wei
FROM
    -- Scan the entire transactions table first
    `bigquery-public-data.crypto_ethereum_classic.transactions` AS t
WHERE
    -- 1. Find the latest date by re-calculating the MAX date for every row,
    -- or by joining the max_date CTE without an explicit ON clause,
    -- leading to a non-sargable predicate against the entire table.
    DATE(t.block_timestamp) = (
        SELECT MAX(DATE(block_timestamp))
        FROM `bigquery-public-data.crypto_ethereum_classic.transactions`
    )'
+ echo ==================================================
==================================================
+ echo 'Executing Daily Avg Unoptimized'
Executing Daily Avg Unoptimized
+ echo ==================================================
==================================================
+ echo Query:
Query:
+ echo 'SELECT
    -- Calculating averages
    AVG(CAST(t.gas_price AS NUMERIC)) AS avg_gas_price_wei,
    AVG(t.value) AS avg_transaction_value_wei
FROM
    -- Scan the entire transactions table first
    `bigquery-public-data.crypto_ethereum_classic.transactions` AS t
WHERE
    -- 1. Find the latest date by re-calculating the MAX date for every row,
    -- or by joining the max_date CTE without an explicit ON clause,
    -- leading to a non-sargable predicate against the entire table.
    DATE(t.block_timestamp) = (
        SELECT MAX(DATE(block_timestamp))
        FROM `bigquery-public-data.crypto_ethereum_classic.transactions`
    )'
SELECT
    -- Calculating averages
    AVG(CAST(t.gas_price AS NUMERIC)) AS avg_gas_price_wei,
    AVG(t.value) AS avg_transaction_value_wei
FROM
    -- Scan the entire transactions table first
    `bigquery-public-data.crypto_ethereum_classic.transactions` AS t
WHERE
    -- 1. Find the latest date by re-calculating the MAX date for every row,
    -- or by joining the max_date CTE without an explicit ON clause,
    -- leading to a non-sargable predicate against the entire table.
    DATE(t.block_timestamp) = (
        SELECT MAX(DATE(block_timestamp))
        FROM `bigquery-public-data.crypto_ethereum_classic.transactions`
    )
+ echo --------------------------------------------------
--------------------------------------------------
++ bq query --nosync --use_legacy_sql=false --format=json --location=US 'SELECT
    -- Calculating averages
    AVG(CAST(t.gas_price AS NUMERIC)) AS avg_gas_price_wei,
    AVG(t.value) AS avg_transaction_value_wei
FROM
    -- Scan the entire transactions table first
    `bigquery-public-data.crypto_ethereum_classic.transactions` AS t
WHERE
    -- 1. Find the latest date by re-calculating the MAX date for every row,
    -- or by joining the max_date CTE without an explicit ON clause,
    -- leading to a non-sargable predicate against the entire table.
    DATE(t.block_timestamp) = (
        SELECT MAX(DATE(block_timestamp))
        FROM `bigquery-public-data.crypto_ethereum_classic.transactions`
    )'
+ job_submission_output='{"kind":"bigquery#job","etag":"x2GldDxm4O+8QKu1vSxsEQ==","id":"tony-allen:US.bqjob_r22f9d571074642fc_0000019a5deb0c96_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r22f9d571074642fc_0000019a5deb0c96_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"SELECT\n    -- Calculating averages\n    AVG(CAST(t.gas_price AS NUMERIC)) AS avg_gas_price_wei,\n    AVG(t.value) AS avg_transaction_value_wei\nFROM\n    -- Scan the entire transactions table first\n    `bigquery-public-data.crypto_ethereum_classic.transactions` AS t\nWHERE\n    -- 1. Find the latest date by re-calculating the MAX date for every row,\n    -- or by joining the max_date CTE without an explicit ON clause,\n    -- leading to a non-sargable predicate against the entire table.\n    DATE(t.block_timestamp) = (\n        SELECT MAX(DATE(block_timestamp))\n        FROM `bigquery-public-data.crypto_ethereum_classic.transactions`\n    )","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anonab4dc8a43b4f8b47c6d46270f5e17e6f74cb2372487ada14528e132f86c9437a"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r22f9d571074642fc_0000019a5deb0c96_1","location":"US"},"statistics":{"creationTime":"1762512277030","startTime":"1762512277186","endTime":"1762512278976","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT"}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ echo '{"kind":"bigquery#job","etag":"x2GldDxm4O+8QKu1vSxsEQ==","id":"tony-allen:US.bqjob_r22f9d571074642fc_0000019a5deb0c96_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r22f9d571074642fc_0000019a5deb0c96_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"SELECT\n    -- Calculating averages\n    AVG(CAST(t.gas_price AS NUMERIC)) AS avg_gas_price_wei,\n    AVG(t.value) AS avg_transaction_value_wei\nFROM\n    -- Scan the entire transactions table first\n    `bigquery-public-data.crypto_ethereum_classic.transactions` AS t\nWHERE\n    -- 1. Find the latest date by re-calculating the MAX date for every row,\n    -- or by joining the max_date CTE without an explicit ON clause,\n    -- leading to a non-sargable predicate against the entire table.\n    DATE(t.block_timestamp) = (\n        SELECT MAX(DATE(block_timestamp))\n        FROM `bigquery-public-data.crypto_ethereum_classic.transactions`\n    )","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anonab4dc8a43b4f8b47c6d46270f5e17e6f74cb2372487ada14528e132f86c9437a"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r22f9d571074642fc_0000019a5deb0c96_1","location":"US"},"statistics":{"creationTime":"1762512277030","startTime":"1762512277186","endTime":"1762512278976","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT"}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ jq -r .jobReference.jobId
+ job_id=bqjob_r22f9d571074642fc_0000019a5deb0c96_1
+ '[' -n bqjob_r22f9d571074642fc_0000019a5deb0c96_1 ']'
+ echo '  [SUCCESS] Query submitted.'
  [SUCCESS] Query submitted.
+ echo '  *** JOB ID FOR Daily Avg Unoptimized: bqjob_r22f9d571074642fc_0000019a5deb0c96_1 ***'
  *** JOB ID FOR Daily Avg Unoptimized: bqjob_r22f9d571074642fc_0000019a5deb0c96_1 ***
+ echo '  Waiting for job to complete...'
  Waiting for job to complete...
++ bq wait bqjob_r22f9d571074642fc_0000019a5deb0c96_1
+ wait_output='Waiting on bqjob_r22f9d571074642fc_0000019a5deb0c96_1 ... (0s) Current status: DONE   
Job tony-allen:bqjob_r22f9d571074642fc_0000019a5deb0c96_1

  Job Type    State      Start Time         Duration                User Email              Bytes Processed   Bytes Billed   Billing Tier   Labels  
 ---------- --------- ----------------- ---------------- --------------------------------- ----------------- -------------- -------------- -------- 
  query      SUCCESS   07 Nov 10:44:37   0:00:01.790000   admin@bentrollope.altostrat.com   0                 0                                     '
+ '[' 0 -ne 0 ']'
+ echo '  Job completed. Fetching statistics...'
  Job completed. Fetching statistics...
++ bq show --format=json -j bqjob_r22f9d571074642fc_0000019a5deb0c96_1
+ job_stats_json='{"kind":"bigquery#job","etag":"x2GldDxm4O+8QKu1vSxsEQ==","id":"tony-allen:US.bqjob_r22f9d571074642fc_0000019a5deb0c96_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r22f9d571074642fc_0000019a5deb0c96_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"SELECT\n    -- Calculating averages\n    AVG(CAST(t.gas_price AS NUMERIC)) AS avg_gas_price_wei,\n    AVG(t.value) AS avg_transaction_value_wei\nFROM\n    -- Scan the entire transactions table first\n    `bigquery-public-data.crypto_ethereum_classic.transactions` AS t\nWHERE\n    -- 1. Find the latest date by re-calculating the MAX date for every row,\n    -- or by joining the max_date CTE without an explicit ON clause,\n    -- leading to a non-sargable predicate against the entire table.\n    DATE(t.block_timestamp) = (\n        SELECT MAX(DATE(block_timestamp))\n        FROM `bigquery-public-data.crypto_ethereum_classic.transactions`\n    )","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anonab4dc8a43b4f8b47c6d46270f5e17e6f74cb2372487ada14528e132f86c9437a"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r22f9d571074642fc_0000019a5deb0c96_1","location":"US"},"statistics":{"creationTime":"1762512277030","startTime":"1762512277186","endTime":"1762512278976","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT"}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ echo '{"kind":"bigquery#job","etag":"x2GldDxm4O+8QKu1vSxsEQ==","id":"tony-allen:US.bqjob_r22f9d571074642fc_0000019a5deb0c96_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r22f9d571074642fc_0000019a5deb0c96_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"SELECT\n    -- Calculating averages\n    AVG(CAST(t.gas_price AS NUMERIC)) AS avg_gas_price_wei,\n    AVG(t.value) AS avg_transaction_value_wei\nFROM\n    -- Scan the entire transactions table first\n    `bigquery-public-data.crypto_ethereum_classic.transactions` AS t\nWHERE\n    -- 1. Find the latest date by re-calculating the MAX date for every row,\n    -- or by joining the max_date CTE without an explicit ON clause,\n    -- leading to a non-sargable predicate against the entire table.\n    DATE(t.block_timestamp) = (\n        SELECT MAX(DATE(block_timestamp))\n        FROM `bigquery-public-data.crypto_ethereum_classic.transactions`\n    )","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anonab4dc8a43b4f8b47c6d46270f5e17e6f74cb2372487ada14528e132f86c9437a"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r22f9d571074642fc_0000019a5deb0c96_1","location":"US"},"statistics":{"creationTime":"1762512277030","startTime":"1762512277186","endTime":"1762512278976","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT"}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ jq -r .statistics.totalBytesProcessed
+ total_bytes_processed=0
++ jq -r .statistics.totalSlotMs
++ echo '{"kind":"bigquery#job","etag":"x2GldDxm4O+8QKu1vSxsEQ==","id":"tony-allen:US.bqjob_r22f9d571074642fc_0000019a5deb0c96_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r22f9d571074642fc_0000019a5deb0c96_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"SELECT\n    -- Calculating averages\n    AVG(CAST(t.gas_price AS NUMERIC)) AS avg_gas_price_wei,\n    AVG(t.value) AS avg_transaction_value_wei\nFROM\n    -- Scan the entire transactions table first\n    `bigquery-public-data.crypto_ethereum_classic.transactions` AS t\nWHERE\n    -- 1. Find the latest date by re-calculating the MAX date for every row,\n    -- or by joining the max_date CTE without an explicit ON clause,\n    -- leading to a non-sargable predicate against the entire table.\n    DATE(t.block_timestamp) = (\n        SELECT MAX(DATE(block_timestamp))\n        FROM `bigquery-public-data.crypto_ethereum_classic.transactions`\n    )","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anonab4dc8a43b4f8b47c6d46270f5e17e6f74cb2372487ada14528e132f86c9437a"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r22f9d571074642fc_0000019a5deb0c96_1","location":"US"},"statistics":{"creationTime":"1762512277030","startTime":"1762512277186","endTime":"1762512278976","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT"}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
+ total_slot_ms=null
++ echo '{"kind":"bigquery#job","etag":"x2GldDxm4O+8QKu1vSxsEQ==","id":"tony-allen:US.bqjob_r22f9d571074642fc_0000019a5deb0c96_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r22f9d571074642fc_0000019a5deb0c96_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"SELECT\n    -- Calculating averages\n    AVG(CAST(t.gas_price AS NUMERIC)) AS avg_gas_price_wei,\n    AVG(t.value) AS avg_transaction_value_wei\nFROM\n    -- Scan the entire transactions table first\n    `bigquery-public-data.crypto_ethereum_classic.transactions` AS t\nWHERE\n    -- 1. Find the latest date by re-calculating the MAX date for every row,\n    -- or by joining the max_date CTE without an explicit ON clause,\n    -- leading to a non-sargable predicate against the entire table.\n    DATE(t.block_timestamp) = (\n        SELECT MAX(DATE(block_timestamp))\n        FROM `bigquery-public-data.crypto_ethereum_classic.transactions`\n    )","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anonab4dc8a43b4f8b47c6d46270f5e17e6f74cb2372487ada14528e132f86c9437a"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r22f9d571074642fc_0000019a5deb0c96_1","location":"US"},"statistics":{"creationTime":"1762512277030","startTime":"1762512277186","endTime":"1762512278976","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT"}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ jq -r .statistics.startTime
+ start_time=1762512277186
++ echo '{"kind":"bigquery#job","etag":"x2GldDxm4O+8QKu1vSxsEQ==","id":"tony-allen:US.bqjob_r22f9d571074642fc_0000019a5deb0c96_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r22f9d571074642fc_0000019a5deb0c96_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"SELECT\n    -- Calculating averages\n    AVG(CAST(t.gas_price AS NUMERIC)) AS avg_gas_price_wei,\n    AVG(t.value) AS avg_transaction_value_wei\nFROM\n    -- Scan the entire transactions table first\n    `bigquery-public-data.crypto_ethereum_classic.transactions` AS t\nWHERE\n    -- 1. Find the latest date by re-calculating the MAX date for every row,\n    -- or by joining the max_date CTE without an explicit ON clause,\n    -- leading to a non-sargable predicate against the entire table.\n    DATE(t.block_timestamp) = (\n        SELECT MAX(DATE(block_timestamp))\n        FROM `bigquery-public-data.crypto_ethereum_classic.transactions`\n    )","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anonab4dc8a43b4f8b47c6d46270f5e17e6f74cb2372487ada14528e132f86c9437a"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r22f9d571074642fc_0000019a5deb0c96_1","location":"US"},"statistics":{"creationTime":"1762512277030","startTime":"1762512277186","endTime":"1762512278976","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT"}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ jq -r .statistics.endTime
+ end_time=1762512278976
++ echo 1762512277186
++ awk '{print int($1)}'
+ start_ms=1762512277186
++ echo 1762512278976
++ awk '{print int($1)}'
+ end_ms=1762512278976
+ duration_ms=1790
+ echo '  --- Execution Statistics ---'
  --- Execution Statistics ---
+ echo '  Duration: 1790 ms'
  Duration: 1790 ms
+ echo '  Bytes Processed: 0 bytes'
  Bytes Processed: 0 bytes
+ echo '  Slot Milliseconds: null'
  Slot Milliseconds: null
+ echo '  ----------------------------'
  ----------------------------
+ echo -e 'Daily Avg Unoptimized\tbqjob_r22f9d571074642fc_0000019a5deb0c96_1\t1790\t0\tnull'
+ echo ''

+ run_query 'Daily Avg Optimized' 'WITH max_date AS (
    -- 1. Determine the latest date once in an efficient, independent step.
    -- This operation is fast because it'\''s a single aggregation over the table.
    SELECT MAX(DATE(block_timestamp)) AS max_dt
    FROM `bigquery-public-data.crypto_ethereum_classic.transactions`
)
SELECT
    -- 2. Calculate the average gas price (casting INTEGER to NUMERIC for precision)
    AVG(CAST(t.gas_price AS NUMERIC)) AS avg_gas_price_wei,
    -- 3. Calculate the average transaction value (using the existing NUMERIC value column)
    AVG(t.value) AS avg_transaction_value_wei
FROM
    `bigquery-public-data.crypto_ethereum_classic.transactions` AS t
INNER JOIN
    -- 4. Join the main table to the single-row CTE, ensuring the filter is pushed down
    -- and the table is only scanned for the single target date.
    max_date AS m ON DATE(t.block_timestamp) = m.max_dt'
+ local 'query_name=Daily Avg Optimized'
+ local 'query=WITH max_date AS (
    -- 1. Determine the latest date once in an efficient, independent step.
    -- This operation is fast because it'\''s a single aggregation over the table.
    SELECT MAX(DATE(block_timestamp)) AS max_dt
    FROM `bigquery-public-data.crypto_ethereum_classic.transactions`
)
SELECT
    -- 2. Calculate the average gas price (casting INTEGER to NUMERIC for precision)
    AVG(CAST(t.gas_price AS NUMERIC)) AS avg_gas_price_wei,
    -- 3. Calculate the average transaction value (using the existing NUMERIC value column)
    AVG(t.value) AS avg_transaction_value_wei
FROM
    `bigquery-public-data.crypto_ethereum_classic.transactions` AS t
INNER JOIN
    -- 4. Join the main table to the single-row CTE, ensuring the filter is pushed down
    -- and the table is only scanned for the single target date.
    max_date AS m ON DATE(t.block_timestamp) = m.max_dt'
+ echo ==================================================
==================================================
+ echo 'Executing Daily Avg Optimized'
Executing Daily Avg Optimized
+ echo ==================================================
==================================================
+ echo Query:
Query:
+ echo 'WITH max_date AS (
    -- 1. Determine the latest date once in an efficient, independent step.
    -- This operation is fast because it'\''s a single aggregation over the table.
    SELECT MAX(DATE(block_timestamp)) AS max_dt
    FROM `bigquery-public-data.crypto_ethereum_classic.transactions`
)
SELECT
    -- 2. Calculate the average gas price (casting INTEGER to NUMERIC for precision)
    AVG(CAST(t.gas_price AS NUMERIC)) AS avg_gas_price_wei,
    -- 3. Calculate the average transaction value (using the existing NUMERIC value column)
    AVG(t.value) AS avg_transaction_value_wei
FROM
    `bigquery-public-data.crypto_ethereum_classic.transactions` AS t
INNER JOIN
    -- 4. Join the main table to the single-row CTE, ensuring the filter is pushed down
    -- and the table is only scanned for the single target date.
    max_date AS m ON DATE(t.block_timestamp) = m.max_dt'
WITH max_date AS (
    -- 1. Determine the latest date once in an efficient, independent step.
    -- This operation is fast because it's a single aggregation over the table.
    SELECT MAX(DATE(block_timestamp)) AS max_dt
    FROM `bigquery-public-data.crypto_ethereum_classic.transactions`
)
SELECT
    -- 2. Calculate the average gas price (casting INTEGER to NUMERIC for precision)
    AVG(CAST(t.gas_price AS NUMERIC)) AS avg_gas_price_wei,
    -- 3. Calculate the average transaction value (using the existing NUMERIC value column)
    AVG(t.value) AS avg_transaction_value_wei
FROM
    `bigquery-public-data.crypto_ethereum_classic.transactions` AS t
INNER JOIN
    -- 4. Join the main table to the single-row CTE, ensuring the filter is pushed down
    -- and the table is only scanned for the single target date.
    max_date AS m ON DATE(t.block_timestamp) = m.max_dt
+ echo --------------------------------------------------
--------------------------------------------------
++ bq query --nosync --use_legacy_sql=false --format=json --location=US 'WITH max_date AS (
    -- 1. Determine the latest date once in an efficient, independent step.
    -- This operation is fast because it'\''s a single aggregation over the table.
    SELECT MAX(DATE(block_timestamp)) AS max_dt
    FROM `bigquery-public-data.crypto_ethereum_classic.transactions`
)
SELECT
    -- 2. Calculate the average gas price (casting INTEGER to NUMERIC for precision)
    AVG(CAST(t.gas_price AS NUMERIC)) AS avg_gas_price_wei,
    -- 3. Calculate the average transaction value (using the existing NUMERIC value column)
    AVG(t.value) AS avg_transaction_value_wei
FROM
    `bigquery-public-data.crypto_ethereum_classic.transactions` AS t
INNER JOIN
    -- 4. Join the main table to the single-row CTE, ensuring the filter is pushed down
    -- and the table is only scanned for the single target date.
    max_date AS m ON DATE(t.block_timestamp) = m.max_dt'
+ job_submission_output='{"kind":"bigquery#job","etag":"OSqARCCnmvnbMhlKNaewvQ==","id":"tony-allen:US.bqjob_r343b58ba97938b6a_0000019a5deb2ef0_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r343b58ba97938b6a_0000019a5deb2ef0_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"WITH max_date AS (\n    -- 1. Determine the latest date once in an efficient, independent step.\n    -- This operation is fast because it'\''s a single aggregation over the table.\n    SELECT MAX(DATE(block_timestamp)) AS max_dt\n    FROM `bigquery-public-data.crypto_ethereum_classic.transactions`\n)\nSELECT\n    -- 2. Calculate the average gas price (casting INTEGER to NUMERIC for precision)\n    AVG(CAST(t.gas_price AS NUMERIC)) AS avg_gas_price_wei,\n    -- 3. Calculate the average transaction value (using the existing NUMERIC value column)\n    AVG(t.value) AS avg_transaction_value_wei\nFROM\n    `bigquery-public-data.crypto_ethereum_classic.transactions` AS t\nINNER JOIN\n    -- 4. Join the main table to the single-row CTE, ensuring the filter is pushed down\n    -- and the table is only scanned for the single target date.\n    max_date AS m ON DATE(t.block_timestamp) = m.max_dt","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anon59d1e6b89de57a3b26e230c4c484f1d48b9e78f6f32722bc9d46949e320bfcef"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r343b58ba97938b6a_0000019a5deb2ef0_1","location":"US"},"statistics":{"creationTime":"1762512285653","startTime":"1762512285758","endTime":"1762512287267","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT"}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ jq -r .jobReference.jobId
++ echo '{"kind":"bigquery#job","etag":"OSqARCCnmvnbMhlKNaewvQ==","id":"tony-allen:US.bqjob_r343b58ba97938b6a_0000019a5deb2ef0_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r343b58ba97938b6a_0000019a5deb2ef0_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"WITH max_date AS (\n    -- 1. Determine the latest date once in an efficient, independent step.\n    -- This operation is fast because it'\''s a single aggregation over the table.\n    SELECT MAX(DATE(block_timestamp)) AS max_dt\n    FROM `bigquery-public-data.crypto_ethereum_classic.transactions`\n)\nSELECT\n    -- 2. Calculate the average gas price (casting INTEGER to NUMERIC for precision)\n    AVG(CAST(t.gas_price AS NUMERIC)) AS avg_gas_price_wei,\n    -- 3. Calculate the average transaction value (using the existing NUMERIC value column)\n    AVG(t.value) AS avg_transaction_value_wei\nFROM\n    `bigquery-public-data.crypto_ethereum_classic.transactions` AS t\nINNER JOIN\n    -- 4. Join the main table to the single-row CTE, ensuring the filter is pushed down\n    -- and the table is only scanned for the single target date.\n    max_date AS m ON DATE(t.block_timestamp) = m.max_dt","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anon59d1e6b89de57a3b26e230c4c484f1d48b9e78f6f32722bc9d46949e320bfcef"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r343b58ba97938b6a_0000019a5deb2ef0_1","location":"US"},"statistics":{"creationTime":"1762512285653","startTime":"1762512285758","endTime":"1762512287267","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT"}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
+ job_id=bqjob_r343b58ba97938b6a_0000019a5deb2ef0_1
+ '[' -n bqjob_r343b58ba97938b6a_0000019a5deb2ef0_1 ']'
+ echo '  [SUCCESS] Query submitted.'
  [SUCCESS] Query submitted.
+ echo '  *** JOB ID FOR Daily Avg Optimized: bqjob_r343b58ba97938b6a_0000019a5deb2ef0_1 ***'
  *** JOB ID FOR Daily Avg Optimized: bqjob_r343b58ba97938b6a_0000019a5deb2ef0_1 ***
+ echo '  Waiting for job to complete...'
  Waiting for job to complete...
++ bq wait bqjob_r343b58ba97938b6a_0000019a5deb2ef0_1
+ wait_output='Waiting on bqjob_r343b58ba97938b6a_0000019a5deb2ef0_1 ... (0s) Current status: DONE   
Job tony-allen:bqjob_r343b58ba97938b6a_0000019a5deb2ef0_1

  Job Type    State      Start Time         Duration                User Email              Bytes Processed   Bytes Billed   Billing Tier   Labels  
 ---------- --------- ----------------- ---------------- --------------------------------- ----------------- -------------- -------------- -------- 
  query      SUCCESS   07 Nov 10:44:45   0:00:01.509000   admin@bentrollope.altostrat.com   0                 0                                     '
+ '[' 0 -ne 0 ']'
+ echo '  Job completed. Fetching statistics...'
  Job completed. Fetching statistics...
++ bq show --format=json -j bqjob_r343b58ba97938b6a_0000019a5deb2ef0_1
+ job_stats_json='{"kind":"bigquery#job","etag":"OSqARCCnmvnbMhlKNaewvQ==","id":"tony-allen:US.bqjob_r343b58ba97938b6a_0000019a5deb2ef0_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r343b58ba97938b6a_0000019a5deb2ef0_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"WITH max_date AS (\n    -- 1. Determine the latest date once in an efficient, independent step.\n    -- This operation is fast because it'\''s a single aggregation over the table.\n    SELECT MAX(DATE(block_timestamp)) AS max_dt\n    FROM `bigquery-public-data.crypto_ethereum_classic.transactions`\n)\nSELECT\n    -- 2. Calculate the average gas price (casting INTEGER to NUMERIC for precision)\n    AVG(CAST(t.gas_price AS NUMERIC)) AS avg_gas_price_wei,\n    -- 3. Calculate the average transaction value (using the existing NUMERIC value column)\n    AVG(t.value) AS avg_transaction_value_wei\nFROM\n    `bigquery-public-data.crypto_ethereum_classic.transactions` AS t\nINNER JOIN\n    -- 4. Join the main table to the single-row CTE, ensuring the filter is pushed down\n    -- and the table is only scanned for the single target date.\n    max_date AS m ON DATE(t.block_timestamp) = m.max_dt","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anon59d1e6b89de57a3b26e230c4c484f1d48b9e78f6f32722bc9d46949e320bfcef"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r343b58ba97938b6a_0000019a5deb2ef0_1","location":"US"},"statistics":{"creationTime":"1762512285653","startTime":"1762512285758","endTime":"1762512287267","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT"}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ jq -r .statistics.totalBytesProcessed
++ echo '{"kind":"bigquery#job","etag":"OSqARCCnmvnbMhlKNaewvQ==","id":"tony-allen:US.bqjob_r343b58ba97938b6a_0000019a5deb2ef0_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r343b58ba97938b6a_0000019a5deb2ef0_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"WITH max_date AS (\n    -- 1. Determine the latest date once in an efficient, independent step.\n    -- This operation is fast because it'\''s a single aggregation over the table.\n    SELECT MAX(DATE(block_timestamp)) AS max_dt\n    FROM `bigquery-public-data.crypto_ethereum_classic.transactions`\n)\nSELECT\n    -- 2. Calculate the average gas price (casting INTEGER to NUMERIC for precision)\n    AVG(CAST(t.gas_price AS NUMERIC)) AS avg_gas_price_wei,\n    -- 3. Calculate the average transaction value (using the existing NUMERIC value column)\n    AVG(t.value) AS avg_transaction_value_wei\nFROM\n    `bigquery-public-data.crypto_ethereum_classic.transactions` AS t\nINNER JOIN\n    -- 4. Join the main table to the single-row CTE, ensuring the filter is pushed down\n    -- and the table is only scanned for the single target date.\n    max_date AS m ON DATE(t.block_timestamp) = m.max_dt","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anon59d1e6b89de57a3b26e230c4c484f1d48b9e78f6f32722bc9d46949e320bfcef"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r343b58ba97938b6a_0000019a5deb2ef0_1","location":"US"},"statistics":{"creationTime":"1762512285653","startTime":"1762512285758","endTime":"1762512287267","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT"}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
+ total_bytes_processed=0
++ echo '{"kind":"bigquery#job","etag":"OSqARCCnmvnbMhlKNaewvQ==","id":"tony-allen:US.bqjob_r343b58ba97938b6a_0000019a5deb2ef0_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r343b58ba97938b6a_0000019a5deb2ef0_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"WITH max_date AS (\n    -- 1. Determine the latest date once in an efficient, independent step.\n    -- This operation is fast because it'\''s a single aggregation over the table.\n    SELECT MAX(DATE(block_timestamp)) AS max_dt\n    FROM `bigquery-public-data.crypto_ethereum_classic.transactions`\n)\nSELECT\n    -- 2. Calculate the average gas price (casting INTEGER to NUMERIC for precision)\n    AVG(CAST(t.gas_price AS NUMERIC)) AS avg_gas_price_wei,\n    -- 3. Calculate the average transaction value (using the existing NUMERIC value column)\n    AVG(t.value) AS avg_transaction_value_wei\nFROM\n    `bigquery-public-data.crypto_ethereum_classic.transactions` AS t\nINNER JOIN\n    -- 4. Join the main table to the single-row CTE, ensuring the filter is pushed down\n    -- and the table is only scanned for the single target date.\n    max_date AS m ON DATE(t.block_timestamp) = m.max_dt","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anon59d1e6b89de57a3b26e230c4c484f1d48b9e78f6f32722bc9d46949e320bfcef"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r343b58ba97938b6a_0000019a5deb2ef0_1","location":"US"},"statistics":{"creationTime":"1762512285653","startTime":"1762512285758","endTime":"1762512287267","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT"}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ jq -r .statistics.totalSlotMs
+ total_slot_ms=null
++ echo '{"kind":"bigquery#job","etag":"OSqARCCnmvnbMhlKNaewvQ==","id":"tony-allen:US.bqjob_r343b58ba97938b6a_0000019a5deb2ef0_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r343b58ba97938b6a_0000019a5deb2ef0_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"WITH max_date AS (\n    -- 1. Determine the latest date once in an efficient, independent step.\n    -- This operation is fast because it'\''s a single aggregation over the table.\n    SELECT MAX(DATE(block_timestamp)) AS max_dt\n    FROM `bigquery-public-data.crypto_ethereum_classic.transactions`\n)\nSELECT\n    -- 2. Calculate the average gas price (casting INTEGER to NUMERIC for precision)\n    AVG(CAST(t.gas_price AS NUMERIC)) AS avg_gas_price_wei,\n    -- 3. Calculate the average transaction value (using the existing NUMERIC value column)\n    AVG(t.value) AS avg_transaction_value_wei\nFROM\n    `bigquery-public-data.crypto_ethereum_classic.transactions` AS t\nINNER JOIN\n    -- 4. Join the main table to the single-row CTE, ensuring the filter is pushed down\n    -- and the table is only scanned for the single target date.\n    max_date AS m ON DATE(t.block_timestamp) = m.max_dt","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anon59d1e6b89de57a3b26e230c4c484f1d48b9e78f6f32722bc9d46949e320bfcef"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r343b58ba97938b6a_0000019a5deb2ef0_1","location":"US"},"statistics":{"creationTime":"1762512285653","startTime":"1762512285758","endTime":"1762512287267","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT"}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ jq -r .statistics.startTime
+ start_time=1762512285758
++ echo '{"kind":"bigquery#job","etag":"OSqARCCnmvnbMhlKNaewvQ==","id":"tony-allen:US.bqjob_r343b58ba97938b6a_0000019a5deb2ef0_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r343b58ba97938b6a_0000019a5deb2ef0_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"WITH max_date AS (\n    -- 1. Determine the latest date once in an efficient, independent step.\n    -- This operation is fast because it'\''s a single aggregation over the table.\n    SELECT MAX(DATE(block_timestamp)) AS max_dt\n    FROM `bigquery-public-data.crypto_ethereum_classic.transactions`\n)\nSELECT\n    -- 2. Calculate the average gas price (casting INTEGER to NUMERIC for precision)\n    AVG(CAST(t.gas_price AS NUMERIC)) AS avg_gas_price_wei,\n    -- 3. Calculate the average transaction value (using the existing NUMERIC value column)\n    AVG(t.value) AS avg_transaction_value_wei\nFROM\n    `bigquery-public-data.crypto_ethereum_classic.transactions` AS t\nINNER JOIN\n    -- 4. Join the main table to the single-row CTE, ensuring the filter is pushed down\n    -- and the table is only scanned for the single target date.\n    max_date AS m ON DATE(t.block_timestamp) = m.max_dt","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anon59d1e6b89de57a3b26e230c4c484f1d48b9e78f6f32722bc9d46949e320bfcef"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r343b58ba97938b6a_0000019a5deb2ef0_1","location":"US"},"statistics":{"creationTime":"1762512285653","startTime":"1762512285758","endTime":"1762512287267","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT"}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ jq -r .statistics.endTime
+ end_time=1762512287267
++ echo 1762512285758
++ awk '{print int($1)}'
+ start_ms=1762512285758
++ echo 1762512287267
++ awk '{print int($1)}'
+ end_ms=1762512287267
+ duration_ms=1509
+ echo '  --- Execution Statistics ---'
  --- Execution Statistics ---
+ echo '  Duration: 1509 ms'
  Duration: 1509 ms
+ echo '  Bytes Processed: 0 bytes'
  Bytes Processed: 0 bytes
+ echo '  Slot Milliseconds: null'
  Slot Milliseconds: null
+ echo '  ----------------------------'
  ----------------------------
+ echo -e 'Daily Avg Optimized\tbqjob_r343b58ba97938b6a_0000019a5deb2ef0_1\t1509\t0\tnull'
+ echo ''

+ echo '--- Running queries from erc20_high_activity_event_analysis_eval.sql ---'
--- Running queries from erc20_high_activity_event_analysis_eval.sql ---
+ run_query 'ERC20 Unoptimized' 'WITH ERC20_Contracts AS (
    -- CTE 1: Filters the small '\''contracts'\'' dimension table once to identify ERC20s.
    SELECT address 
    FROM `bigquery-public-data.crypto_ethereum_classic.contracts` 
    WHERE is_erc20 = TRUE
),
MonthlyLogCounts AS (
    -- CTE 2: Filters early and aggregates the massive '\''logs'\'' table to find high-activity contracts (> 1,000 logs/month).
    SELECT
        t1.address,
        FORMAT_DATE('\''%Y-%m'\'', t1.block_timestamp) AS transaction_month, 
        COUNT(t1.log_index) AS log_event_count 
    FROM
        `bigquery-public-data.crypto_ethereum_classic.logs` AS t1
    INNER JOIN
        ERC20_Contracts AS t2 ON t1.address = t2.address
    GROUP BY
        1, 2
    HAVING
        log_event_count > 1000
),
FrequentTopics AS (
    -- CTE 3: Joins the already filtered, small result from CTE 2 back to the '\''logs'\'' table
    -- only for the relevant contracts/months to find the topic frequency (event signature).
    SELECT
        t1.address,
        t1.transaction_month,
        topic,
        -- Applies a rank over the small, relevant subset of data.
        ROW_NUMBER() OVER (PARTITION BY t1.address, t1.transaction_month ORDER BY COUNT(topic) DESC) AS topic_rank
    FROM
        MonthlyLogCounts AS t1
    INNER JOIN
        `bigquery-public-data.crypto_ethereum_classic.logs` AS t2 
        ON t1.address = t2.address AND FORMAT_DATE('\''%Y-%m'\'', t2.block_timestamp) = t1.transaction_month
    CROSS JOIN
        UNNEST(t2.topics) AS topic WITH OFFSET AS topic_index
    WHERE
        topic_index = 0 -- Isolates the event signature hash (topics[0])
    GROUP BY
        1, 2, 3
)
-- Final Query: Selects the result ranked 1 (the most frequent event hash) for each contract/month.
SELECT
    COUNT(DISTINCT address) AS unique_erc20_contracts_exceeding_1k,
    ARRAY_AGG(
        STRUCT(t1.address, t1.transaction_month, t1.topic AS most_frequent_signature_hash) 
        ORDER BY t1.address, t1.transaction_month
    ) AS details_by_contract_and_month
FROM FrequentTopics AS t1
WHERE t1.topic_rank = 1'
+ local 'query_name=ERC20 Unoptimized'
+ local 'query=WITH ERC20_Contracts AS (
    -- CTE 1: Filters the small '\''contracts'\'' dimension table once to identify ERC20s.
    SELECT address 
    FROM `bigquery-public-data.crypto_ethereum_classic.contracts` 
    WHERE is_erc20 = TRUE
),
MonthlyLogCounts AS (
    -- CTE 2: Filters early and aggregates the massive '\''logs'\'' table to find high-activity contracts (> 1,000 logs/month).
    SELECT
        t1.address,
        FORMAT_DATE('\''%Y-%m'\'', t1.block_timestamp) AS transaction_month, 
        COUNT(t1.log_index) AS log_event_count 
    FROM
        `bigquery-public-data.crypto_ethereum_classic.logs` AS t1
    INNER JOIN
        ERC20_Contracts AS t2 ON t1.address = t2.address
    GROUP BY
        1, 2
    HAVING
        log_event_count > 1000
),
FrequentTopics AS (
    -- CTE 3: Joins the already filtered, small result from CTE 2 back to the '\''logs'\'' table
    -- only for the relevant contracts/months to find the topic frequency (event signature).
    SELECT
        t1.address,
        t1.transaction_month,
        topic,
        -- Applies a rank over the small, relevant subset of data.
        ROW_NUMBER() OVER (PARTITION BY t1.address, t1.transaction_month ORDER BY COUNT(topic) DESC) AS topic_rank
    FROM
        MonthlyLogCounts AS t1
    INNER JOIN
        `bigquery-public-data.crypto_ethereum_classic.logs` AS t2 
        ON t1.address = t2.address AND FORMAT_DATE('\''%Y-%m'\'', t2.block_timestamp) = t1.transaction_month
    CROSS JOIN
        UNNEST(t2.topics) AS topic WITH OFFSET AS topic_index
    WHERE
        topic_index = 0 -- Isolates the event signature hash (topics[0])
    GROUP BY
        1, 2, 3
)
-- Final Query: Selects the result ranked 1 (the most frequent event hash) for each contract/month.
SELECT
    COUNT(DISTINCT address) AS unique_erc20_contracts_exceeding_1k,
    ARRAY_AGG(
        STRUCT(t1.address, t1.transaction_month, t1.topic AS most_frequent_signature_hash) 
        ORDER BY t1.address, t1.transaction_month
    ) AS details_by_contract_and_month
FROM FrequentTopics AS t1
WHERE t1.topic_rank = 1'
+ echo ==================================================
==================================================
+ echo 'Executing ERC20 Unoptimized'
Executing ERC20 Unoptimized
+ echo ==================================================
==================================================
+ echo Query:
Query:
+ echo 'WITH ERC20_Contracts AS (
    -- CTE 1: Filters the small '\''contracts'\'' dimension table once to identify ERC20s.
    SELECT address 
    FROM `bigquery-public-data.crypto_ethereum_classic.contracts` 
    WHERE is_erc20 = TRUE
),
MonthlyLogCounts AS (
    -- CTE 2: Filters early and aggregates the massive '\''logs'\'' table to find high-activity contracts (> 1,000 logs/month).
    SELECT
        t1.address,
        FORMAT_DATE('\''%Y-%m'\'', t1.block_timestamp) AS transaction_month, 
        COUNT(t1.log_index) AS log_event_count 
    FROM
        `bigquery-public-data.crypto_ethereum_classic.logs` AS t1
    INNER JOIN
        ERC20_Contracts AS t2 ON t1.address = t2.address
    GROUP BY
        1, 2
    HAVING
        log_event_count > 1000
),
FrequentTopics AS (
    -- CTE 3: Joins the already filtered, small result from CTE 2 back to the '\''logs'\'' table
    -- only for the relevant contracts/months to find the topic frequency (event signature).
    SELECT
        t1.address,
        t1.transaction_month,
        topic,
        -- Applies a rank over the small, relevant subset of data.
        ROW_NUMBER() OVER (PARTITION BY t1.address, t1.transaction_month ORDER BY COUNT(topic) DESC) AS topic_rank
    FROM
        MonthlyLogCounts AS t1
    INNER JOIN
        `bigquery-public-data.crypto_ethereum_classic.logs` AS t2 
        ON t1.address = t2.address AND FORMAT_DATE('\''%Y-%m'\'', t2.block_timestamp) = t1.transaction_month
    CROSS JOIN
        UNNEST(t2.topics) AS topic WITH OFFSET AS topic_index
    WHERE
        topic_index = 0 -- Isolates the event signature hash (topics[0])
    GROUP BY
        1, 2, 3
)
-- Final Query: Selects the result ranked 1 (the most frequent event hash) for each contract/month.
SELECT
    COUNT(DISTINCT address) AS unique_erc20_contracts_exceeding_1k,
    ARRAY_AGG(
        STRUCT(t1.address, t1.transaction_month, t1.topic AS most_frequent_signature_hash) 
        ORDER BY t1.address, t1.transaction_month
    ) AS details_by_contract_and_month
FROM FrequentTopics AS t1
WHERE t1.topic_rank = 1'
WITH ERC20_Contracts AS (
    -- CTE 1: Filters the small 'contracts' dimension table once to identify ERC20s.
    SELECT address 
    FROM `bigquery-public-data.crypto_ethereum_classic.contracts` 
    WHERE is_erc20 = TRUE
),
MonthlyLogCounts AS (
    -- CTE 2: Filters early and aggregates the massive 'logs' table to find high-activity contracts (> 1,000 logs/month).
    SELECT
        t1.address,
        FORMAT_DATE('%Y-%m', t1.block_timestamp) AS transaction_month, 
        COUNT(t1.log_index) AS log_event_count 
    FROM
        `bigquery-public-data.crypto_ethereum_classic.logs` AS t1
    INNER JOIN
        ERC20_Contracts AS t2 ON t1.address = t2.address
    GROUP BY
        1, 2
    HAVING
        log_event_count > 1000
),
FrequentTopics AS (
    -- CTE 3: Joins the already filtered, small result from CTE 2 back to the 'logs' table
    -- only for the relevant contracts/months to find the topic frequency (event signature).
    SELECT
        t1.address,
        t1.transaction_month,
        topic,
        -- Applies a rank over the small, relevant subset of data.
        ROW_NUMBER() OVER (PARTITION BY t1.address, t1.transaction_month ORDER BY COUNT(topic) DESC) AS topic_rank
    FROM
        MonthlyLogCounts AS t1
    INNER JOIN
        `bigquery-public-data.crypto_ethereum_classic.logs` AS t2 
        ON t1.address = t2.address AND FORMAT_DATE('%Y-%m', t2.block_timestamp) = t1.transaction_month
    CROSS JOIN
        UNNEST(t2.topics) AS topic WITH OFFSET AS topic_index
    WHERE
        topic_index = 0 -- Isolates the event signature hash (topics[0])
    GROUP BY
        1, 2, 3
)
-- Final Query: Selects the result ranked 1 (the most frequent event hash) for each contract/month.
SELECT
    COUNT(DISTINCT address) AS unique_erc20_contracts_exceeding_1k,
    ARRAY_AGG(
        STRUCT(t1.address, t1.transaction_month, t1.topic AS most_frequent_signature_hash) 
        ORDER BY t1.address, t1.transaction_month
    ) AS details_by_contract_and_month
FROM FrequentTopics AS t1
WHERE t1.topic_rank = 1
+ echo --------------------------------------------------
--------------------------------------------------
++ bq query --nosync --use_legacy_sql=false --format=json --location=US 'WITH ERC20_Contracts AS (
    -- CTE 1: Filters the small '\''contracts'\'' dimension table once to identify ERC20s.
    SELECT address 
    FROM `bigquery-public-data.crypto_ethereum_classic.contracts` 
    WHERE is_erc20 = TRUE
),
MonthlyLogCounts AS (
    -- CTE 2: Filters early and aggregates the massive '\''logs'\'' table to find high-activity contracts (> 1,000 logs/month).
    SELECT
        t1.address,
        FORMAT_DATE('\''%Y-%m'\'', t1.block_timestamp) AS transaction_month, 
        COUNT(t1.log_index) AS log_event_count 
    FROM
        `bigquery-public-data.crypto_ethereum_classic.logs` AS t1
    INNER JOIN
        ERC20_Contracts AS t2 ON t1.address = t2.address
    GROUP BY
        1, 2
    HAVING
        log_event_count > 1000
),
FrequentTopics AS (
    -- CTE 3: Joins the already filtered, small result from CTE 2 back to the '\''logs'\'' table
    -- only for the relevant contracts/months to find the topic frequency (event signature).
    SELECT
        t1.address,
        t1.transaction_month,
        topic,
        -- Applies a rank over the small, relevant subset of data.
        ROW_NUMBER() OVER (PARTITION BY t1.address, t1.transaction_month ORDER BY COUNT(topic) DESC) AS topic_rank
    FROM
        MonthlyLogCounts AS t1
    INNER JOIN
        `bigquery-public-data.crypto_ethereum_classic.logs` AS t2 
        ON t1.address = t2.address AND FORMAT_DATE('\''%Y-%m'\'', t2.block_timestamp) = t1.transaction_month
    CROSS JOIN
        UNNEST(t2.topics) AS topic WITH OFFSET AS topic_index
    WHERE
        topic_index = 0 -- Isolates the event signature hash (topics[0])
    GROUP BY
        1, 2, 3
)
-- Final Query: Selects the result ranked 1 (the most frequent event hash) for each contract/month.
SELECT
    COUNT(DISTINCT address) AS unique_erc20_contracts_exceeding_1k,
    ARRAY_AGG(
        STRUCT(t1.address, t1.transaction_month, t1.topic AS most_frequent_signature_hash) 
        ORDER BY t1.address, t1.transaction_month
    ) AS details_by_contract_and_month
FROM FrequentTopics AS t1
WHERE t1.topic_rank = 1'
+ job_submission_output='{"kind":"bigquery#job","etag":"m0WaMYYU88r+0/T8hUKnFg==","id":"tony-allen:US.bqjob_r5cd2f3de8b4b895c_0000019a5deb5037_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r5cd2f3de8b4b895c_0000019a5deb5037_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"WITH ERC20_Contracts AS (\n    -- CTE 1: Filters the small '\''contracts'\'' dimension table once to identify ERC20s.\n    SELECT address \n    FROM `bigquery-public-data.crypto_ethereum_classic.contracts` \n    WHERE is_erc20 = TRUE\n),\nMonthlyLogCounts AS (\n    -- CTE 2: Filters early and aggregates the massive '\''logs'\'' table to find high-activity contracts (> 1,000 logs/month).\n    SELECT\n        t1.address,\n        FORMAT_DATE('\''%Y-%m'\'', t1.block_timestamp) AS transaction_month, \n        COUNT(t1.log_index) AS log_event_count \n    FROM\n        `bigquery-public-data.crypto_ethereum_classic.logs` AS t1\n    INNER JOIN\n        ERC20_Contracts AS t2 ON t1.address = t2.address\n    GROUP BY\n        1, 2\n    HAVING\n        log_event_count > 1000\n),\nFrequentTopics AS (\n    -- CTE 3: Joins the already filtered, small result from CTE 2 back to the '\''logs'\'' table\n    -- only for the relevant contracts/months to find the topic frequency (event signature).\n    SELECT\n        t1.address,\n        t1.transaction_month,\n        topic,\n        -- Applies a rank over the small, relevant subset of data.\n        ROW_NUMBER() OVER (PARTITION BY t1.address, t1.transaction_month ORDER BY COUNT(topic) DESC) AS topic_rank\n    FROM\n        MonthlyLogCounts AS t1\n    INNER JOIN\n        `bigquery-public-data.crypto_ethereum_classic.logs` AS t2 \n        ON t1.address = t2.address AND FORMAT_DATE('\''%Y-%m'\'', t2.block_timestamp) = t1.transaction_month\n    CROSS JOIN\n        UNNEST(t2.topics) AS topic WITH OFFSET AS topic_index\n    WHERE\n        topic_index = 0 -- Isolates the event signature hash (topics[0])\n    GROUP BY\n        1, 2, 3\n)\n-- Final Query: Selects the result ranked 1 (the most frequent event hash) for each contract/month.\nSELECT\n    COUNT(DISTINCT address) AS unique_erc20_contracts_exceeding_1k,\n    ARRAY_AGG(\n        STRUCT(t1.address, t1.transaction_month, t1.topic AS most_frequent_signature_hash) \n        ORDER BY t1.address, t1.transaction_month\n    ) AS details_by_contract_and_month\nFROM FrequentTopics AS t1\nWHERE t1.topic_rank = 1","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anonb60b39bae3e304aed1441e913e041212066591abcd3d7f2dc878f8967ff9b9f4"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r5cd2f3de8b4b895c_0000019a5deb5037_1","location":"US"},"statistics":{"creationTime":"1762512294177","startTime":"1762512294291","endTime":"1762512295371","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT","searchStatistics":{"indexUsageMode":"UNUSED","indexUnusedReasons":[{"code":"QUERY_CACHE_HIT","message":"Search indexes are not used because the query was cached."}]}}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ echo '{"kind":"bigquery#job","etag":"m0WaMYYU88r+0/T8hUKnFg==","id":"tony-allen:US.bqjob_r5cd2f3de8b4b895c_0000019a5deb5037_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r5cd2f3de8b4b895c_0000019a5deb5037_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"WITH ERC20_Contracts AS (\n    -- CTE 1: Filters the small '\''contracts'\'' dimension table once to identify ERC20s.\n    SELECT address \n    FROM `bigquery-public-data.crypto_ethereum_classic.contracts` \n    WHERE is_erc20 = TRUE\n),\nMonthlyLogCounts AS (\n    -- CTE 2: Filters early and aggregates the massive '\''logs'\'' table to find high-activity contracts (> 1,000 logs/month).\n    SELECT\n        t1.address,\n        FORMAT_DATE('\''%Y-%m'\'', t1.block_timestamp) AS transaction_month, \n        COUNT(t1.log_index) AS log_event_count \n    FROM\n        `bigquery-public-data.crypto_ethereum_classic.logs` AS t1\n    INNER JOIN\n        ERC20_Contracts AS t2 ON t1.address = t2.address\n    GROUP BY\n        1, 2\n    HAVING\n        log_event_count > 1000\n),\nFrequentTopics AS (\n    -- CTE 3: Joins the already filtered, small result from CTE 2 back to the '\''logs'\'' table\n    -- only for the relevant contracts/months to find the topic frequency (event signature).\n    SELECT\n        t1.address,\n        t1.transaction_month,\n        topic,\n        -- Applies a rank over the small, relevant subset of data.\n        ROW_NUMBER() OVER (PARTITION BY t1.address, t1.transaction_month ORDER BY COUNT(topic) DESC) AS topic_rank\n    FROM\n        MonthlyLogCounts AS t1\n    INNER JOIN\n        `bigquery-public-data.crypto_ethereum_classic.logs` AS t2 \n        ON t1.address = t2.address AND FORMAT_DATE('\''%Y-%m'\'', t2.block_timestamp) = t1.transaction_month\n    CROSS JOIN\n        UNNEST(t2.topics) AS topic WITH OFFSET AS topic_index\n    WHERE\n        topic_index = 0 -- Isolates the event signature hash (topics[0])\n    GROUP BY\n        1, 2, 3\n)\n-- Final Query: Selects the result ranked 1 (the most frequent event hash) for each contract/month.\nSELECT\n    COUNT(DISTINCT address) AS unique_erc20_contracts_exceeding_1k,\n    ARRAY_AGG(\n        STRUCT(t1.address, t1.transaction_month, t1.topic AS most_frequent_signature_hash) \n        ORDER BY t1.address, t1.transaction_month\n    ) AS details_by_contract_and_month\nFROM FrequentTopics AS t1\nWHERE t1.topic_rank = 1","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anonb60b39bae3e304aed1441e913e041212066591abcd3d7f2dc878f8967ff9b9f4"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r5cd2f3de8b4b895c_0000019a5deb5037_1","location":"US"},"statistics":{"creationTime":"1762512294177","startTime":"1762512294291","endTime":"1762512295371","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT","searchStatistics":{"indexUsageMode":"UNUSED","indexUnusedReasons":[{"code":"QUERY_CACHE_HIT","message":"Search indexes are not used because the query was cached."}]}}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ jq -r .jobReference.jobId
+ job_id=bqjob_r5cd2f3de8b4b895c_0000019a5deb5037_1
+ '[' -n bqjob_r5cd2f3de8b4b895c_0000019a5deb5037_1 ']'
+ echo '  [SUCCESS] Query submitted.'
  [SUCCESS] Query submitted.
+ echo '  *** JOB ID FOR ERC20 Unoptimized: bqjob_r5cd2f3de8b4b895c_0000019a5deb5037_1 ***'
  *** JOB ID FOR ERC20 Unoptimized: bqjob_r5cd2f3de8b4b895c_0000019a5deb5037_1 ***
+ echo '  Waiting for job to complete...'
  Waiting for job to complete...
++ bq wait bqjob_r5cd2f3de8b4b895c_0000019a5deb5037_1
+ wait_output='Waiting on bqjob_r5cd2f3de8b4b895c_0000019a5deb5037_1 ... (0s) Current status: DONE   
Job tony-allen:bqjob_r5cd2f3de8b4b895c_0000019a5deb5037_1

  Job Type    State      Start Time         Duration                User Email              Bytes Processed   Bytes Billed   Billing Tier   Labels  
 ---------- --------- ----------------- ---------------- --------------------------------- ----------------- -------------- -------------- -------- 
  query      SUCCESS   07 Nov 10:44:54   0:00:01.080000   admin@bentrollope.altostrat.com   0                 0                                     '
+ '[' 0 -ne 0 ']'
+ echo '  Job completed. Fetching statistics...'
  Job completed. Fetching statistics...
++ bq show --format=json -j bqjob_r5cd2f3de8b4b895c_0000019a5deb5037_1
+ job_stats_json='{"kind":"bigquery#job","etag":"m0WaMYYU88r+0/T8hUKnFg==","id":"tony-allen:US.bqjob_r5cd2f3de8b4b895c_0000019a5deb5037_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r5cd2f3de8b4b895c_0000019a5deb5037_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"WITH ERC20_Contracts AS (\n    -- CTE 1: Filters the small '\''contracts'\'' dimension table once to identify ERC20s.\n    SELECT address \n    FROM `bigquery-public-data.crypto_ethereum_classic.contracts` \n    WHERE is_erc20 = TRUE\n),\nMonthlyLogCounts AS (\n    -- CTE 2: Filters early and aggregates the massive '\''logs'\'' table to find high-activity contracts (> 1,000 logs/month).\n    SELECT\n        t1.address,\n        FORMAT_DATE('\''%Y-%m'\'', t1.block_timestamp) AS transaction_month, \n        COUNT(t1.log_index) AS log_event_count \n    FROM\n        `bigquery-public-data.crypto_ethereum_classic.logs` AS t1\n    INNER JOIN\n        ERC20_Contracts AS t2 ON t1.address = t2.address\n    GROUP BY\n        1, 2\n    HAVING\n        log_event_count > 1000\n),\nFrequentTopics AS (\n    -- CTE 3: Joins the already filtered, small result from CTE 2 back to the '\''logs'\'' table\n    -- only for the relevant contracts/months to find the topic frequency (event signature).\n    SELECT\n        t1.address,\n        t1.transaction_month,\n        topic,\n        -- Applies a rank over the small, relevant subset of data.\n        ROW_NUMBER() OVER (PARTITION BY t1.address, t1.transaction_month ORDER BY COUNT(topic) DESC) AS topic_rank\n    FROM\n        MonthlyLogCounts AS t1\n    INNER JOIN\n        `bigquery-public-data.crypto_ethereum_classic.logs` AS t2 \n        ON t1.address = t2.address AND FORMAT_DATE('\''%Y-%m'\'', t2.block_timestamp) = t1.transaction_month\n    CROSS JOIN\n        UNNEST(t2.topics) AS topic WITH OFFSET AS topic_index\n    WHERE\n        topic_index = 0 -- Isolates the event signature hash (topics[0])\n    GROUP BY\n        1, 2, 3\n)\n-- Final Query: Selects the result ranked 1 (the most frequent event hash) for each contract/month.\nSELECT\n    COUNT(DISTINCT address) AS unique_erc20_contracts_exceeding_1k,\n    ARRAY_AGG(\n        STRUCT(t1.address, t1.transaction_month, t1.topic AS most_frequent_signature_hash) \n        ORDER BY t1.address, t1.transaction_month\n    ) AS details_by_contract_and_month\nFROM FrequentTopics AS t1\nWHERE t1.topic_rank = 1","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anonb60b39bae3e304aed1441e913e041212066591abcd3d7f2dc878f8967ff9b9f4"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r5cd2f3de8b4b895c_0000019a5deb5037_1","location":"US"},"statistics":{"creationTime":"1762512294177","startTime":"1762512294291","endTime":"1762512295371","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT","searchStatistics":{"indexUsageMode":"UNUSED","indexUnusedReasons":[{"code":"QUERY_CACHE_HIT","message":"Search indexes are not used because the query was cached."}]}}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ echo '{"kind":"bigquery#job","etag":"m0WaMYYU88r+0/T8hUKnFg==","id":"tony-allen:US.bqjob_r5cd2f3de8b4b895c_0000019a5deb5037_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r5cd2f3de8b4b895c_0000019a5deb5037_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"WITH ERC20_Contracts AS (\n    -- CTE 1: Filters the small '\''contracts'\'' dimension table once to identify ERC20s.\n    SELECT address \n    FROM `bigquery-public-data.crypto_ethereum_classic.contracts` \n    WHERE is_erc20 = TRUE\n),\nMonthlyLogCounts AS (\n    -- CTE 2: Filters early and aggregates the massive '\''logs'\'' table to find high-activity contracts (> 1,000 logs/month).\n    SELECT\n        t1.address,\n        FORMAT_DATE('\''%Y-%m'\'', t1.block_timestamp) AS transaction_month, \n        COUNT(t1.log_index) AS log_event_count \n    FROM\n        `bigquery-public-data.crypto_ethereum_classic.logs` AS t1\n    INNER JOIN\n        ERC20_Contracts AS t2 ON t1.address = t2.address\n    GROUP BY\n        1, 2\n    HAVING\n        log_event_count > 1000\n),\nFrequentTopics AS (\n    -- CTE 3: Joins the already filtered, small result from CTE 2 back to the '\''logs'\'' table\n    -- only for the relevant contracts/months to find the topic frequency (event signature).\n    SELECT\n        t1.address,\n        t1.transaction_month,\n        topic,\n        -- Applies a rank over the small, relevant subset of data.\n        ROW_NUMBER() OVER (PARTITION BY t1.address, t1.transaction_month ORDER BY COUNT(topic) DESC) AS topic_rank\n    FROM\n        MonthlyLogCounts AS t1\n    INNER JOIN\n        `bigquery-public-data.crypto_ethereum_classic.logs` AS t2 \n        ON t1.address = t2.address AND FORMAT_DATE('\''%Y-%m'\'', t2.block_timestamp) = t1.transaction_month\n    CROSS JOIN\n        UNNEST(t2.topics) AS topic WITH OFFSET AS topic_index\n    WHERE\n        topic_index = 0 -- Isolates the event signature hash (topics[0])\n    GROUP BY\n        1, 2, 3\n)\n-- Final Query: Selects the result ranked 1 (the most frequent event hash) for each contract/month.\nSELECT\n    COUNT(DISTINCT address) AS unique_erc20_contracts_exceeding_1k,\n    ARRAY_AGG(\n        STRUCT(t1.address, t1.transaction_month, t1.topic AS most_frequent_signature_hash) \n        ORDER BY t1.address, t1.transaction_month\n    ) AS details_by_contract_and_month\nFROM FrequentTopics AS t1\nWHERE t1.topic_rank = 1","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anonb60b39bae3e304aed1441e913e041212066591abcd3d7f2dc878f8967ff9b9f4"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r5cd2f3de8b4b895c_0000019a5deb5037_1","location":"US"},"statistics":{"creationTime":"1762512294177","startTime":"1762512294291","endTime":"1762512295371","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT","searchStatistics":{"indexUsageMode":"UNUSED","indexUnusedReasons":[{"code":"QUERY_CACHE_HIT","message":"Search indexes are not used because the query was cached."}]}}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ jq -r .statistics.totalBytesProcessed
+ total_bytes_processed=0
++ echo '{"kind":"bigquery#job","etag":"m0WaMYYU88r+0/T8hUKnFg==","id":"tony-allen:US.bqjob_r5cd2f3de8b4b895c_0000019a5deb5037_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r5cd2f3de8b4b895c_0000019a5deb5037_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"WITH ERC20_Contracts AS (\n    -- CTE 1: Filters the small '\''contracts'\'' dimension table once to identify ERC20s.\n    SELECT address \n    FROM `bigquery-public-data.crypto_ethereum_classic.contracts` \n    WHERE is_erc20 = TRUE\n),\nMonthlyLogCounts AS (\n    -- CTE 2: Filters early and aggregates the massive '\''logs'\'' table to find high-activity contracts (> 1,000 logs/month).\n    SELECT\n        t1.address,\n        FORMAT_DATE('\''%Y-%m'\'', t1.block_timestamp) AS transaction_month, \n        COUNT(t1.log_index) AS log_event_count \n    FROM\n        `bigquery-public-data.crypto_ethereum_classic.logs` AS t1\n    INNER JOIN\n        ERC20_Contracts AS t2 ON t1.address = t2.address\n    GROUP BY\n        1, 2\n    HAVING\n        log_event_count > 1000\n),\nFrequentTopics AS (\n    -- CTE 3: Joins the already filtered, small result from CTE 2 back to the '\''logs'\'' table\n    -- only for the relevant contracts/months to find the topic frequency (event signature).\n    SELECT\n        t1.address,\n        t1.transaction_month,\n        topic,\n        -- Applies a rank over the small, relevant subset of data.\n        ROW_NUMBER() OVER (PARTITION BY t1.address, t1.transaction_month ORDER BY COUNT(topic) DESC) AS topic_rank\n    FROM\n        MonthlyLogCounts AS t1\n    INNER JOIN\n        `bigquery-public-data.crypto_ethereum_classic.logs` AS t2 \n        ON t1.address = t2.address AND FORMAT_DATE('\''%Y-%m'\'', t2.block_timestamp) = t1.transaction_month\n    CROSS JOIN\n        UNNEST(t2.topics) AS topic WITH OFFSET AS topic_index\n    WHERE\n        topic_index = 0 -- Isolates the event signature hash (topics[0])\n    GROUP BY\n        1, 2, 3\n)\n-- Final Query: Selects the result ranked 1 (the most frequent event hash) for each contract/month.\nSELECT\n    COUNT(DISTINCT address) AS unique_erc20_contracts_exceeding_1k,\n    ARRAY_AGG(\n        STRUCT(t1.address, t1.transaction_month, t1.topic AS most_frequent_signature_hash) \n        ORDER BY t1.address, t1.transaction_month\n    ) AS details_by_contract_and_month\nFROM FrequentTopics AS t1\nWHERE t1.topic_rank = 1","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anonb60b39bae3e304aed1441e913e041212066591abcd3d7f2dc878f8967ff9b9f4"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r5cd2f3de8b4b895c_0000019a5deb5037_1","location":"US"},"statistics":{"creationTime":"1762512294177","startTime":"1762512294291","endTime":"1762512295371","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT","searchStatistics":{"indexUsageMode":"UNUSED","indexUnusedReasons":[{"code":"QUERY_CACHE_HIT","message":"Search indexes are not used because the query was cached."}]}}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ jq -r .statistics.totalSlotMs
+ total_slot_ms=null
++ echo '{"kind":"bigquery#job","etag":"m0WaMYYU88r+0/T8hUKnFg==","id":"tony-allen:US.bqjob_r5cd2f3de8b4b895c_0000019a5deb5037_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r5cd2f3de8b4b895c_0000019a5deb5037_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"WITH ERC20_Contracts AS (\n    -- CTE 1: Filters the small '\''contracts'\'' dimension table once to identify ERC20s.\n    SELECT address \n    FROM `bigquery-public-data.crypto_ethereum_classic.contracts` \n    WHERE is_erc20 = TRUE\n),\nMonthlyLogCounts AS (\n    -- CTE 2: Filters early and aggregates the massive '\''logs'\'' table to find high-activity contracts (> 1,000 logs/month).\n    SELECT\n        t1.address,\n        FORMAT_DATE('\''%Y-%m'\'', t1.block_timestamp) AS transaction_month, \n        COUNT(t1.log_index) AS log_event_count \n    FROM\n        `bigquery-public-data.crypto_ethereum_classic.logs` AS t1\n    INNER JOIN\n        ERC20_Contracts AS t2 ON t1.address = t2.address\n    GROUP BY\n        1, 2\n    HAVING\n        log_event_count > 1000\n),\nFrequentTopics AS (\n    -- CTE 3: Joins the already filtered, small result from CTE 2 back to the '\''logs'\'' table\n    -- only for the relevant contracts/months to find the topic frequency (event signature).\n    SELECT\n        t1.address,\n        t1.transaction_month,\n        topic,\n        -- Applies a rank over the small, relevant subset of data.\n        ROW_NUMBER() OVER (PARTITION BY t1.address, t1.transaction_month ORDER BY COUNT(topic) DESC) AS topic_rank\n    FROM\n        MonthlyLogCounts AS t1\n    INNER JOIN\n        `bigquery-public-data.crypto_ethereum_classic.logs` AS t2 \n        ON t1.address = t2.address AND FORMAT_DATE('\''%Y-%m'\'', t2.block_timestamp) = t1.transaction_month\n    CROSS JOIN\n        UNNEST(t2.topics) AS topic WITH OFFSET AS topic_index\n    WHERE\n        topic_index = 0 -- Isolates the event signature hash (topics[0])\n    GROUP BY\n        1, 2, 3\n)\n-- Final Query: Selects the result ranked 1 (the most frequent event hash) for each contract/month.\nSELECT\n    COUNT(DISTINCT address) AS unique_erc20_contracts_exceeding_1k,\n    ARRAY_AGG(\n        STRUCT(t1.address, t1.transaction_month, t1.topic AS most_frequent_signature_hash) \n        ORDER BY t1.address, t1.transaction_month\n    ) AS details_by_contract_and_month\nFROM FrequentTopics AS t1\nWHERE t1.topic_rank = 1","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anonb60b39bae3e304aed1441e913e041212066591abcd3d7f2dc878f8967ff9b9f4"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r5cd2f3de8b4b895c_0000019a5deb5037_1","location":"US"},"statistics":{"creationTime":"1762512294177","startTime":"1762512294291","endTime":"1762512295371","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT","searchStatistics":{"indexUsageMode":"UNUSED","indexUnusedReasons":[{"code":"QUERY_CACHE_HIT","message":"Search indexes are not used because the query was cached."}]}}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ jq -r .statistics.startTime
+ start_time=1762512294291
++ echo '{"kind":"bigquery#job","etag":"m0WaMYYU88r+0/T8hUKnFg==","id":"tony-allen:US.bqjob_r5cd2f3de8b4b895c_0000019a5deb5037_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r5cd2f3de8b4b895c_0000019a5deb5037_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"WITH ERC20_Contracts AS (\n    -- CTE 1: Filters the small '\''contracts'\'' dimension table once to identify ERC20s.\n    SELECT address \n    FROM `bigquery-public-data.crypto_ethereum_classic.contracts` \n    WHERE is_erc20 = TRUE\n),\nMonthlyLogCounts AS (\n    -- CTE 2: Filters early and aggregates the massive '\''logs'\'' table to find high-activity contracts (> 1,000 logs/month).\n    SELECT\n        t1.address,\n        FORMAT_DATE('\''%Y-%m'\'', t1.block_timestamp) AS transaction_month, \n        COUNT(t1.log_index) AS log_event_count \n    FROM\n        `bigquery-public-data.crypto_ethereum_classic.logs` AS t1\n    INNER JOIN\n        ERC20_Contracts AS t2 ON t1.address = t2.address\n    GROUP BY\n        1, 2\n    HAVING\n        log_event_count > 1000\n),\nFrequentTopics AS (\n    -- CTE 3: Joins the already filtered, small result from CTE 2 back to the '\''logs'\'' table\n    -- only for the relevant contracts/months to find the topic frequency (event signature).\n    SELECT\n        t1.address,\n        t1.transaction_month,\n        topic,\n        -- Applies a rank over the small, relevant subset of data.\n        ROW_NUMBER() OVER (PARTITION BY t1.address, t1.transaction_month ORDER BY COUNT(topic) DESC) AS topic_rank\n    FROM\n        MonthlyLogCounts AS t1\n    INNER JOIN\n        `bigquery-public-data.crypto_ethereum_classic.logs` AS t2 \n        ON t1.address = t2.address AND FORMAT_DATE('\''%Y-%m'\'', t2.block_timestamp) = t1.transaction_month\n    CROSS JOIN\n        UNNEST(t2.topics) AS topic WITH OFFSET AS topic_index\n    WHERE\n        topic_index = 0 -- Isolates the event signature hash (topics[0])\n    GROUP BY\n        1, 2, 3\n)\n-- Final Query: Selects the result ranked 1 (the most frequent event hash) for each contract/month.\nSELECT\n    COUNT(DISTINCT address) AS unique_erc20_contracts_exceeding_1k,\n    ARRAY_AGG(\n        STRUCT(t1.address, t1.transaction_month, t1.topic AS most_frequent_signature_hash) \n        ORDER BY t1.address, t1.transaction_month\n    ) AS details_by_contract_and_month\nFROM FrequentTopics AS t1\nWHERE t1.topic_rank = 1","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anonb60b39bae3e304aed1441e913e041212066591abcd3d7f2dc878f8967ff9b9f4"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r5cd2f3de8b4b895c_0000019a5deb5037_1","location":"US"},"statistics":{"creationTime":"1762512294177","startTime":"1762512294291","endTime":"1762512295371","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT","searchStatistics":{"indexUsageMode":"UNUSED","indexUnusedReasons":[{"code":"QUERY_CACHE_HIT","message":"Search indexes are not used because the query was cached."}]}}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ jq -r .statistics.endTime
+ end_time=1762512295371
++ echo 1762512294291
++ awk '{print int($1)}'
+ start_ms=1762512294291
++ echo 1762512295371
++ awk '{print int($1)}'
+ end_ms=1762512295371
+ duration_ms=1080
+ echo '  --- Execution Statistics ---'
  --- Execution Statistics ---
+ echo '  Duration: 1080 ms'
  Duration: 1080 ms
+ echo '  Bytes Processed: 0 bytes'
  Bytes Processed: 0 bytes
+ echo '  Slot Milliseconds: null'
  Slot Milliseconds: null
+ echo '  ----------------------------'
  ----------------------------
+ echo -e 'ERC20 Unoptimized\tbqjob_r5cd2f3de8b4b895c_0000019a5deb5037_1\t1080\t0\tnull'
+ echo ''

+ run_query 'ERC20 Optimized' 'WITH ERC20_Contracts AS (
    SELECT address FROM `bigquery-public-data.crypto_ethereum_classic.contracts` WHERE is_erc20 = TRUE
),
MonthlyLogCounts AS (
    SELECT
        t1.address,
        FORMAT_DATE('\''%Y-%m'\'', t1.block_timestamp) AS transaction_month, 
        COUNT(t1.log_index) AS log_event_count 
    FROM
        `bigquery-public-data.crypto_ethereum_classic.logs` AS t1
    INNER JOIN
        ERC20_Contracts AS t2 ON t1.address = t2.address
    GROUP BY
        1, 2
    HAVING
        log_event_count > 1000
),
FrequentTopics AS (
    SELECT
        t1.address,
        t1.transaction_month,
        topic,
        ROW_NUMBER() OVER (PARTITION BY t1.address, t1.transaction_month ORDER BY COUNT(topic) DESC) AS topic_rank
    FROM
        MonthlyLogCounts AS t1 -- Joins the already filtered and aggregated small list
    INNER JOIN
        `bigquery-public-data.crypto_ethereum_classic.logs` AS t2 
        ON t1.address = t2.address AND FORMAT_DATE('\''%Y-%m'\'', t2.block_timestamp) = t1.transaction_month
    CROSS JOIN
        UNNEST(t2.topics) AS topic WITH OFFSET AS topic_index
    WHERE
        topic_index = 0
    GROUP BY
        1, 2, 3
)
SELECT
    COUNT(DISTINCT address) AS unique_erc20_contracts_exceeding_1k,
    ARRAY_AGG(
        STRUCT(t1.address, t1.transaction_month, t1.topic AS most_frequent_signature_hash) 
        ORDER BY t1.address, t1.transaction_month
    ) AS details_by_contract_and_month
FROM FrequentTopics AS t1
WHERE t1.topic_rank = 1'
+ local 'query_name=ERC20 Optimized'
+ local 'query=WITH ERC20_Contracts AS (
    SELECT address FROM `bigquery-public-data.crypto_ethereum_classic.contracts` WHERE is_erc20 = TRUE
),
MonthlyLogCounts AS (
    SELECT
        t1.address,
        FORMAT_DATE('\''%Y-%m'\'', t1.block_timestamp) AS transaction_month, 
        COUNT(t1.log_index) AS log_event_count 
    FROM
        `bigquery-public-data.crypto_ethereum_classic.logs` AS t1
    INNER JOIN
        ERC20_Contracts AS t2 ON t1.address = t2.address
    GROUP BY
        1, 2
    HAVING
        log_event_count > 1000
),
FrequentTopics AS (
    SELECT
        t1.address,
        t1.transaction_month,
        topic,
        ROW_NUMBER() OVER (PARTITION BY t1.address, t1.transaction_month ORDER BY COUNT(topic) DESC) AS topic_rank
    FROM
        MonthlyLogCounts AS t1 -- Joins the already filtered and aggregated small list
    INNER JOIN
        `bigquery-public-data.crypto_ethereum_classic.logs` AS t2 
        ON t1.address = t2.address AND FORMAT_DATE('\''%Y-%m'\'', t2.block_timestamp) = t1.transaction_month
    CROSS JOIN
        UNNEST(t2.topics) AS topic WITH OFFSET AS topic_index
    WHERE
        topic_index = 0
    GROUP BY
        1, 2, 3
)
SELECT
    COUNT(DISTINCT address) AS unique_erc20_contracts_exceeding_1k,
    ARRAY_AGG(
        STRUCT(t1.address, t1.transaction_month, t1.topic AS most_frequent_signature_hash) 
        ORDER BY t1.address, t1.transaction_month
    ) AS details_by_contract_and_month
FROM FrequentTopics AS t1
WHERE t1.topic_rank = 1'
+ echo ==================================================
==================================================
+ echo 'Executing ERC20 Optimized'
Executing ERC20 Optimized
+ echo ==================================================
==================================================
+ echo Query:
Query:
+ echo 'WITH ERC20_Contracts AS (
    SELECT address FROM `bigquery-public-data.crypto_ethereum_classic.contracts` WHERE is_erc20 = TRUE
),
MonthlyLogCounts AS (
    SELECT
        t1.address,
        FORMAT_DATE('\''%Y-%m'\'', t1.block_timestamp) AS transaction_month, 
        COUNT(t1.log_index) AS log_event_count 
    FROM
        `bigquery-public-data.crypto_ethereum_classic.logs` AS t1
    INNER JOIN
        ERC20_Contracts AS t2 ON t1.address = t2.address
    GROUP BY
        1, 2
    HAVING
        log_event_count > 1000
),
FrequentTopics AS (
    SELECT
        t1.address,
        t1.transaction_month,
        topic,
        ROW_NUMBER() OVER (PARTITION BY t1.address, t1.transaction_month ORDER BY COUNT(topic) DESC) AS topic_rank
    FROM
        MonthlyLogCounts AS t1 -- Joins the already filtered and aggregated small list
    INNER JOIN
        `bigquery-public-data.crypto_ethereum_classic.logs` AS t2 
        ON t1.address = t2.address AND FORMAT_DATE('\''%Y-%m'\'', t2.block_timestamp) = t1.transaction_month
    CROSS JOIN
        UNNEST(t2.topics) AS topic WITH OFFSET AS topic_index
    WHERE
        topic_index = 0
    GROUP BY
        1, 2, 3
)
SELECT
    COUNT(DISTINCT address) AS unique_erc20_contracts_exceeding_1k,
    ARRAY_AGG(
        STRUCT(t1.address, t1.transaction_month, t1.topic AS most_frequent_signature_hash) 
        ORDER BY t1.address, t1.transaction_month
    ) AS details_by_contract_and_month
FROM FrequentTopics AS t1
WHERE t1.topic_rank = 1'
WITH ERC20_Contracts AS (
    SELECT address FROM `bigquery-public-data.crypto_ethereum_classic.contracts` WHERE is_erc20 = TRUE
),
MonthlyLogCounts AS (
    SELECT
        t1.address,
        FORMAT_DATE('%Y-%m', t1.block_timestamp) AS transaction_month, 
        COUNT(t1.log_index) AS log_event_count 
    FROM
        `bigquery-public-data.crypto_ethereum_classic.logs` AS t1
    INNER JOIN
        ERC20_Contracts AS t2 ON t1.address = t2.address
    GROUP BY
        1, 2
    HAVING
        log_event_count > 1000
),
FrequentTopics AS (
    SELECT
        t1.address,
        t1.transaction_month,
        topic,
        ROW_NUMBER() OVER (PARTITION BY t1.address, t1.transaction_month ORDER BY COUNT(topic) DESC) AS topic_rank
    FROM
        MonthlyLogCounts AS t1 -- Joins the already filtered and aggregated small list
    INNER JOIN
        `bigquery-public-data.crypto_ethereum_classic.logs` AS t2 
        ON t1.address = t2.address AND FORMAT_DATE('%Y-%m', t2.block_timestamp) = t1.transaction_month
    CROSS JOIN
        UNNEST(t2.topics) AS topic WITH OFFSET AS topic_index
    WHERE
        topic_index = 0
    GROUP BY
        1, 2, 3
)
SELECT
    COUNT(DISTINCT address) AS unique_erc20_contracts_exceeding_1k,
    ARRAY_AGG(
        STRUCT(t1.address, t1.transaction_month, t1.topic AS most_frequent_signature_hash) 
        ORDER BY t1.address, t1.transaction_month
    ) AS details_by_contract_and_month
FROM FrequentTopics AS t1
WHERE t1.topic_rank = 1
+ echo --------------------------------------------------
--------------------------------------------------
++ bq query --nosync --use_legacy_sql=false --format=json --location=US 'WITH ERC20_Contracts AS (
    SELECT address FROM `bigquery-public-data.crypto_ethereum_classic.contracts` WHERE is_erc20 = TRUE
),
MonthlyLogCounts AS (
    SELECT
        t1.address,
        FORMAT_DATE('\''%Y-%m'\'', t1.block_timestamp) AS transaction_month, 
        COUNT(t1.log_index) AS log_event_count 
    FROM
        `bigquery-public-data.crypto_ethereum_classic.logs` AS t1
    INNER JOIN
        ERC20_Contracts AS t2 ON t1.address = t2.address
    GROUP BY
        1, 2
    HAVING
        log_event_count > 1000
),
FrequentTopics AS (
    SELECT
        t1.address,
        t1.transaction_month,
        topic,
        ROW_NUMBER() OVER (PARTITION BY t1.address, t1.transaction_month ORDER BY COUNT(topic) DESC) AS topic_rank
    FROM
        MonthlyLogCounts AS t1 -- Joins the already filtered and aggregated small list
    INNER JOIN
        `bigquery-public-data.crypto_ethereum_classic.logs` AS t2 
        ON t1.address = t2.address AND FORMAT_DATE('\''%Y-%m'\'', t2.block_timestamp) = t1.transaction_month
    CROSS JOIN
        UNNEST(t2.topics) AS topic WITH OFFSET AS topic_index
    WHERE
        topic_index = 0
    GROUP BY
        1, 2, 3
)
SELECT
    COUNT(DISTINCT address) AS unique_erc20_contracts_exceeding_1k,
    ARRAY_AGG(
        STRUCT(t1.address, t1.transaction_month, t1.topic AS most_frequent_signature_hash) 
        ORDER BY t1.address, t1.transaction_month
    ) AS details_by_contract_and_month
FROM FrequentTopics AS t1
WHERE t1.topic_rank = 1'
+ job_submission_output='{"kind":"bigquery#job","etag":"gMNPdajKNqT7vj95Z7mtvg==","id":"tony-allen:US.bqjob_r47485fcb244f2009_0000019a5deb6faa_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r47485fcb244f2009_0000019a5deb6faa_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"WITH ERC20_Contracts AS (\n    SELECT address FROM `bigquery-public-data.crypto_ethereum_classic.contracts` WHERE is_erc20 = TRUE\n),\nMonthlyLogCounts AS (\n    SELECT\n        t1.address,\n        FORMAT_DATE('\''%Y-%m'\'', t1.block_timestamp) AS transaction_month, \n        COUNT(t1.log_index) AS log_event_count \n    FROM\n        `bigquery-public-data.crypto_ethereum_classic.logs` AS t1\n    INNER JOIN\n        ERC20_Contracts AS t2 ON t1.address = t2.address\n    GROUP BY\n        1, 2\n    HAVING\n        log_event_count > 1000\n),\nFrequentTopics AS (\n    SELECT\n        t1.address,\n        t1.transaction_month,\n        topic,\n        ROW_NUMBER() OVER (PARTITION BY t1.address, t1.transaction_month ORDER BY COUNT(topic) DESC) AS topic_rank\n    FROM\n        MonthlyLogCounts AS t1 -- Joins the already filtered and aggregated small list\n    INNER JOIN\n        `bigquery-public-data.crypto_ethereum_classic.logs` AS t2 \n        ON t1.address = t2.address AND FORMAT_DATE('\''%Y-%m'\'', t2.block_timestamp) = t1.transaction_month\n    CROSS JOIN\n        UNNEST(t2.topics) AS topic WITH OFFSET AS topic_index\n    WHERE\n        topic_index = 0\n    GROUP BY\n        1, 2, 3\n)\nSELECT\n    COUNT(DISTINCT address) AS unique_erc20_contracts_exceeding_1k,\n    ARRAY_AGG(\n        STRUCT(t1.address, t1.transaction_month, t1.topic AS most_frequent_signature_hash) \n        ORDER BY t1.address, t1.transaction_month\n    ) AS details_by_contract_and_month\nFROM FrequentTopics AS t1\nWHERE t1.topic_rank = 1","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anone76d01e49460da1c67d9782b01a0d32869341ea29848ed654a0b2bddce4171b9"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r47485fcb244f2009_0000019a5deb6faa_1","location":"US"},"statistics":{"creationTime":"1762512302266","startTime":"1762512302412","endTime":"1762512304201","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT","searchStatistics":{"indexUsageMode":"UNUSED","indexUnusedReasons":[{"code":"QUERY_CACHE_HIT","message":"Search indexes are not used because the query was cached."}]}}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ echo '{"kind":"bigquery#job","etag":"gMNPdajKNqT7vj95Z7mtvg==","id":"tony-allen:US.bqjob_r47485fcb244f2009_0000019a5deb6faa_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r47485fcb244f2009_0000019a5deb6faa_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"WITH ERC20_Contracts AS (\n    SELECT address FROM `bigquery-public-data.crypto_ethereum_classic.contracts` WHERE is_erc20 = TRUE\n),\nMonthlyLogCounts AS (\n    SELECT\n        t1.address,\n        FORMAT_DATE('\''%Y-%m'\'', t1.block_timestamp) AS transaction_month, \n        COUNT(t1.log_index) AS log_event_count \n    FROM\n        `bigquery-public-data.crypto_ethereum_classic.logs` AS t1\n    INNER JOIN\n        ERC20_Contracts AS t2 ON t1.address = t2.address\n    GROUP BY\n        1, 2\n    HAVING\n        log_event_count > 1000\n),\nFrequentTopics AS (\n    SELECT\n        t1.address,\n        t1.transaction_month,\n        topic,\n        ROW_NUMBER() OVER (PARTITION BY t1.address, t1.transaction_month ORDER BY COUNT(topic) DESC) AS topic_rank\n    FROM\n        MonthlyLogCounts AS t1 -- Joins the already filtered and aggregated small list\n    INNER JOIN\n        `bigquery-public-data.crypto_ethereum_classic.logs` AS t2 \n        ON t1.address = t2.address AND FORMAT_DATE('\''%Y-%m'\'', t2.block_timestamp) = t1.transaction_month\n    CROSS JOIN\n        UNNEST(t2.topics) AS topic WITH OFFSET AS topic_index\n    WHERE\n        topic_index = 0\n    GROUP BY\n        1, 2, 3\n)\nSELECT\n    COUNT(DISTINCT address) AS unique_erc20_contracts_exceeding_1k,\n    ARRAY_AGG(\n        STRUCT(t1.address, t1.transaction_month, t1.topic AS most_frequent_signature_hash) \n        ORDER BY t1.address, t1.transaction_month\n    ) AS details_by_contract_and_month\nFROM FrequentTopics AS t1\nWHERE t1.topic_rank = 1","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anone76d01e49460da1c67d9782b01a0d32869341ea29848ed654a0b2bddce4171b9"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r47485fcb244f2009_0000019a5deb6faa_1","location":"US"},"statistics":{"creationTime":"1762512302266","startTime":"1762512302412","endTime":"1762512304201","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT","searchStatistics":{"indexUsageMode":"UNUSED","indexUnusedReasons":[{"code":"QUERY_CACHE_HIT","message":"Search indexes are not used because the query was cached."}]}}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ jq -r .jobReference.jobId
+ job_id=bqjob_r47485fcb244f2009_0000019a5deb6faa_1
+ '[' -n bqjob_r47485fcb244f2009_0000019a5deb6faa_1 ']'
+ echo '  [SUCCESS] Query submitted.'
  [SUCCESS] Query submitted.
+ echo '  *** JOB ID FOR ERC20 Optimized: bqjob_r47485fcb244f2009_0000019a5deb6faa_1 ***'
  *** JOB ID FOR ERC20 Optimized: bqjob_r47485fcb244f2009_0000019a5deb6faa_1 ***
+ echo '  Waiting for job to complete...'
  Waiting for job to complete...
++ bq wait bqjob_r47485fcb244f2009_0000019a5deb6faa_1
+ wait_output='Waiting on bqjob_r47485fcb244f2009_0000019a5deb6faa_1 ... (0s) Current status: DONE   
Job tony-allen:bqjob_r47485fcb244f2009_0000019a5deb6faa_1

  Job Type    State      Start Time         Duration                User Email              Bytes Processed   Bytes Billed   Billing Tier   Labels  
 ---------- --------- ----------------- ---------------- --------------------------------- ----------------- -------------- -------------- -------- 
  query      SUCCESS   07 Nov 10:45:02   0:00:01.789000   admin@bentrollope.altostrat.com   0                 0                                     '
+ '[' 0 -ne 0 ']'
+ echo '  Job completed. Fetching statistics...'
  Job completed. Fetching statistics...
++ bq show --format=json -j bqjob_r47485fcb244f2009_0000019a5deb6faa_1
+ job_stats_json='{"kind":"bigquery#job","etag":"gMNPdajKNqT7vj95Z7mtvg==","id":"tony-allen:US.bqjob_r47485fcb244f2009_0000019a5deb6faa_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r47485fcb244f2009_0000019a5deb6faa_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"WITH ERC20_Contracts AS (\n    SELECT address FROM `bigquery-public-data.crypto_ethereum_classic.contracts` WHERE is_erc20 = TRUE\n),\nMonthlyLogCounts AS (\n    SELECT\n        t1.address,\n        FORMAT_DATE('\''%Y-%m'\'', t1.block_timestamp) AS transaction_month, \n        COUNT(t1.log_index) AS log_event_count \n    FROM\n        `bigquery-public-data.crypto_ethereum_classic.logs` AS t1\n    INNER JOIN\n        ERC20_Contracts AS t2 ON t1.address = t2.address\n    GROUP BY\n        1, 2\n    HAVING\n        log_event_count > 1000\n),\nFrequentTopics AS (\n    SELECT\n        t1.address,\n        t1.transaction_month,\n        topic,\n        ROW_NUMBER() OVER (PARTITION BY t1.address, t1.transaction_month ORDER BY COUNT(topic) DESC) AS topic_rank\n    FROM\n        MonthlyLogCounts AS t1 -- Joins the already filtered and aggregated small list\n    INNER JOIN\n        `bigquery-public-data.crypto_ethereum_classic.logs` AS t2 \n        ON t1.address = t2.address AND FORMAT_DATE('\''%Y-%m'\'', t2.block_timestamp) = t1.transaction_month\n    CROSS JOIN\n        UNNEST(t2.topics) AS topic WITH OFFSET AS topic_index\n    WHERE\n        topic_index = 0\n    GROUP BY\n        1, 2, 3\n)\nSELECT\n    COUNT(DISTINCT address) AS unique_erc20_contracts_exceeding_1k,\n    ARRAY_AGG(\n        STRUCT(t1.address, t1.transaction_month, t1.topic AS most_frequent_signature_hash) \n        ORDER BY t1.address, t1.transaction_month\n    ) AS details_by_contract_and_month\nFROM FrequentTopics AS t1\nWHERE t1.topic_rank = 1","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anone76d01e49460da1c67d9782b01a0d32869341ea29848ed654a0b2bddce4171b9"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r47485fcb244f2009_0000019a5deb6faa_1","location":"US"},"statistics":{"creationTime":"1762512302266","startTime":"1762512302412","endTime":"1762512304201","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT","searchStatistics":{"indexUsageMode":"UNUSED","indexUnusedReasons":[{"code":"QUERY_CACHE_HIT","message":"Search indexes are not used because the query was cached."}]}}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ echo '{"kind":"bigquery#job","etag":"gMNPdajKNqT7vj95Z7mtvg==","id":"tony-allen:US.bqjob_r47485fcb244f2009_0000019a5deb6faa_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r47485fcb244f2009_0000019a5deb6faa_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"WITH ERC20_Contracts AS (\n    SELECT address FROM `bigquery-public-data.crypto_ethereum_classic.contracts` WHERE is_erc20 = TRUE\n),\nMonthlyLogCounts AS (\n    SELECT\n        t1.address,\n        FORMAT_DATE('\''%Y-%m'\'', t1.block_timestamp) AS transaction_month, \n        COUNT(t1.log_index) AS log_event_count \n    FROM\n        `bigquery-public-data.crypto_ethereum_classic.logs` AS t1\n    INNER JOIN\n        ERC20_Contracts AS t2 ON t1.address = t2.address\n    GROUP BY\n        1, 2\n    HAVING\n        log_event_count > 1000\n),\nFrequentTopics AS (\n    SELECT\n        t1.address,\n        t1.transaction_month,\n        topic,\n        ROW_NUMBER() OVER (PARTITION BY t1.address, t1.transaction_month ORDER BY COUNT(topic) DESC) AS topic_rank\n    FROM\n        MonthlyLogCounts AS t1 -- Joins the already filtered and aggregated small list\n    INNER JOIN\n        `bigquery-public-data.crypto_ethereum_classic.logs` AS t2 \n        ON t1.address = t2.address AND FORMAT_DATE('\''%Y-%m'\'', t2.block_timestamp) = t1.transaction_month\n    CROSS JOIN\n        UNNEST(t2.topics) AS topic WITH OFFSET AS topic_index\n    WHERE\n        topic_index = 0\n    GROUP BY\n        1, 2, 3\n)\nSELECT\n    COUNT(DISTINCT address) AS unique_erc20_contracts_exceeding_1k,\n    ARRAY_AGG(\n        STRUCT(t1.address, t1.transaction_month, t1.topic AS most_frequent_signature_hash) \n        ORDER BY t1.address, t1.transaction_month\n    ) AS details_by_contract_and_month\nFROM FrequentTopics AS t1\nWHERE t1.topic_rank = 1","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anone76d01e49460da1c67d9782b01a0d32869341ea29848ed654a0b2bddce4171b9"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r47485fcb244f2009_0000019a5deb6faa_1","location":"US"},"statistics":{"creationTime":"1762512302266","startTime":"1762512302412","endTime":"1762512304201","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT","searchStatistics":{"indexUsageMode":"UNUSED","indexUnusedReasons":[{"code":"QUERY_CACHE_HIT","message":"Search indexes are not used because the query was cached."}]}}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ jq -r .statistics.totalBytesProcessed
+ total_bytes_processed=0
++ echo '{"kind":"bigquery#job","etag":"gMNPdajKNqT7vj95Z7mtvg==","id":"tony-allen:US.bqjob_r47485fcb244f2009_0000019a5deb6faa_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r47485fcb244f2009_0000019a5deb6faa_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"WITH ERC20_Contracts AS (\n    SELECT address FROM `bigquery-public-data.crypto_ethereum_classic.contracts` WHERE is_erc20 = TRUE\n),\nMonthlyLogCounts AS (\n    SELECT\n        t1.address,\n        FORMAT_DATE('\''%Y-%m'\'', t1.block_timestamp) AS transaction_month, \n        COUNT(t1.log_index) AS log_event_count \n    FROM\n        `bigquery-public-data.crypto_ethereum_classic.logs` AS t1\n    INNER JOIN\n        ERC20_Contracts AS t2 ON t1.address = t2.address\n    GROUP BY\n        1, 2\n    HAVING\n        log_event_count > 1000\n),\nFrequentTopics AS (\n    SELECT\n        t1.address,\n        t1.transaction_month,\n        topic,\n        ROW_NUMBER() OVER (PARTITION BY t1.address, t1.transaction_month ORDER BY COUNT(topic) DESC) AS topic_rank\n    FROM\n        MonthlyLogCounts AS t1 -- Joins the already filtered and aggregated small list\n    INNER JOIN\n        `bigquery-public-data.crypto_ethereum_classic.logs` AS t2 \n        ON t1.address = t2.address AND FORMAT_DATE('\''%Y-%m'\'', t2.block_timestamp) = t1.transaction_month\n    CROSS JOIN\n        UNNEST(t2.topics) AS topic WITH OFFSET AS topic_index\n    WHERE\n        topic_index = 0\n    GROUP BY\n        1, 2, 3\n)\nSELECT\n    COUNT(DISTINCT address) AS unique_erc20_contracts_exceeding_1k,\n    ARRAY_AGG(\n        STRUCT(t1.address, t1.transaction_month, t1.topic AS most_frequent_signature_hash) \n        ORDER BY t1.address, t1.transaction_month\n    ) AS details_by_contract_and_month\nFROM FrequentTopics AS t1\nWHERE t1.topic_rank = 1","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anone76d01e49460da1c67d9782b01a0d32869341ea29848ed654a0b2bddce4171b9"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r47485fcb244f2009_0000019a5deb6faa_1","location":"US"},"statistics":{"creationTime":"1762512302266","startTime":"1762512302412","endTime":"1762512304201","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT","searchStatistics":{"indexUsageMode":"UNUSED","indexUnusedReasons":[{"code":"QUERY_CACHE_HIT","message":"Search indexes are not used because the query was cached."}]}}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ jq -r .statistics.totalSlotMs
+ total_slot_ms=null
++ echo '{"kind":"bigquery#job","etag":"gMNPdajKNqT7vj95Z7mtvg==","id":"tony-allen:US.bqjob_r47485fcb244f2009_0000019a5deb6faa_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r47485fcb244f2009_0000019a5deb6faa_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"WITH ERC20_Contracts AS (\n    SELECT address FROM `bigquery-public-data.crypto_ethereum_classic.contracts` WHERE is_erc20 = TRUE\n),\nMonthlyLogCounts AS (\n    SELECT\n        t1.address,\n        FORMAT_DATE('\''%Y-%m'\'', t1.block_timestamp) AS transaction_month, \n        COUNT(t1.log_index) AS log_event_count \n    FROM\n        `bigquery-public-data.crypto_ethereum_classic.logs` AS t1\n    INNER JOIN\n        ERC20_Contracts AS t2 ON t1.address = t2.address\n    GROUP BY\n        1, 2\n    HAVING\n        log_event_count > 1000\n),\nFrequentTopics AS (\n    SELECT\n        t1.address,\n        t1.transaction_month,\n        topic,\n        ROW_NUMBER() OVER (PARTITION BY t1.address, t1.transaction_month ORDER BY COUNT(topic) DESC) AS topic_rank\n    FROM\n        MonthlyLogCounts AS t1 -- Joins the already filtered and aggregated small list\n    INNER JOIN\n        `bigquery-public-data.crypto_ethereum_classic.logs` AS t2 \n        ON t1.address = t2.address AND FORMAT_DATE('\''%Y-%m'\'', t2.block_timestamp) = t1.transaction_month\n    CROSS JOIN\n        UNNEST(t2.topics) AS topic WITH OFFSET AS topic_index\n    WHERE\n        topic_index = 0\n    GROUP BY\n        1, 2, 3\n)\nSELECT\n    COUNT(DISTINCT address) AS unique_erc20_contracts_exceeding_1k,\n    ARRAY_AGG(\n        STRUCT(t1.address, t1.transaction_month, t1.topic AS most_frequent_signature_hash) \n        ORDER BY t1.address, t1.transaction_month\n    ) AS details_by_contract_and_month\nFROM FrequentTopics AS t1\nWHERE t1.topic_rank = 1","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anone76d01e49460da1c67d9782b01a0d32869341ea29848ed654a0b2bddce4171b9"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r47485fcb244f2009_0000019a5deb6faa_1","location":"US"},"statistics":{"creationTime":"1762512302266","startTime":"1762512302412","endTime":"1762512304201","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT","searchStatistics":{"indexUsageMode":"UNUSED","indexUnusedReasons":[{"code":"QUERY_CACHE_HIT","message":"Search indexes are not used because the query was cached."}]}}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ jq -r .statistics.startTime
+ start_time=1762512302412
++ echo '{"kind":"bigquery#job","etag":"gMNPdajKNqT7vj95Z7mtvg==","id":"tony-allen:US.bqjob_r47485fcb244f2009_0000019a5deb6faa_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r47485fcb244f2009_0000019a5deb6faa_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"WITH ERC20_Contracts AS (\n    SELECT address FROM `bigquery-public-data.crypto_ethereum_classic.contracts` WHERE is_erc20 = TRUE\n),\nMonthlyLogCounts AS (\n    SELECT\n        t1.address,\n        FORMAT_DATE('\''%Y-%m'\'', t1.block_timestamp) AS transaction_month, \n        COUNT(t1.log_index) AS log_event_count \n    FROM\n        `bigquery-public-data.crypto_ethereum_classic.logs` AS t1\n    INNER JOIN\n        ERC20_Contracts AS t2 ON t1.address = t2.address\n    GROUP BY\n        1, 2\n    HAVING\n        log_event_count > 1000\n),\nFrequentTopics AS (\n    SELECT\n        t1.address,\n        t1.transaction_month,\n        topic,\n        ROW_NUMBER() OVER (PARTITION BY t1.address, t1.transaction_month ORDER BY COUNT(topic) DESC) AS topic_rank\n    FROM\n        MonthlyLogCounts AS t1 -- Joins the already filtered and aggregated small list\n    INNER JOIN\n        `bigquery-public-data.crypto_ethereum_classic.logs` AS t2 \n        ON t1.address = t2.address AND FORMAT_DATE('\''%Y-%m'\'', t2.block_timestamp) = t1.transaction_month\n    CROSS JOIN\n        UNNEST(t2.topics) AS topic WITH OFFSET AS topic_index\n    WHERE\n        topic_index = 0\n    GROUP BY\n        1, 2, 3\n)\nSELECT\n    COUNT(DISTINCT address) AS unique_erc20_contracts_exceeding_1k,\n    ARRAY_AGG(\n        STRUCT(t1.address, t1.transaction_month, t1.topic AS most_frequent_signature_hash) \n        ORDER BY t1.address, t1.transaction_month\n    ) AS details_by_contract_and_month\nFROM FrequentTopics AS t1\nWHERE t1.topic_rank = 1","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anone76d01e49460da1c67d9782b01a0d32869341ea29848ed654a0b2bddce4171b9"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r47485fcb244f2009_0000019a5deb6faa_1","location":"US"},"statistics":{"creationTime":"1762512302266","startTime":"1762512302412","endTime":"1762512304201","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT","searchStatistics":{"indexUsageMode":"UNUSED","indexUnusedReasons":[{"code":"QUERY_CACHE_HIT","message":"Search indexes are not used because the query was cached."}]}}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ jq -r .statistics.endTime
+ end_time=1762512304201
++ echo 1762512302412
++ awk '{print int($1)}'
+ start_ms=1762512302412
++ echo 1762512304201
++ awk '{print int($1)}'
+ end_ms=1762512304201
+ duration_ms=1789
+ echo '  --- Execution Statistics ---'
  --- Execution Statistics ---
+ echo '  Duration: 1789 ms'
  Duration: 1789 ms
+ echo '  Bytes Processed: 0 bytes'
  Bytes Processed: 0 bytes
+ echo '  Slot Milliseconds: null'
  Slot Milliseconds: null
+ echo '  ----------------------------'
  ----------------------------
+ echo -e 'ERC20 Optimized\tbqjob_r47485fcb244f2009_0000019a5deb6faa_1\t1789\t0\tnull'
+ echo ''

+ echo '--- Running queries from peak_security_block_details_eval.sql ---'
--- Running queries from peak_security_block_details_eval.sql ---
+ run_query 'Peak Security Unoptimized' 'SELECT
    t1.miner,
    t1.gas_limit
FROM
    `bigquery-public-data.crypto_ethereum_classic.blocks` AS t1
WHERE
    t1.total_difficulty = (
        -- This forces a scan of the blocks table
        SELECT
            MAX(total_difficulty)
        FROM
            `bigquery-public-data.crypto_ethereum_classic.blocks`
    )
LIMIT 1'
+ local 'query_name=Peak Security Unoptimized'
+ local 'query=SELECT
    t1.miner,
    t1.gas_limit
FROM
    `bigquery-public-data.crypto_ethereum_classic.blocks` AS t1
WHERE
    t1.total_difficulty = (
        -- This forces a scan of the blocks table
        SELECT
            MAX(total_difficulty)
        FROM
            `bigquery-public-data.crypto_ethereum_classic.blocks`
    )
LIMIT 1'
+ echo ==================================================
==================================================
+ echo 'Executing Peak Security Unoptimized'
Executing Peak Security Unoptimized
+ echo ==================================================
==================================================
+ echo Query:
Query:
+ echo 'SELECT
    t1.miner,
    t1.gas_limit
FROM
    `bigquery-public-data.crypto_ethereum_classic.blocks` AS t1
WHERE
    t1.total_difficulty = (
        -- This forces a scan of the blocks table
        SELECT
            MAX(total_difficulty)
        FROM
            `bigquery-public-data.crypto_ethereum_classic.blocks`
    )
LIMIT 1'
SELECT
    t1.miner,
    t1.gas_limit
FROM
    `bigquery-public-data.crypto_ethereum_classic.blocks` AS t1
WHERE
    t1.total_difficulty = (
        -- This forces a scan of the blocks table
        SELECT
            MAX(total_difficulty)
        FROM
            `bigquery-public-data.crypto_ethereum_classic.blocks`
    )
LIMIT 1
+ echo --------------------------------------------------
--------------------------------------------------
++ bq query --nosync --use_legacy_sql=false --format=json --location=US 'SELECT
    t1.miner,
    t1.gas_limit
FROM
    `bigquery-public-data.crypto_ethereum_classic.blocks` AS t1
WHERE
    t1.total_difficulty = (
        -- This forces a scan of the blocks table
        SELECT
            MAX(total_difficulty)
        FROM
            `bigquery-public-data.crypto_ethereum_classic.blocks`
    )
LIMIT 1'
+ job_submission_output='{"kind":"bigquery#job","etag":"Q3PNzLB2N2/jGBbC0h5Lsw==","id":"tony-allen:US.bqjob_r1150a926ca1bc8c4_0000019a5deb92c1_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r1150a926ca1bc8c4_0000019a5deb92c1_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"SELECT\n    t1.miner,\n    t1.gas_limit\nFROM\n    `bigquery-public-data.crypto_ethereum_classic.blocks` AS t1\nWHERE\n    t1.total_difficulty = (\n        -- This forces a scan of the blocks table\n        SELECT\n            MAX(total_difficulty)\n        FROM\n            `bigquery-public-data.crypto_ethereum_classic.blocks`\n    )\nLIMIT 1","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anon4b785c37e878b40fc3c4c3fddc2e8a5ff9ba2c331594b01dec2eaf59deea7c77"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r1150a926ca1bc8c4_0000019a5deb92c1_1","location":"US"},"statistics":{"creationTime":"1762512311193","startTime":"1762512311295","endTime":"1762512312960","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT"}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ echo '{"kind":"bigquery#job","etag":"Q3PNzLB2N2/jGBbC0h5Lsw==","id":"tony-allen:US.bqjob_r1150a926ca1bc8c4_0000019a5deb92c1_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r1150a926ca1bc8c4_0000019a5deb92c1_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"SELECT\n    t1.miner,\n    t1.gas_limit\nFROM\n    `bigquery-public-data.crypto_ethereum_classic.blocks` AS t1\nWHERE\n    t1.total_difficulty = (\n        -- This forces a scan of the blocks table\n        SELECT\n            MAX(total_difficulty)\n        FROM\n            `bigquery-public-data.crypto_ethereum_classic.blocks`\n    )\nLIMIT 1","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anon4b785c37e878b40fc3c4c3fddc2e8a5ff9ba2c331594b01dec2eaf59deea7c77"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r1150a926ca1bc8c4_0000019a5deb92c1_1","location":"US"},"statistics":{"creationTime":"1762512311193","startTime":"1762512311295","endTime":"1762512312960","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT"}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ jq -r .jobReference.jobId
+ job_id=bqjob_r1150a926ca1bc8c4_0000019a5deb92c1_1
+ '[' -n bqjob_r1150a926ca1bc8c4_0000019a5deb92c1_1 ']'
+ echo '  [SUCCESS] Query submitted.'
  [SUCCESS] Query submitted.
+ echo '  *** JOB ID FOR Peak Security Unoptimized: bqjob_r1150a926ca1bc8c4_0000019a5deb92c1_1 ***'
  *** JOB ID FOR Peak Security Unoptimized: bqjob_r1150a926ca1bc8c4_0000019a5deb92c1_1 ***
+ echo '  Waiting for job to complete...'
  Waiting for job to complete...
++ bq wait bqjob_r1150a926ca1bc8c4_0000019a5deb92c1_1
+ wait_output='Waiting on bqjob_r1150a926ca1bc8c4_0000019a5deb92c1_1 ... (0s) Current status: DONE   
Job tony-allen:bqjob_r1150a926ca1bc8c4_0000019a5deb92c1_1

  Job Type    State      Start Time         Duration                User Email              Bytes Processed   Bytes Billed   Billing Tier   Labels  
 ---------- --------- ----------------- ---------------- --------------------------------- ----------------- -------------- -------------- -------- 
  query      SUCCESS   07 Nov 10:45:11   0:00:01.665000   admin@bentrollope.altostrat.com   0                 0                                     '
+ '[' 0 -ne 0 ']'
+ echo '  Job completed. Fetching statistics...'
  Job completed. Fetching statistics...
++ bq show --format=json -j bqjob_r1150a926ca1bc8c4_0000019a5deb92c1_1
+ job_stats_json='{"kind":"bigquery#job","etag":"Q3PNzLB2N2/jGBbC0h5Lsw==","id":"tony-allen:US.bqjob_r1150a926ca1bc8c4_0000019a5deb92c1_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r1150a926ca1bc8c4_0000019a5deb92c1_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"SELECT\n    t1.miner,\n    t1.gas_limit\nFROM\n    `bigquery-public-data.crypto_ethereum_classic.blocks` AS t1\nWHERE\n    t1.total_difficulty = (\n        -- This forces a scan of the blocks table\n        SELECT\n            MAX(total_difficulty)\n        FROM\n            `bigquery-public-data.crypto_ethereum_classic.blocks`\n    )\nLIMIT 1","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anon4b785c37e878b40fc3c4c3fddc2e8a5ff9ba2c331594b01dec2eaf59deea7c77"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r1150a926ca1bc8c4_0000019a5deb92c1_1","location":"US"},"statistics":{"creationTime":"1762512311193","startTime":"1762512311295","endTime":"1762512312960","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT"}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ echo '{"kind":"bigquery#job","etag":"Q3PNzLB2N2/jGBbC0h5Lsw==","id":"tony-allen:US.bqjob_r1150a926ca1bc8c4_0000019a5deb92c1_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r1150a926ca1bc8c4_0000019a5deb92c1_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"SELECT\n    t1.miner,\n    t1.gas_limit\nFROM\n    `bigquery-public-data.crypto_ethereum_classic.blocks` AS t1\nWHERE\n    t1.total_difficulty = (\n        -- This forces a scan of the blocks table\n        SELECT\n            MAX(total_difficulty)\n        FROM\n            `bigquery-public-data.crypto_ethereum_classic.blocks`\n    )\nLIMIT 1","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anon4b785c37e878b40fc3c4c3fddc2e8a5ff9ba2c331594b01dec2eaf59deea7c77"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r1150a926ca1bc8c4_0000019a5deb92c1_1","location":"US"},"statistics":{"creationTime":"1762512311193","startTime":"1762512311295","endTime":"1762512312960","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT"}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ jq -r .statistics.totalBytesProcessed
+ total_bytes_processed=0
++ echo '{"kind":"bigquery#job","etag":"Q3PNzLB2N2/jGBbC0h5Lsw==","id":"tony-allen:US.bqjob_r1150a926ca1bc8c4_0000019a5deb92c1_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r1150a926ca1bc8c4_0000019a5deb92c1_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"SELECT\n    t1.miner,\n    t1.gas_limit\nFROM\n    `bigquery-public-data.crypto_ethereum_classic.blocks` AS t1\nWHERE\n    t1.total_difficulty = (\n        -- This forces a scan of the blocks table\n        SELECT\n            MAX(total_difficulty)\n        FROM\n            `bigquery-public-data.crypto_ethereum_classic.blocks`\n    )\nLIMIT 1","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anon4b785c37e878b40fc3c4c3fddc2e8a5ff9ba2c331594b01dec2eaf59deea7c77"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r1150a926ca1bc8c4_0000019a5deb92c1_1","location":"US"},"statistics":{"creationTime":"1762512311193","startTime":"1762512311295","endTime":"1762512312960","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT"}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ jq -r .statistics.totalSlotMs
+ total_slot_ms=null
++ echo '{"kind":"bigquery#job","etag":"Q3PNzLB2N2/jGBbC0h5Lsw==","id":"tony-allen:US.bqjob_r1150a926ca1bc8c4_0000019a5deb92c1_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r1150a926ca1bc8c4_0000019a5deb92c1_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"SELECT\n    t1.miner,\n    t1.gas_limit\nFROM\n    `bigquery-public-data.crypto_ethereum_classic.blocks` AS t1\nWHERE\n    t1.total_difficulty = (\n        -- This forces a scan of the blocks table\n        SELECT\n            MAX(total_difficulty)\n        FROM\n            `bigquery-public-data.crypto_ethereum_classic.blocks`\n    )\nLIMIT 1","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anon4b785c37e878b40fc3c4c3fddc2e8a5ff9ba2c331594b01dec2eaf59deea7c77"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r1150a926ca1bc8c4_0000019a5deb92c1_1","location":"US"},"statistics":{"creationTime":"1762512311193","startTime":"1762512311295","endTime":"1762512312960","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT"}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ jq -r .statistics.startTime
+ start_time=1762512311295
++ jq -r .statistics.endTime
++ echo '{"kind":"bigquery#job","etag":"Q3PNzLB2N2/jGBbC0h5Lsw==","id":"tony-allen:US.bqjob_r1150a926ca1bc8c4_0000019a5deb92c1_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r1150a926ca1bc8c4_0000019a5deb92c1_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"SELECT\n    t1.miner,\n    t1.gas_limit\nFROM\n    `bigquery-public-data.crypto_ethereum_classic.blocks` AS t1\nWHERE\n    t1.total_difficulty = (\n        -- This forces a scan of the blocks table\n        SELECT\n            MAX(total_difficulty)\n        FROM\n            `bigquery-public-data.crypto_ethereum_classic.blocks`\n    )\nLIMIT 1","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anon4b785c37e878b40fc3c4c3fddc2e8a5ff9ba2c331594b01dec2eaf59deea7c77"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r1150a926ca1bc8c4_0000019a5deb92c1_1","location":"US"},"statistics":{"creationTime":"1762512311193","startTime":"1762512311295","endTime":"1762512312960","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT"}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
+ end_time=1762512312960
++ echo 1762512311295
++ awk '{print int($1)}'
+ start_ms=1762512311295
++ echo 1762512312960
++ awk '{print int($1)}'
+ end_ms=1762512312960
+ duration_ms=1665
+ echo '  --- Execution Statistics ---'
  --- Execution Statistics ---
+ echo '  Duration: 1665 ms'
  Duration: 1665 ms
+ echo '  Bytes Processed: 0 bytes'
  Bytes Processed: 0 bytes
+ echo '  Slot Milliseconds: null'
  Slot Milliseconds: null
+ echo '  ----------------------------'
  ----------------------------
+ echo -e 'Peak Security Unoptimized\tbqjob_r1150a926ca1bc8c4_0000019a5deb92c1_1\t1665\t0\tnull'
+ echo ''

+ run_query 'Peak Security Optimized' 'SELECT
    t1.miner,
    t1.gas_limit
FROM
    (
        SELECT
            miner,
            gas_limit,
            ROW_NUMBER() OVER (ORDER BY total_difficulty DESC) AS rank_by_difficulty
        FROM
            `bigquery-public-data.crypto_ethereum_classic.blocks`
    ) AS t1
WHERE
    t1.rank_by_difficulty = 1
LIMIT 1'
+ local 'query_name=Peak Security Optimized'
+ local 'query=SELECT
    t1.miner,
    t1.gas_limit
FROM
    (
        SELECT
            miner,
            gas_limit,
            ROW_NUMBER() OVER (ORDER BY total_difficulty DESC) AS rank_by_difficulty
        FROM
            `bigquery-public-data.crypto_ethereum_classic.blocks`
    ) AS t1
WHERE
    t1.rank_by_difficulty = 1
LIMIT 1'
+ echo ==================================================
==================================================
+ echo 'Executing Peak Security Optimized'
Executing Peak Security Optimized
+ echo ==================================================
==================================================
+ echo Query:
Query:
+ echo 'SELECT
    t1.miner,
    t1.gas_limit
FROM
    (
        SELECT
            miner,
            gas_limit,
            ROW_NUMBER() OVER (ORDER BY total_difficulty DESC) AS rank_by_difficulty
        FROM
            `bigquery-public-data.crypto_ethereum_classic.blocks`
    ) AS t1
WHERE
    t1.rank_by_difficulty = 1
LIMIT 1'
SELECT
    t1.miner,
    t1.gas_limit
FROM
    (
        SELECT
            miner,
            gas_limit,
            ROW_NUMBER() OVER (ORDER BY total_difficulty DESC) AS rank_by_difficulty
        FROM
            `bigquery-public-data.crypto_ethereum_classic.blocks`
    ) AS t1
WHERE
    t1.rank_by_difficulty = 1
LIMIT 1
+ echo --------------------------------------------------
--------------------------------------------------
++ bq query --nosync --use_legacy_sql=false --format=json --location=US 'SELECT
    t1.miner,
    t1.gas_limit
FROM
    (
        SELECT
            miner,
            gas_limit,
            ROW_NUMBER() OVER (ORDER BY total_difficulty DESC) AS rank_by_difficulty
        FROM
            `bigquery-public-data.crypto_ethereum_classic.blocks`
    ) AS t1
WHERE
    t1.rank_by_difficulty = 1
LIMIT 1'
+ job_submission_output='{"kind":"bigquery#job","etag":"NWFBGauxrnqq/KTnvpyVAA==","id":"tony-allen:US.bqjob_r7cde534383a42c02_0000019a5debb334_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r7cde534383a42c02_0000019a5debb334_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"SELECT\n    t1.miner,\n    t1.gas_limit\nFROM\n    (\n        SELECT\n            miner,\n            gas_limit,\n            ROW_NUMBER() OVER (ORDER BY total_difficulty DESC) AS rank_by_difficulty\n        FROM\n            `bigquery-public-data.crypto_ethereum_classic.blocks`\n    ) AS t1\nWHERE\n    t1.rank_by_difficulty = 1\nLIMIT 1","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anonc6072d41ddcac200c9624d06168ce68920c3fc981acadfde42109f0242e40edd"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r7cde534383a42c02_0000019a5debb334_1","location":"US"},"statistics":{"creationTime":"1762512319494","startTime":"1762512319565","endTime":"1762512320521","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT","searchStatistics":{"indexUsageMode":"UNUSED","indexUnusedReasons":[{"code":"QUERY_CACHE_HIT","message":"Search indexes are not used because the query was cached."}]}}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ echo '{"kind":"bigquery#job","etag":"NWFBGauxrnqq/KTnvpyVAA==","id":"tony-allen:US.bqjob_r7cde534383a42c02_0000019a5debb334_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r7cde534383a42c02_0000019a5debb334_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"SELECT\n    t1.miner,\n    t1.gas_limit\nFROM\n    (\n        SELECT\n            miner,\n            gas_limit,\n            ROW_NUMBER() OVER (ORDER BY total_difficulty DESC) AS rank_by_difficulty\n        FROM\n            `bigquery-public-data.crypto_ethereum_classic.blocks`\n    ) AS t1\nWHERE\n    t1.rank_by_difficulty = 1\nLIMIT 1","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anonc6072d41ddcac200c9624d06168ce68920c3fc981acadfde42109f0242e40edd"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r7cde534383a42c02_0000019a5debb334_1","location":"US"},"statistics":{"creationTime":"1762512319494","startTime":"1762512319565","endTime":"1762512320521","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT","searchStatistics":{"indexUsageMode":"UNUSED","indexUnusedReasons":[{"code":"QUERY_CACHE_HIT","message":"Search indexes are not used because the query was cached."}]}}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ jq -r .jobReference.jobId
+ job_id=bqjob_r7cde534383a42c02_0000019a5debb334_1
+ '[' -n bqjob_r7cde534383a42c02_0000019a5debb334_1 ']'
+ echo '  [SUCCESS] Query submitted.'
  [SUCCESS] Query submitted.
+ echo '  *** JOB ID FOR Peak Security Optimized: bqjob_r7cde534383a42c02_0000019a5debb334_1 ***'
  *** JOB ID FOR Peak Security Optimized: bqjob_r7cde534383a42c02_0000019a5debb334_1 ***
+ echo '  Waiting for job to complete...'
  Waiting for job to complete...
++ bq wait bqjob_r7cde534383a42c02_0000019a5debb334_1
+ wait_output='Waiting on bqjob_r7cde534383a42c02_0000019a5debb334_1 ... (0s) Current status: DONE   
Job tony-allen:bqjob_r7cde534383a42c02_0000019a5debb334_1

  Job Type    State      Start Time         Duration                User Email              Bytes Processed   Bytes Billed   Billing Tier   Labels  
 ---------- --------- ----------------- ---------------- --------------------------------- ----------------- -------------- -------------- -------- 
  query      SUCCESS   07 Nov 10:45:19   0:00:00.956000   admin@bentrollope.altostrat.com   0                 0                                     '
+ '[' 0 -ne 0 ']'
+ echo '  Job completed. Fetching statistics...'
  Job completed. Fetching statistics...
++ bq show --format=json -j bqjob_r7cde534383a42c02_0000019a5debb334_1
+ job_stats_json='{"kind":"bigquery#job","etag":"NWFBGauxrnqq/KTnvpyVAA==","id":"tony-allen:US.bqjob_r7cde534383a42c02_0000019a5debb334_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r7cde534383a42c02_0000019a5debb334_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"SELECT\n    t1.miner,\n    t1.gas_limit\nFROM\n    (\n        SELECT\n            miner,\n            gas_limit,\n            ROW_NUMBER() OVER (ORDER BY total_difficulty DESC) AS rank_by_difficulty\n        FROM\n            `bigquery-public-data.crypto_ethereum_classic.blocks`\n    ) AS t1\nWHERE\n    t1.rank_by_difficulty = 1\nLIMIT 1","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anonc6072d41ddcac200c9624d06168ce68920c3fc981acadfde42109f0242e40edd"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r7cde534383a42c02_0000019a5debb334_1","location":"US"},"statistics":{"creationTime":"1762512319494","startTime":"1762512319565","endTime":"1762512320521","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT","searchStatistics":{"indexUsageMode":"UNUSED","indexUnusedReasons":[{"code":"QUERY_CACHE_HIT","message":"Search indexes are not used because the query was cached."}]}}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ echo '{"kind":"bigquery#job","etag":"NWFBGauxrnqq/KTnvpyVAA==","id":"tony-allen:US.bqjob_r7cde534383a42c02_0000019a5debb334_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r7cde534383a42c02_0000019a5debb334_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"SELECT\n    t1.miner,\n    t1.gas_limit\nFROM\n    (\n        SELECT\n            miner,\n            gas_limit,\n            ROW_NUMBER() OVER (ORDER BY total_difficulty DESC) AS rank_by_difficulty\n        FROM\n            `bigquery-public-data.crypto_ethereum_classic.blocks`\n    ) AS t1\nWHERE\n    t1.rank_by_difficulty = 1\nLIMIT 1","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anonc6072d41ddcac200c9624d06168ce68920c3fc981acadfde42109f0242e40edd"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r7cde534383a42c02_0000019a5debb334_1","location":"US"},"statistics":{"creationTime":"1762512319494","startTime":"1762512319565","endTime":"1762512320521","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT","searchStatistics":{"indexUsageMode":"UNUSED","indexUnusedReasons":[{"code":"QUERY_CACHE_HIT","message":"Search indexes are not used because the query was cached."}]}}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ jq -r .statistics.totalBytesProcessed
+ total_bytes_processed=0
++ echo '{"kind":"bigquery#job","etag":"NWFBGauxrnqq/KTnvpyVAA==","id":"tony-allen:US.bqjob_r7cde534383a42c02_0000019a5debb334_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r7cde534383a42c02_0000019a5debb334_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"SELECT\n    t1.miner,\n    t1.gas_limit\nFROM\n    (\n        SELECT\n            miner,\n            gas_limit,\n            ROW_NUMBER() OVER (ORDER BY total_difficulty DESC) AS rank_by_difficulty\n        FROM\n            `bigquery-public-data.crypto_ethereum_classic.blocks`\n    ) AS t1\nWHERE\n    t1.rank_by_difficulty = 1\nLIMIT 1","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anonc6072d41ddcac200c9624d06168ce68920c3fc981acadfde42109f0242e40edd"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r7cde534383a42c02_0000019a5debb334_1","location":"US"},"statistics":{"creationTime":"1762512319494","startTime":"1762512319565","endTime":"1762512320521","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT","searchStatistics":{"indexUsageMode":"UNUSED","indexUnusedReasons":[{"code":"QUERY_CACHE_HIT","message":"Search indexes are not used because the query was cached."}]}}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ jq -r .statistics.totalSlotMs
+ total_slot_ms=null
++ echo '{"kind":"bigquery#job","etag":"NWFBGauxrnqq/KTnvpyVAA==","id":"tony-allen:US.bqjob_r7cde534383a42c02_0000019a5debb334_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r7cde534383a42c02_0000019a5debb334_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"SELECT\n    t1.miner,\n    t1.gas_limit\nFROM\n    (\n        SELECT\n            miner,\n            gas_limit,\n            ROW_NUMBER() OVER (ORDER BY total_difficulty DESC) AS rank_by_difficulty\n        FROM\n            `bigquery-public-data.crypto_ethereum_classic.blocks`\n    ) AS t1\nWHERE\n    t1.rank_by_difficulty = 1\nLIMIT 1","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anonc6072d41ddcac200c9624d06168ce68920c3fc981acadfde42109f0242e40edd"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r7cde534383a42c02_0000019a5debb334_1","location":"US"},"statistics":{"creationTime":"1762512319494","startTime":"1762512319565","endTime":"1762512320521","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT","searchStatistics":{"indexUsageMode":"UNUSED","indexUnusedReasons":[{"code":"QUERY_CACHE_HIT","message":"Search indexes are not used because the query was cached."}]}}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ jq -r .statistics.startTime
+ start_time=1762512319565
++ echo '{"kind":"bigquery#job","etag":"NWFBGauxrnqq/KTnvpyVAA==","id":"tony-allen:US.bqjob_r7cde534383a42c02_0000019a5debb334_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r7cde534383a42c02_0000019a5debb334_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"SELECT\n    t1.miner,\n    t1.gas_limit\nFROM\n    (\n        SELECT\n            miner,\n            gas_limit,\n            ROW_NUMBER() OVER (ORDER BY total_difficulty DESC) AS rank_by_difficulty\n        FROM\n            `bigquery-public-data.crypto_ethereum_classic.blocks`\n    ) AS t1\nWHERE\n    t1.rank_by_difficulty = 1\nLIMIT 1","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anonc6072d41ddcac200c9624d06168ce68920c3fc981acadfde42109f0242e40edd"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r7cde534383a42c02_0000019a5debb334_1","location":"US"},"statistics":{"creationTime":"1762512319494","startTime":"1762512319565","endTime":"1762512320521","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT","searchStatistics":{"indexUsageMode":"UNUSED","indexUnusedReasons":[{"code":"QUERY_CACHE_HIT","message":"Search indexes are not used because the query was cached."}]}}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ jq -r .statistics.endTime
+ end_time=1762512320521
++ echo 1762512319565
++ awk '{print int($1)}'
+ start_ms=1762512319565
++ echo 1762512320521
++ awk '{print int($1)}'
+ end_ms=1762512320521
+ duration_ms=956
+ echo '  --- Execution Statistics ---'
  --- Execution Statistics ---
+ echo '  Duration: 956 ms'
  Duration: 956 ms
+ echo '  Bytes Processed: 0 bytes'
  Bytes Processed: 0 bytes
+ echo '  Slot Milliseconds: null'
  Slot Milliseconds: null
+ echo '  ----------------------------'
  ----------------------------
+ echo -e 'Peak Security Optimized\tbqjob_r7cde534383a42c02_0000019a5debb334_1\t956\t0\tnull'
+ echo ''

+ echo '--- Running queries from top_internal_value_recipients_eval.sql ---'
--- Running queries from top_internal_value_recipients_eval.sql ---
+ run_query 'Top Internal Unoptimized' 'SELECT
    t.to_address,
    SUM(t.value) AS total_value_received_wei
FROM
    `bigquery-public-data.crypto_ethereum_classic.traces` AS t
WHERE
    t.trace_type = '\''call'\''
    AND t.status = 1
    AND (t.call_type NOT IN ('\''delegatecall'\'', '\''callcode'\'', '\''staticcall'\'') OR t.call_type IS NULL)
    AND t.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''
    AND t.block_timestamp < '\''2020-01-08 00:00:00 UTC'\''
    AND t.to_address IS NOT NULL
GROUP BY
    t.to_address
ORDER BY
    total_value_received_wei DESC
LIMIT 10'
+ local 'query_name=Top Internal Unoptimized'
+ local 'query=SELECT
    t.to_address,
    SUM(t.value) AS total_value_received_wei
FROM
    `bigquery-public-data.crypto_ethereum_classic.traces` AS t
WHERE
    t.trace_type = '\''call'\''
    AND t.status = 1
    AND (t.call_type NOT IN ('\''delegatecall'\'', '\''callcode'\'', '\''staticcall'\'') OR t.call_type IS NULL)
    AND t.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''
    AND t.block_timestamp < '\''2020-01-08 00:00:00 UTC'\''
    AND t.to_address IS NOT NULL
GROUP BY
    t.to_address
ORDER BY
    total_value_received_wei DESC
LIMIT 10'
+ echo ==================================================
==================================================
+ echo 'Executing Top Internal Unoptimized'
Executing Top Internal Unoptimized
+ echo ==================================================
==================================================
+ echo Query:
Query:
+ echo 'SELECT
    t.to_address,
    SUM(t.value) AS total_value_received_wei
FROM
    `bigquery-public-data.crypto_ethereum_classic.traces` AS t
WHERE
    t.trace_type = '\''call'\''
    AND t.status = 1
    AND (t.call_type NOT IN ('\''delegatecall'\'', '\''callcode'\'', '\''staticcall'\'') OR t.call_type IS NULL)
    AND t.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''
    AND t.block_timestamp < '\''2020-01-08 00:00:00 UTC'\''
    AND t.to_address IS NOT NULL
GROUP BY
    t.to_address
ORDER BY
    total_value_received_wei DESC
LIMIT 10'
SELECT
    t.to_address,
    SUM(t.value) AS total_value_received_wei
FROM
    `bigquery-public-data.crypto_ethereum_classic.traces` AS t
WHERE
    t.trace_type = 'call'
    AND t.status = 1
    AND (t.call_type NOT IN ('delegatecall', 'callcode', 'staticcall') OR t.call_type IS NULL)
    AND t.block_timestamp >= '2020-01-01 00:00:00 UTC'
    AND t.block_timestamp < '2020-01-08 00:00:00 UTC'
    AND t.to_address IS NOT NULL
GROUP BY
    t.to_address
ORDER BY
    total_value_received_wei DESC
LIMIT 10
+ echo --------------------------------------------------
--------------------------------------------------
++ bq query --nosync --use_legacy_sql=false --format=json --location=US 'SELECT
    t.to_address,
    SUM(t.value) AS total_value_received_wei
FROM
    `bigquery-public-data.crypto_ethereum_classic.traces` AS t
WHERE
    t.trace_type = '\''call'\''
    AND t.status = 1
    AND (t.call_type NOT IN ('\''delegatecall'\'', '\''callcode'\'', '\''staticcall'\'') OR t.call_type IS NULL)
    AND t.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''
    AND t.block_timestamp < '\''2020-01-08 00:00:00 UTC'\''
    AND t.to_address IS NOT NULL
GROUP BY
    t.to_address
ORDER BY
    total_value_received_wei DESC
LIMIT 10'
+ job_submission_output='{"kind":"bigquery#job","etag":"F/Q5gnYP9ZT1NkLbmT438g==","id":"tony-allen:US.bqjob_r972efcb736dc83_0000019a5debd135_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r972efcb736dc83_0000019a5debd135_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"SELECT\n    t.to_address,\n    SUM(t.value) AS total_value_received_wei\nFROM\n    `bigquery-public-data.crypto_ethereum_classic.traces` AS t\nWHERE\n    t.trace_type = '\''call'\''\n    AND t.status = 1\n    AND (t.call_type NOT IN ('\''delegatecall'\'', '\''callcode'\'', '\''staticcall'\'') OR t.call_type IS NULL)\n    AND t.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''\n    AND t.block_timestamp < '\''2020-01-08 00:00:00 UTC'\''\n    AND t.to_address IS NOT NULL\nGROUP BY\n    t.to_address\nORDER BY\n    total_value_received_wei DESC\nLIMIT 10","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anon6b91c9059415b0efeeb151e45eb1a9b25877073a652e5c2d85d840925096ab42"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r972efcb736dc83_0000019a5debd135_1","location":"US"},"statistics":{"creationTime":"1762512327192","startTime":"1762512327363","endTime":"1762512327522","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT","searchStatistics":{"indexUsageMode":"UNUSED","indexUnusedReasons":[{"code":"QUERY_CACHE_HIT","message":"Search indexes are not used because the query was cached."}]}}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ jq -r .jobReference.jobId
++ echo '{"kind":"bigquery#job","etag":"F/Q5gnYP9ZT1NkLbmT438g==","id":"tony-allen:US.bqjob_r972efcb736dc83_0000019a5debd135_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r972efcb736dc83_0000019a5debd135_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"SELECT\n    t.to_address,\n    SUM(t.value) AS total_value_received_wei\nFROM\n    `bigquery-public-data.crypto_ethereum_classic.traces` AS t\nWHERE\n    t.trace_type = '\''call'\''\n    AND t.status = 1\n    AND (t.call_type NOT IN ('\''delegatecall'\'', '\''callcode'\'', '\''staticcall'\'') OR t.call_type IS NULL)\n    AND t.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''\n    AND t.block_timestamp < '\''2020-01-08 00:00:00 UTC'\''\n    AND t.to_address IS NOT NULL\nGROUP BY\n    t.to_address\nORDER BY\n    total_value_received_wei DESC\nLIMIT 10","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anon6b91c9059415b0efeeb151e45eb1a9b25877073a652e5c2d85d840925096ab42"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r972efcb736dc83_0000019a5debd135_1","location":"US"},"statistics":{"creationTime":"1762512327192","startTime":"1762512327363","endTime":"1762512327522","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT","searchStatistics":{"indexUsageMode":"UNUSED","indexUnusedReasons":[{"code":"QUERY_CACHE_HIT","message":"Search indexes are not used because the query was cached."}]}}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
+ job_id=bqjob_r972efcb736dc83_0000019a5debd135_1
+ '[' -n bqjob_r972efcb736dc83_0000019a5debd135_1 ']'
+ echo '  [SUCCESS] Query submitted.'
  [SUCCESS] Query submitted.
+ echo '  *** JOB ID FOR Top Internal Unoptimized: bqjob_r972efcb736dc83_0000019a5debd135_1 ***'
  *** JOB ID FOR Top Internal Unoptimized: bqjob_r972efcb736dc83_0000019a5debd135_1 ***
+ echo '  Waiting for job to complete...'
  Waiting for job to complete...
++ bq wait bqjob_r972efcb736dc83_0000019a5debd135_1
+ wait_output='Waiting on bqjob_r972efcb736dc83_0000019a5debd135_1 ... (0s) Current status: DONE   
Job tony-allen:bqjob_r972efcb736dc83_0000019a5debd135_1

  Job Type    State      Start Time         Duration                User Email              Bytes Processed   Bytes Billed   Billing Tier   Labels  
 ---------- --------- ----------------- ---------------- --------------------------------- ----------------- -------------- -------------- -------- 
  query      SUCCESS   07 Nov 10:45:27   0:00:00.159000   admin@bentrollope.altostrat.com   0                 0                                     '
+ '[' 0 -ne 0 ']'
+ echo '  Job completed. Fetching statistics...'
  Job completed. Fetching statistics...
++ bq show --format=json -j bqjob_r972efcb736dc83_0000019a5debd135_1
+ job_stats_json='{"kind":"bigquery#job","etag":"F/Q5gnYP9ZT1NkLbmT438g==","id":"tony-allen:US.bqjob_r972efcb736dc83_0000019a5debd135_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r972efcb736dc83_0000019a5debd135_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"SELECT\n    t.to_address,\n    SUM(t.value) AS total_value_received_wei\nFROM\n    `bigquery-public-data.crypto_ethereum_classic.traces` AS t\nWHERE\n    t.trace_type = '\''call'\''\n    AND t.status = 1\n    AND (t.call_type NOT IN ('\''delegatecall'\'', '\''callcode'\'', '\''staticcall'\'') OR t.call_type IS NULL)\n    AND t.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''\n    AND t.block_timestamp < '\''2020-01-08 00:00:00 UTC'\''\n    AND t.to_address IS NOT NULL\nGROUP BY\n    t.to_address\nORDER BY\n    total_value_received_wei DESC\nLIMIT 10","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anon6b91c9059415b0efeeb151e45eb1a9b25877073a652e5c2d85d840925096ab42"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r972efcb736dc83_0000019a5debd135_1","location":"US"},"statistics":{"creationTime":"1762512327192","startTime":"1762512327363","endTime":"1762512327522","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT","searchStatistics":{"indexUsageMode":"UNUSED","indexUnusedReasons":[{"code":"QUERY_CACHE_HIT","message":"Search indexes are not used because the query was cached."}]}}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ jq -r .statistics.totalBytesProcessed
++ echo '{"kind":"bigquery#job","etag":"F/Q5gnYP9ZT1NkLbmT438g==","id":"tony-allen:US.bqjob_r972efcb736dc83_0000019a5debd135_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r972efcb736dc83_0000019a5debd135_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"SELECT\n    t.to_address,\n    SUM(t.value) AS total_value_received_wei\nFROM\n    `bigquery-public-data.crypto_ethereum_classic.traces` AS t\nWHERE\n    t.trace_type = '\''call'\''\n    AND t.status = 1\n    AND (t.call_type NOT IN ('\''delegatecall'\'', '\''callcode'\'', '\''staticcall'\'') OR t.call_type IS NULL)\n    AND t.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''\n    AND t.block_timestamp < '\''2020-01-08 00:00:00 UTC'\''\n    AND t.to_address IS NOT NULL\nGROUP BY\n    t.to_address\nORDER BY\n    total_value_received_wei DESC\nLIMIT 10","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anon6b91c9059415b0efeeb151e45eb1a9b25877073a652e5c2d85d840925096ab42"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r972efcb736dc83_0000019a5debd135_1","location":"US"},"statistics":{"creationTime":"1762512327192","startTime":"1762512327363","endTime":"1762512327522","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT","searchStatistics":{"indexUsageMode":"UNUSED","indexUnusedReasons":[{"code":"QUERY_CACHE_HIT","message":"Search indexes are not used because the query was cached."}]}}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
+ total_bytes_processed=0
++ echo '{"kind":"bigquery#job","etag":"F/Q5gnYP9ZT1NkLbmT438g==","id":"tony-allen:US.bqjob_r972efcb736dc83_0000019a5debd135_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r972efcb736dc83_0000019a5debd135_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"SELECT\n    t.to_address,\n    SUM(t.value) AS total_value_received_wei\nFROM\n    `bigquery-public-data.crypto_ethereum_classic.traces` AS t\nWHERE\n    t.trace_type = '\''call'\''\n    AND t.status = 1\n    AND (t.call_type NOT IN ('\''delegatecall'\'', '\''callcode'\'', '\''staticcall'\'') OR t.call_type IS NULL)\n    AND t.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''\n    AND t.block_timestamp < '\''2020-01-08 00:00:00 UTC'\''\n    AND t.to_address IS NOT NULL\nGROUP BY\n    t.to_address\nORDER BY\n    total_value_received_wei DESC\nLIMIT 10","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anon6b91c9059415b0efeeb151e45eb1a9b25877073a652e5c2d85d840925096ab42"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r972efcb736dc83_0000019a5debd135_1","location":"US"},"statistics":{"creationTime":"1762512327192","startTime":"1762512327363","endTime":"1762512327522","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT","searchStatistics":{"indexUsageMode":"UNUSED","indexUnusedReasons":[{"code":"QUERY_CACHE_HIT","message":"Search indexes are not used because the query was cached."}]}}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ jq -r .statistics.totalSlotMs
+ total_slot_ms=null
++ jq -r .statistics.startTime
++ echo '{"kind":"bigquery#job","etag":"F/Q5gnYP9ZT1NkLbmT438g==","id":"tony-allen:US.bqjob_r972efcb736dc83_0000019a5debd135_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r972efcb736dc83_0000019a5debd135_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"SELECT\n    t.to_address,\n    SUM(t.value) AS total_value_received_wei\nFROM\n    `bigquery-public-data.crypto_ethereum_classic.traces` AS t\nWHERE\n    t.trace_type = '\''call'\''\n    AND t.status = 1\n    AND (t.call_type NOT IN ('\''delegatecall'\'', '\''callcode'\'', '\''staticcall'\'') OR t.call_type IS NULL)\n    AND t.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''\n    AND t.block_timestamp < '\''2020-01-08 00:00:00 UTC'\''\n    AND t.to_address IS NOT NULL\nGROUP BY\n    t.to_address\nORDER BY\n    total_value_received_wei DESC\nLIMIT 10","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anon6b91c9059415b0efeeb151e45eb1a9b25877073a652e5c2d85d840925096ab42"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r972efcb736dc83_0000019a5debd135_1","location":"US"},"statistics":{"creationTime":"1762512327192","startTime":"1762512327363","endTime":"1762512327522","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT","searchStatistics":{"indexUsageMode":"UNUSED","indexUnusedReasons":[{"code":"QUERY_CACHE_HIT","message":"Search indexes are not used because the query was cached."}]}}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
+ start_time=1762512327363
++ echo '{"kind":"bigquery#job","etag":"F/Q5gnYP9ZT1NkLbmT438g==","id":"tony-allen:US.bqjob_r972efcb736dc83_0000019a5debd135_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r972efcb736dc83_0000019a5debd135_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"SELECT\n    t.to_address,\n    SUM(t.value) AS total_value_received_wei\nFROM\n    `bigquery-public-data.crypto_ethereum_classic.traces` AS t\nWHERE\n    t.trace_type = '\''call'\''\n    AND t.status = 1\n    AND (t.call_type NOT IN ('\''delegatecall'\'', '\''callcode'\'', '\''staticcall'\'') OR t.call_type IS NULL)\n    AND t.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''\n    AND t.block_timestamp < '\''2020-01-08 00:00:00 UTC'\''\n    AND t.to_address IS NOT NULL\nGROUP BY\n    t.to_address\nORDER BY\n    total_value_received_wei DESC\nLIMIT 10","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anon6b91c9059415b0efeeb151e45eb1a9b25877073a652e5c2d85d840925096ab42"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r972efcb736dc83_0000019a5debd135_1","location":"US"},"statistics":{"creationTime":"1762512327192","startTime":"1762512327363","endTime":"1762512327522","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT","searchStatistics":{"indexUsageMode":"UNUSED","indexUnusedReasons":[{"code":"QUERY_CACHE_HIT","message":"Search indexes are not used because the query was cached."}]}}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ jq -r .statistics.endTime
+ end_time=1762512327522
++ echo 1762512327363
++ awk '{print int($1)}'
+ start_ms=1762512327363
++ echo 1762512327522
++ awk '{print int($1)}'
+ end_ms=1762512327522
+ duration_ms=159
+ echo '  --- Execution Statistics ---'
  --- Execution Statistics ---
+ echo '  Duration: 159 ms'
  Duration: 159 ms
+ echo '  Bytes Processed: 0 bytes'
  Bytes Processed: 0 bytes
+ echo '  Slot Milliseconds: null'
  Slot Milliseconds: null
+ echo '  ----------------------------'
  ----------------------------
+ echo -e 'Top Internal Unoptimized\tbqjob_r972efcb736dc83_0000019a5debd135_1\t159\t0\tnull'
+ echo ''

+ run_query 'Top Internal Optimized' 'SELECT
    to_address,
    SUM(value) AS total_value_received_wei
FROM
    `bigquery-public-data.crypto_ethereum_classic.traces`
WHERE
    trace_type = '\''call'\''
    AND status = 1
    AND (call_type NOT IN ('\''delegatecall'\'', '\''callcode'\'', '\''staticcall'\'') OR call_type IS NULL)
    AND block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''
    AND block_timestamp < '\''2020-01-08 00:00:00 UTC'\''
    AND to_address IS NOT NULL
GROUP BY
    to_address
QUALIFY
    ROW_NUMBER() OVER (ORDER BY total_value_received_wei DESC) <= 10'
+ local 'query_name=Top Internal Optimized'
+ local 'query=SELECT
    to_address,
    SUM(value) AS total_value_received_wei
FROM
    `bigquery-public-data.crypto_ethereum_classic.traces`
WHERE
    trace_type = '\''call'\''
    AND status = 1
    AND (call_type NOT IN ('\''delegatecall'\'', '\''callcode'\'', '\''staticcall'\'') OR call_type IS NULL)
    AND block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''
    AND block_timestamp < '\''2020-01-08 00:00:00 UTC'\''
    AND to_address IS NOT NULL
GROUP BY
    to_address
QUALIFY
    ROW_NUMBER() OVER (ORDER BY total_value_received_wei DESC) <= 10'
+ echo ==================================================
==================================================
+ echo 'Executing Top Internal Optimized'
Executing Top Internal Optimized
+ echo ==================================================
==================================================
+ echo Query:
Query:
+ echo 'SELECT
    to_address,
    SUM(value) AS total_value_received_wei
FROM
    `bigquery-public-data.crypto_ethereum_classic.traces`
WHERE
    trace_type = '\''call'\''
    AND status = 1
    AND (call_type NOT IN ('\''delegatecall'\'', '\''callcode'\'', '\''staticcall'\'') OR call_type IS NULL)
    AND block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''
    AND block_timestamp < '\''2020-01-08 00:00:00 UTC'\''
    AND to_address IS NOT NULL
GROUP BY
    to_address
QUALIFY
    ROW_NUMBER() OVER (ORDER BY total_value_received_wei DESC) <= 10'
SELECT
    to_address,
    SUM(value) AS total_value_received_wei
FROM
    `bigquery-public-data.crypto_ethereum_classic.traces`
WHERE
    trace_type = 'call'
    AND status = 1
    AND (call_type NOT IN ('delegatecall', 'callcode', 'staticcall') OR call_type IS NULL)
    AND block_timestamp >= '2020-01-01 00:00:00 UTC'
    AND block_timestamp < '2020-01-08 00:00:00 UTC'
    AND to_address IS NOT NULL
GROUP BY
    to_address
QUALIFY
    ROW_NUMBER() OVER (ORDER BY total_value_received_wei DESC) <= 10
+ echo --------------------------------------------------
--------------------------------------------------
++ bq query --nosync --use_legacy_sql=false --format=json --location=US 'SELECT
    to_address,
    SUM(value) AS total_value_received_wei
FROM
    `bigquery-public-data.crypto_ethereum_classic.traces`
WHERE
    trace_type = '\''call'\''
    AND status = 1
    AND (call_type NOT IN ('\''delegatecall'\'', '\''callcode'\'', '\''staticcall'\'') OR call_type IS NULL)
    AND block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''
    AND block_timestamp < '\''2020-01-08 00:00:00 UTC'\''
    AND to_address IS NOT NULL
GROUP BY
    to_address
QUALIFY
    ROW_NUMBER() OVER (ORDER BY total_value_received_wei DESC) <= 10'
+ job_submission_output='{"kind":"bigquery#job","etag":"loaYaqoWy6jR25zPAvRqbA==","id":"tony-allen:US.bqjob_r4e6047445e4fe9e6_0000019a5debedf0_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r4e6047445e4fe9e6_0000019a5debedf0_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"SELECT\n    to_address,\n    SUM(value) AS total_value_received_wei\nFROM\n    `bigquery-public-data.crypto_ethereum_classic.traces`\nWHERE\n    trace_type = '\''call'\''\n    AND status = 1\n    AND (call_type NOT IN ('\''delegatecall'\'', '\''callcode'\'', '\''staticcall'\'') OR call_type IS NULL)\n    AND block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''\n    AND block_timestamp < '\''2020-01-08 00:00:00 UTC'\''\n    AND to_address IS NOT NULL\nGROUP BY\n    to_address\nQUALIFY\n    ROW_NUMBER() OVER (ORDER BY total_value_received_wei DESC) <= 10","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anon89171864931ad8c95f73dce732eb46e375d263dc8156d901dc9b8400c9def3c8"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r4e6047445e4fe9e6_0000019a5debedf0_1","location":"US"},"statistics":{"creationTime":"1762512334560","startTime":"1762512334722","endTime":"1762512334890","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT","searchStatistics":{"indexUsageMode":"UNUSED","indexUnusedReasons":[{"code":"QUERY_CACHE_HIT","message":"Search indexes are not used because the query was cached."}]}}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ echo '{"kind":"bigquery#job","etag":"loaYaqoWy6jR25zPAvRqbA==","id":"tony-allen:US.bqjob_r4e6047445e4fe9e6_0000019a5debedf0_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r4e6047445e4fe9e6_0000019a5debedf0_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"SELECT\n    to_address,\n    SUM(value) AS total_value_received_wei\nFROM\n    `bigquery-public-data.crypto_ethereum_classic.traces`\nWHERE\n    trace_type = '\''call'\''\n    AND status = 1\n    AND (call_type NOT IN ('\''delegatecall'\'', '\''callcode'\'', '\''staticcall'\'') OR call_type IS NULL)\n    AND block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''\n    AND block_timestamp < '\''2020-01-08 00:00:00 UTC'\''\n    AND to_address IS NOT NULL\nGROUP BY\n    to_address\nQUALIFY\n    ROW_NUMBER() OVER (ORDER BY total_value_received_wei DESC) <= 10","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anon89171864931ad8c95f73dce732eb46e375d263dc8156d901dc9b8400c9def3c8"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r4e6047445e4fe9e6_0000019a5debedf0_1","location":"US"},"statistics":{"creationTime":"1762512334560","startTime":"1762512334722","endTime":"1762512334890","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT","searchStatistics":{"indexUsageMode":"UNUSED","indexUnusedReasons":[{"code":"QUERY_CACHE_HIT","message":"Search indexes are not used because the query was cached."}]}}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ jq -r .jobReference.jobId
+ job_id=bqjob_r4e6047445e4fe9e6_0000019a5debedf0_1
+ '[' -n bqjob_r4e6047445e4fe9e6_0000019a5debedf0_1 ']'
+ echo '  [SUCCESS] Query submitted.'
  [SUCCESS] Query submitted.
+ echo '  *** JOB ID FOR Top Internal Optimized: bqjob_r4e6047445e4fe9e6_0000019a5debedf0_1 ***'
  *** JOB ID FOR Top Internal Optimized: bqjob_r4e6047445e4fe9e6_0000019a5debedf0_1 ***
+ echo '  Waiting for job to complete...'
  Waiting for job to complete...
++ bq wait bqjob_r4e6047445e4fe9e6_0000019a5debedf0_1
+ wait_output='Waiting on bqjob_r4e6047445e4fe9e6_0000019a5debedf0_1 ... (0s) Current status: DONE   
Job tony-allen:bqjob_r4e6047445e4fe9e6_0000019a5debedf0_1

  Job Type    State      Start Time         Duration                User Email              Bytes Processed   Bytes Billed   Billing Tier   Labels  
 ---------- --------- ----------------- ---------------- --------------------------------- ----------------- -------------- -------------- -------- 
  query      SUCCESS   07 Nov 10:45:34   0:00:00.168000   admin@bentrollope.altostrat.com   0                 0                                     '
+ '[' 0 -ne 0 ']'
+ echo '  Job completed. Fetching statistics...'
  Job completed. Fetching statistics...
++ bq show --format=json -j bqjob_r4e6047445e4fe9e6_0000019a5debedf0_1
+ job_stats_json='{"kind":"bigquery#job","etag":"loaYaqoWy6jR25zPAvRqbA==","id":"tony-allen:US.bqjob_r4e6047445e4fe9e6_0000019a5debedf0_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r4e6047445e4fe9e6_0000019a5debedf0_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"SELECT\n    to_address,\n    SUM(value) AS total_value_received_wei\nFROM\n    `bigquery-public-data.crypto_ethereum_classic.traces`\nWHERE\n    trace_type = '\''call'\''\n    AND status = 1\n    AND (call_type NOT IN ('\''delegatecall'\'', '\''callcode'\'', '\''staticcall'\'') OR call_type IS NULL)\n    AND block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''\n    AND block_timestamp < '\''2020-01-08 00:00:00 UTC'\''\n    AND to_address IS NOT NULL\nGROUP BY\n    to_address\nQUALIFY\n    ROW_NUMBER() OVER (ORDER BY total_value_received_wei DESC) <= 10","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anon89171864931ad8c95f73dce732eb46e375d263dc8156d901dc9b8400c9def3c8"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r4e6047445e4fe9e6_0000019a5debedf0_1","location":"US"},"statistics":{"creationTime":"1762512334560","startTime":"1762512334722","endTime":"1762512334890","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT","searchStatistics":{"indexUsageMode":"UNUSED","indexUnusedReasons":[{"code":"QUERY_CACHE_HIT","message":"Search indexes are not used because the query was cached."}]}}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ echo '{"kind":"bigquery#job","etag":"loaYaqoWy6jR25zPAvRqbA==","id":"tony-allen:US.bqjob_r4e6047445e4fe9e6_0000019a5debedf0_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r4e6047445e4fe9e6_0000019a5debedf0_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"SELECT\n    to_address,\n    SUM(value) AS total_value_received_wei\nFROM\n    `bigquery-public-data.crypto_ethereum_classic.traces`\nWHERE\n    trace_type = '\''call'\''\n    AND status = 1\n    AND (call_type NOT IN ('\''delegatecall'\'', '\''callcode'\'', '\''staticcall'\'') OR call_type IS NULL)\n    AND block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''\n    AND block_timestamp < '\''2020-01-08 00:00:00 UTC'\''\n    AND to_address IS NOT NULL\nGROUP BY\n    to_address\nQUALIFY\n    ROW_NUMBER() OVER (ORDER BY total_value_received_wei DESC) <= 10","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anon89171864931ad8c95f73dce732eb46e375d263dc8156d901dc9b8400c9def3c8"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r4e6047445e4fe9e6_0000019a5debedf0_1","location":"US"},"statistics":{"creationTime":"1762512334560","startTime":"1762512334722","endTime":"1762512334890","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT","searchStatistics":{"indexUsageMode":"UNUSED","indexUnusedReasons":[{"code":"QUERY_CACHE_HIT","message":"Search indexes are not used because the query was cached."}]}}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ jq -r .statistics.totalBytesProcessed
+ total_bytes_processed=0
++ echo '{"kind":"bigquery#job","etag":"loaYaqoWy6jR25zPAvRqbA==","id":"tony-allen:US.bqjob_r4e6047445e4fe9e6_0000019a5debedf0_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r4e6047445e4fe9e6_0000019a5debedf0_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"SELECT\n    to_address,\n    SUM(value) AS total_value_received_wei\nFROM\n    `bigquery-public-data.crypto_ethereum_classic.traces`\nWHERE\n    trace_type = '\''call'\''\n    AND status = 1\n    AND (call_type NOT IN ('\''delegatecall'\'', '\''callcode'\'', '\''staticcall'\'') OR call_type IS NULL)\n    AND block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''\n    AND block_timestamp < '\''2020-01-08 00:00:00 UTC'\''\n    AND to_address IS NOT NULL\nGROUP BY\n    to_address\nQUALIFY\n    ROW_NUMBER() OVER (ORDER BY total_value_received_wei DESC) <= 10","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anon89171864931ad8c95f73dce732eb46e375d263dc8156d901dc9b8400c9def3c8"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r4e6047445e4fe9e6_0000019a5debedf0_1","location":"US"},"statistics":{"creationTime":"1762512334560","startTime":"1762512334722","endTime":"1762512334890","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT","searchStatistics":{"indexUsageMode":"UNUSED","indexUnusedReasons":[{"code":"QUERY_CACHE_HIT","message":"Search indexes are not used because the query was cached."}]}}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ jq -r .statistics.totalSlotMs
+ total_slot_ms=null
++ echo '{"kind":"bigquery#job","etag":"loaYaqoWy6jR25zPAvRqbA==","id":"tony-allen:US.bqjob_r4e6047445e4fe9e6_0000019a5debedf0_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r4e6047445e4fe9e6_0000019a5debedf0_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"SELECT\n    to_address,\n    SUM(value) AS total_value_received_wei\nFROM\n    `bigquery-public-data.crypto_ethereum_classic.traces`\nWHERE\n    trace_type = '\''call'\''\n    AND status = 1\n    AND (call_type NOT IN ('\''delegatecall'\'', '\''callcode'\'', '\''staticcall'\'') OR call_type IS NULL)\n    AND block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''\n    AND block_timestamp < '\''2020-01-08 00:00:00 UTC'\''\n    AND to_address IS NOT NULL\nGROUP BY\n    to_address\nQUALIFY\n    ROW_NUMBER() OVER (ORDER BY total_value_received_wei DESC) <= 10","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anon89171864931ad8c95f73dce732eb46e375d263dc8156d901dc9b8400c9def3c8"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r4e6047445e4fe9e6_0000019a5debedf0_1","location":"US"},"statistics":{"creationTime":"1762512334560","startTime":"1762512334722","endTime":"1762512334890","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT","searchStatistics":{"indexUsageMode":"UNUSED","indexUnusedReasons":[{"code":"QUERY_CACHE_HIT","message":"Search indexes are not used because the query was cached."}]}}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ jq -r .statistics.startTime
+ start_time=1762512334722
++ echo '{"kind":"bigquery#job","etag":"loaYaqoWy6jR25zPAvRqbA==","id":"tony-allen:US.bqjob_r4e6047445e4fe9e6_0000019a5debedf0_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r4e6047445e4fe9e6_0000019a5debedf0_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"SELECT\n    to_address,\n    SUM(value) AS total_value_received_wei\nFROM\n    `bigquery-public-data.crypto_ethereum_classic.traces`\nWHERE\n    trace_type = '\''call'\''\n    AND status = 1\n    AND (call_type NOT IN ('\''delegatecall'\'', '\''callcode'\'', '\''staticcall'\'') OR call_type IS NULL)\n    AND block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''\n    AND block_timestamp < '\''2020-01-08 00:00:00 UTC'\''\n    AND to_address IS NOT NULL\nGROUP BY\n    to_address\nQUALIFY\n    ROW_NUMBER() OVER (ORDER BY total_value_received_wei DESC) <= 10","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anon89171864931ad8c95f73dce732eb46e375d263dc8156d901dc9b8400c9def3c8"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r4e6047445e4fe9e6_0000019a5debedf0_1","location":"US"},"statistics":{"creationTime":"1762512334560","startTime":"1762512334722","endTime":"1762512334890","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT","searchStatistics":{"indexUsageMode":"UNUSED","indexUnusedReasons":[{"code":"QUERY_CACHE_HIT","message":"Search indexes are not used because the query was cached."}]}}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ jq -r .statistics.endTime
+ end_time=1762512334890
++ echo 1762512334722
++ awk '{print int($1)}'
+ start_ms=1762512334722
++ echo 1762512334890
++ awk '{print int($1)}'
+ end_ms=1762512334890
+ duration_ms=168
+ echo '  --- Execution Statistics ---'
  --- Execution Statistics ---
+ echo '  Duration: 168 ms'
  Duration: 168 ms
+ echo '  Bytes Processed: 0 bytes'
  Bytes Processed: 0 bytes
+ echo '  Slot Milliseconds: null'
  Slot Milliseconds: null
+ echo '  ----------------------------'
  ----------------------------
+ echo -e 'Top Internal Optimized\tbqjob_r4e6047445e4fe9e6_0000019a5debedf0_1\t168\t0\tnull'
+ echo ''

+ echo '--- Running queries from top_sender_net_flow_analysis_eval.sql ---'
--- Running queries from top_sender_net_flow_analysis_eval.sql ---
+ run_query 'Top Sender Unoptimized' 'WITH TopSenders AS (
    -- CTE 1: Identify the top 5 addresses based on the count of successful transactions
    SELECT
        t.from_address AS address,
        COUNT(t.hash) AS transaction_count
    FROM
        `bigquery-public-data.crypto_ethereum_classic.transactions` AS t
    WHERE
        t.receipt_status = 1 
        AND t.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\'' 
        AND t.block_timestamp < '\''2020-04-01 00:00:00 UTC'\''  
    GROUP BY
        1
    ORDER BY
        transaction_count DESC
    LIMIT 5
),

TotalFees AS (
    -- CTE 2: Requires a second scan of the '\''transactions'\'' table unnecessarily
    SELECT
        t.from_address AS address,
        SUM(CAST(t.gas_price AS NUMERIC) * CAST(t.receipt_gas_used AS NUMERIC)) AS total_fees_paid
    FROM
        `bigquery-public-data.crypto_ethereum_classic.transactions` AS t
    INNER JOIN
        TopSenders AS s ON t.from_address = s.address
    WHERE
        t.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''
        AND t.block_timestamp < '\''2020-04-01 00:00:00 UTC'\''
        AND t.receipt_status = 1
    GROUP BY
        1
),

TotalValueSent AS (
    -- CTE 3: Scans the '\''traces'\'' table
    SELECT
        tr.from_address AS address,
        SUM(tr.value) AS total_value_sent
    FROM
        `bigquery-public-data.crypto_ethereum_classic.traces` AS tr
    INNER JOIN
        TopSenders AS s ON tr.from_address = s.address
    WHERE
        tr.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''  
        AND tr.block_timestamp < '\''2020-04-01 00:00:00 UTC'\'' 
    GROUP BY
        1
)

-- Final SELECT: Joins the calculated fees and values to find the net ether flow
SELECT
    f.address,
    v.total_value_sent,
    f.total_fees_paid,
    v.total_value_sent - f.total_fees_paid AS net_ether_flow_wei
FROM
    TotalFees AS f
INNER JOIN
    TotalValueSent AS v ON f.address = v.address
ORDER BY
    net_ether_flow_wei DESC
LIMIT 100'
+ local 'query_name=Top Sender Unoptimized'
+ local 'query=WITH TopSenders AS (
    -- CTE 1: Identify the top 5 addresses based on the count of successful transactions
    SELECT
        t.from_address AS address,
        COUNT(t.hash) AS transaction_count
    FROM
        `bigquery-public-data.crypto_ethereum_classic.transactions` AS t
    WHERE
        t.receipt_status = 1 
        AND t.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\'' 
        AND t.block_timestamp < '\''2020-04-01 00:00:00 UTC'\''  
    GROUP BY
        1
    ORDER BY
        transaction_count DESC
    LIMIT 5
),

TotalFees AS (
    -- CTE 2: Requires a second scan of the '\''transactions'\'' table unnecessarily
    SELECT
        t.from_address AS address,
        SUM(CAST(t.gas_price AS NUMERIC) * CAST(t.receipt_gas_used AS NUMERIC)) AS total_fees_paid
    FROM
        `bigquery-public-data.crypto_ethereum_classic.transactions` AS t
    INNER JOIN
        TopSenders AS s ON t.from_address = s.address
    WHERE
        t.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''
        AND t.block_timestamp < '\''2020-04-01 00:00:00 UTC'\''
        AND t.receipt_status = 1
    GROUP BY
        1
),

TotalValueSent AS (
    -- CTE 3: Scans the '\''traces'\'' table
    SELECT
        tr.from_address AS address,
        SUM(tr.value) AS total_value_sent
    FROM
        `bigquery-public-data.crypto_ethereum_classic.traces` AS tr
    INNER JOIN
        TopSenders AS s ON tr.from_address = s.address
    WHERE
        tr.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''  
        AND tr.block_timestamp < '\''2020-04-01 00:00:00 UTC'\'' 
    GROUP BY
        1
)

-- Final SELECT: Joins the calculated fees and values to find the net ether flow
SELECT
    f.address,
    v.total_value_sent,
    f.total_fees_paid,
    v.total_value_sent - f.total_fees_paid AS net_ether_flow_wei
FROM
    TotalFees AS f
INNER JOIN
    TotalValueSent AS v ON f.address = v.address
ORDER BY
    net_ether_flow_wei DESC
LIMIT 100'
+ echo ==================================================
==================================================
+ echo 'Executing Top Sender Unoptimized'
Executing Top Sender Unoptimized
+ echo ==================================================
==================================================
+ echo Query:
Query:
+ echo 'WITH TopSenders AS (
    -- CTE 1: Identify the top 5 addresses based on the count of successful transactions
    SELECT
        t.from_address AS address,
        COUNT(t.hash) AS transaction_count
    FROM
        `bigquery-public-data.crypto_ethereum_classic.transactions` AS t
    WHERE
        t.receipt_status = 1 
        AND t.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\'' 
        AND t.block_timestamp < '\''2020-04-01 00:00:00 UTC'\''  
    GROUP BY
        1
    ORDER BY
        transaction_count DESC
    LIMIT 5
),

TotalFees AS (
    -- CTE 2: Requires a second scan of the '\''transactions'\'' table unnecessarily
    SELECT
        t.from_address AS address,
        SUM(CAST(t.gas_price AS NUMERIC) * CAST(t.receipt_gas_used AS NUMERIC)) AS total_fees_paid
    FROM
        `bigquery-public-data.crypto_ethereum_classic.transactions` AS t
    INNER JOIN
        TopSenders AS s ON t.from_address = s.address
    WHERE
        t.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''
        AND t.block_timestamp < '\''2020-04-01 00:00:00 UTC'\''
        AND t.receipt_status = 1
    GROUP BY
        1
),

TotalValueSent AS (
    -- CTE 3: Scans the '\''traces'\'' table
    SELECT
        tr.from_address AS address,
        SUM(tr.value) AS total_value_sent
    FROM
        `bigquery-public-data.crypto_ethereum_classic.traces` AS tr
    INNER JOIN
        TopSenders AS s ON tr.from_address = s.address
    WHERE
        tr.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''  
        AND tr.block_timestamp < '\''2020-04-01 00:00:00 UTC'\'' 
    GROUP BY
        1
)

-- Final SELECT: Joins the calculated fees and values to find the net ether flow
SELECT
    f.address,
    v.total_value_sent,
    f.total_fees_paid,
    v.total_value_sent - f.total_fees_paid AS net_ether_flow_wei
FROM
    TotalFees AS f
INNER JOIN
    TotalValueSent AS v ON f.address = v.address
ORDER BY
    net_ether_flow_wei DESC
LIMIT 100'
WITH TopSenders AS (
    -- CTE 1: Identify the top 5 addresses based on the count of successful transactions
    SELECT
        t.from_address AS address,
        COUNT(t.hash) AS transaction_count
    FROM
        `bigquery-public-data.crypto_ethereum_classic.transactions` AS t
    WHERE
        t.receipt_status = 1 
        AND t.block_timestamp >= '2020-01-01 00:00:00 UTC' 
        AND t.block_timestamp < '2020-04-01 00:00:00 UTC'  
    GROUP BY
        1
    ORDER BY
        transaction_count DESC
    LIMIT 5
),

TotalFees AS (
    -- CTE 2: Requires a second scan of the 'transactions' table unnecessarily
    SELECT
        t.from_address AS address,
        SUM(CAST(t.gas_price AS NUMERIC) * CAST(t.receipt_gas_used AS NUMERIC)) AS total_fees_paid
    FROM
        `bigquery-public-data.crypto_ethereum_classic.transactions` AS t
    INNER JOIN
        TopSenders AS s ON t.from_address = s.address
    WHERE
        t.block_timestamp >= '2020-01-01 00:00:00 UTC'
        AND t.block_timestamp < '2020-04-01 00:00:00 UTC'
        AND t.receipt_status = 1
    GROUP BY
        1
),

TotalValueSent AS (
    -- CTE 3: Scans the 'traces' table
    SELECT
        tr.from_address AS address,
        SUM(tr.value) AS total_value_sent
    FROM
        `bigquery-public-data.crypto_ethereum_classic.traces` AS tr
    INNER JOIN
        TopSenders AS s ON tr.from_address = s.address
    WHERE
        tr.block_timestamp >= '2020-01-01 00:00:00 UTC'  
        AND tr.block_timestamp < '2020-04-01 00:00:00 UTC' 
    GROUP BY
        1
)

-- Final SELECT: Joins the calculated fees and values to find the net ether flow
SELECT
    f.address,
    v.total_value_sent,
    f.total_fees_paid,
    v.total_value_sent - f.total_fees_paid AS net_ether_flow_wei
FROM
    TotalFees AS f
INNER JOIN
    TotalValueSent AS v ON f.address = v.address
ORDER BY
    net_ether_flow_wei DESC
LIMIT 100
+ echo --------------------------------------------------
--------------------------------------------------
++ bq query --nosync --use_legacy_sql=false --format=json --location=US 'WITH TopSenders AS (
    -- CTE 1: Identify the top 5 addresses based on the count of successful transactions
    SELECT
        t.from_address AS address,
        COUNT(t.hash) AS transaction_count
    FROM
        `bigquery-public-data.crypto_ethereum_classic.transactions` AS t
    WHERE
        t.receipt_status = 1 
        AND t.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\'' 
        AND t.block_timestamp < '\''2020-04-01 00:00:00 UTC'\''  
    GROUP BY
        1
    ORDER BY
        transaction_count DESC
    LIMIT 5
),

TotalFees AS (
    -- CTE 2: Requires a second scan of the '\''transactions'\'' table unnecessarily
    SELECT
        t.from_address AS address,
        SUM(CAST(t.gas_price AS NUMERIC) * CAST(t.receipt_gas_used AS NUMERIC)) AS total_fees_paid
    FROM
        `bigquery-public-data.crypto_ethereum_classic.transactions` AS t
    INNER JOIN
        TopSenders AS s ON t.from_address = s.address
    WHERE
        t.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''
        AND t.block_timestamp < '\''2020-04-01 00:00:00 UTC'\''
        AND t.receipt_status = 1
    GROUP BY
        1
),

TotalValueSent AS (
    -- CTE 3: Scans the '\''traces'\'' table
    SELECT
        tr.from_address AS address,
        SUM(tr.value) AS total_value_sent
    FROM
        `bigquery-public-data.crypto_ethereum_classic.traces` AS tr
    INNER JOIN
        TopSenders AS s ON tr.from_address = s.address
    WHERE
        tr.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''  
        AND tr.block_timestamp < '\''2020-04-01 00:00:00 UTC'\'' 
    GROUP BY
        1
)

-- Final SELECT: Joins the calculated fees and values to find the net ether flow
SELECT
    f.address,
    v.total_value_sent,
    f.total_fees_paid,
    v.total_value_sent - f.total_fees_paid AS net_ether_flow_wei
FROM
    TotalFees AS f
INNER JOIN
    TotalValueSent AS v ON f.address = v.address
ORDER BY
    net_ether_flow_wei DESC
LIMIT 100'
+ job_submission_output='{"kind":"bigquery#job","etag":"tW2b43T9mtgYUirw2O/1yA==","id":"tony-allen:US.bqjob_r43d4326465b6a26c_0000019a5dec0c74_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r43d4326465b6a26c_0000019a5dec0c74_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"WITH TopSenders AS (\n    -- CTE 1: Identify the top 5 addresses based on the count of successful transactions\n    SELECT\n        t.from_address AS address,\n        COUNT(t.hash) AS transaction_count\n    FROM\n        `bigquery-public-data.crypto_ethereum_classic.transactions` AS t\n    WHERE\n        t.receipt_status = 1 \n        AND t.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\'' \n        AND t.block_timestamp < '\''2020-04-01 00:00:00 UTC'\''  \n    GROUP BY\n        1\n    ORDER BY\n        transaction_count DESC\n    LIMIT 5\n),\n\nTotalFees AS (\n    -- CTE 2: Requires a second scan of the '\''transactions'\'' table unnecessarily\n    SELECT\n        t.from_address AS address,\n        SUM(CAST(t.gas_price AS NUMERIC) * CAST(t.receipt_gas_used AS NUMERIC)) AS total_fees_paid\n    FROM\n        `bigquery-public-data.crypto_ethereum_classic.transactions` AS t\n    INNER JOIN\n        TopSenders AS s ON t.from_address = s.address\n    WHERE\n        t.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''\n        AND t.block_timestamp < '\''2020-04-01 00:00:00 UTC'\''\n        AND t.receipt_status = 1\n    GROUP BY\n        1\n),\n\nTotalValueSent AS (\n    -- CTE 3: Scans the '\''traces'\'' table\n    SELECT\n        tr.from_address AS address,\n        SUM(tr.value) AS total_value_sent\n    FROM\n        `bigquery-public-data.crypto_ethereum_classic.traces` AS tr\n    INNER JOIN\n        TopSenders AS s ON tr.from_address = s.address\n    WHERE\n        tr.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''  \n        AND tr.block_timestamp < '\''2020-04-01 00:00:00 UTC'\'' \n    GROUP BY\n        1\n)\n\n-- Final SELECT: Joins the calculated fees and values to find the net ether flow\nSELECT\n    f.address,\n    v.total_value_sent,\n    f.total_fees_paid,\n    v.total_value_sent - f.total_fees_paid AS net_ether_flow_wei\nFROM\n    TotalFees AS f\nINNER JOIN\n    TotalValueSent AS v ON f.address = v.address\nORDER BY\n    net_ether_flow_wei DESC\nLIMIT 100","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anon1a1725b5bb5fe8b9fbffad6cf267cee93229d07b11c4fbbe5b848624cec36afd"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r43d4326465b6a26c_0000019a5dec0c74_1","location":"US"},"statistics":{"creationTime":"1762512342362","startTime":"1762512342489","endTime":"1762512342707","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT","searchStatistics":{"indexUsageMode":"UNUSED","indexUnusedReasons":[{"code":"QUERY_CACHE_HIT","message":"Search indexes are not used because the query was cached."}]}}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ jq -r .jobReference.jobId
++ echo '{"kind":"bigquery#job","etag":"tW2b43T9mtgYUirw2O/1yA==","id":"tony-allen:US.bqjob_r43d4326465b6a26c_0000019a5dec0c74_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r43d4326465b6a26c_0000019a5dec0c74_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"WITH TopSenders AS (\n    -- CTE 1: Identify the top 5 addresses based on the count of successful transactions\n    SELECT\n        t.from_address AS address,\n        COUNT(t.hash) AS transaction_count\n    FROM\n        `bigquery-public-data.crypto_ethereum_classic.transactions` AS t\n    WHERE\n        t.receipt_status = 1 \n        AND t.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\'' \n        AND t.block_timestamp < '\''2020-04-01 00:00:00 UTC'\''  \n    GROUP BY\n        1\n    ORDER BY\n        transaction_count DESC\n    LIMIT 5\n),\n\nTotalFees AS (\n    -- CTE 2: Requires a second scan of the '\''transactions'\'' table unnecessarily\n    SELECT\n        t.from_address AS address,\n        SUM(CAST(t.gas_price AS NUMERIC) * CAST(t.receipt_gas_used AS NUMERIC)) AS total_fees_paid\n    FROM\n        `bigquery-public-data.crypto_ethereum_classic.transactions` AS t\n    INNER JOIN\n        TopSenders AS s ON t.from_address = s.address\n    WHERE\n        t.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''\n        AND t.block_timestamp < '\''2020-04-01 00:00:00 UTC'\''\n        AND t.receipt_status = 1\n    GROUP BY\n        1\n),\n\nTotalValueSent AS (\n    -- CTE 3: Scans the '\''traces'\'' table\n    SELECT\n        tr.from_address AS address,\n        SUM(tr.value) AS total_value_sent\n    FROM\n        `bigquery-public-data.crypto_ethereum_classic.traces` AS tr\n    INNER JOIN\n        TopSenders AS s ON tr.from_address = s.address\n    WHERE\n        tr.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''  \n        AND tr.block_timestamp < '\''2020-04-01 00:00:00 UTC'\'' \n    GROUP BY\n        1\n)\n\n-- Final SELECT: Joins the calculated fees and values to find the net ether flow\nSELECT\n    f.address,\n    v.total_value_sent,\n    f.total_fees_paid,\n    v.total_value_sent - f.total_fees_paid AS net_ether_flow_wei\nFROM\n    TotalFees AS f\nINNER JOIN\n    TotalValueSent AS v ON f.address = v.address\nORDER BY\n    net_ether_flow_wei DESC\nLIMIT 100","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anon1a1725b5bb5fe8b9fbffad6cf267cee93229d07b11c4fbbe5b848624cec36afd"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r43d4326465b6a26c_0000019a5dec0c74_1","location":"US"},"statistics":{"creationTime":"1762512342362","startTime":"1762512342489","endTime":"1762512342707","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT","searchStatistics":{"indexUsageMode":"UNUSED","indexUnusedReasons":[{"code":"QUERY_CACHE_HIT","message":"Search indexes are not used because the query was cached."}]}}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
+ job_id=bqjob_r43d4326465b6a26c_0000019a5dec0c74_1
+ '[' -n bqjob_r43d4326465b6a26c_0000019a5dec0c74_1 ']'
+ echo '  [SUCCESS] Query submitted.'
  [SUCCESS] Query submitted.
+ echo '  *** JOB ID FOR Top Sender Unoptimized: bqjob_r43d4326465b6a26c_0000019a5dec0c74_1 ***'
  *** JOB ID FOR Top Sender Unoptimized: bqjob_r43d4326465b6a26c_0000019a5dec0c74_1 ***
+ echo '  Waiting for job to complete...'
  Waiting for job to complete...
++ bq wait bqjob_r43d4326465b6a26c_0000019a5dec0c74_1
+ wait_output='Waiting on bqjob_r43d4326465b6a26c_0000019a5dec0c74_1 ... (0s) Current status: DONE   
Job tony-allen:bqjob_r43d4326465b6a26c_0000019a5dec0c74_1

  Job Type    State      Start Time         Duration                User Email              Bytes Processed   Bytes Billed   Billing Tier   Labels  
 ---------- --------- ----------------- ---------------- --------------------------------- ----------------- -------------- -------------- -------- 
  query      SUCCESS   07 Nov 10:45:42   0:00:00.218000   admin@bentrollope.altostrat.com   0                 0                                     '
+ '[' 0 -ne 0 ']'
+ echo '  Job completed. Fetching statistics...'
  Job completed. Fetching statistics...
++ bq show --format=json -j bqjob_r43d4326465b6a26c_0000019a5dec0c74_1
+ job_stats_json='{"kind":"bigquery#job","etag":"tW2b43T9mtgYUirw2O/1yA==","id":"tony-allen:US.bqjob_r43d4326465b6a26c_0000019a5dec0c74_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r43d4326465b6a26c_0000019a5dec0c74_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"WITH TopSenders AS (\n    -- CTE 1: Identify the top 5 addresses based on the count of successful transactions\n    SELECT\n        t.from_address AS address,\n        COUNT(t.hash) AS transaction_count\n    FROM\n        `bigquery-public-data.crypto_ethereum_classic.transactions` AS t\n    WHERE\n        t.receipt_status = 1 \n        AND t.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\'' \n        AND t.block_timestamp < '\''2020-04-01 00:00:00 UTC'\''  \n    GROUP BY\n        1\n    ORDER BY\n        transaction_count DESC\n    LIMIT 5\n),\n\nTotalFees AS (\n    -- CTE 2: Requires a second scan of the '\''transactions'\'' table unnecessarily\n    SELECT\n        t.from_address AS address,\n        SUM(CAST(t.gas_price AS NUMERIC) * CAST(t.receipt_gas_used AS NUMERIC)) AS total_fees_paid\n    FROM\n        `bigquery-public-data.crypto_ethereum_classic.transactions` AS t\n    INNER JOIN\n        TopSenders AS s ON t.from_address = s.address\n    WHERE\n        t.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''\n        AND t.block_timestamp < '\''2020-04-01 00:00:00 UTC'\''\n        AND t.receipt_status = 1\n    GROUP BY\n        1\n),\n\nTotalValueSent AS (\n    -- CTE 3: Scans the '\''traces'\'' table\n    SELECT\n        tr.from_address AS address,\n        SUM(tr.value) AS total_value_sent\n    FROM\n        `bigquery-public-data.crypto_ethereum_classic.traces` AS tr\n    INNER JOIN\n        TopSenders AS s ON tr.from_address = s.address\n    WHERE\n        tr.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''  \n        AND tr.block_timestamp < '\''2020-04-01 00:00:00 UTC'\'' \n    GROUP BY\n        1\n)\n\n-- Final SELECT: Joins the calculated fees and values to find the net ether flow\nSELECT\n    f.address,\n    v.total_value_sent,\n    f.total_fees_paid,\n    v.total_value_sent - f.total_fees_paid AS net_ether_flow_wei\nFROM\n    TotalFees AS f\nINNER JOIN\n    TotalValueSent AS v ON f.address = v.address\nORDER BY\n    net_ether_flow_wei DESC\nLIMIT 100","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anon1a1725b5bb5fe8b9fbffad6cf267cee93229d07b11c4fbbe5b848624cec36afd"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r43d4326465b6a26c_0000019a5dec0c74_1","location":"US"},"statistics":{"creationTime":"1762512342362","startTime":"1762512342489","endTime":"1762512342707","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT","searchStatistics":{"indexUsageMode":"UNUSED","indexUnusedReasons":[{"code":"QUERY_CACHE_HIT","message":"Search indexes are not used because the query was cached."}]}}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ echo '{"kind":"bigquery#job","etag":"tW2b43T9mtgYUirw2O/1yA==","id":"tony-allen:US.bqjob_r43d4326465b6a26c_0000019a5dec0c74_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r43d4326465b6a26c_0000019a5dec0c74_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"WITH TopSenders AS (\n    -- CTE 1: Identify the top 5 addresses based on the count of successful transactions\n    SELECT\n        t.from_address AS address,\n        COUNT(t.hash) AS transaction_count\n    FROM\n        `bigquery-public-data.crypto_ethereum_classic.transactions` AS t\n    WHERE\n        t.receipt_status = 1 \n        AND t.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\'' \n        AND t.block_timestamp < '\''2020-04-01 00:00:00 UTC'\''  \n    GROUP BY\n        1\n    ORDER BY\n        transaction_count DESC\n    LIMIT 5\n),\n\nTotalFees AS (\n    -- CTE 2: Requires a second scan of the '\''transactions'\'' table unnecessarily\n    SELECT\n        t.from_address AS address,\n        SUM(CAST(t.gas_price AS NUMERIC) * CAST(t.receipt_gas_used AS NUMERIC)) AS total_fees_paid\n    FROM\n        `bigquery-public-data.crypto_ethereum_classic.transactions` AS t\n    INNER JOIN\n        TopSenders AS s ON t.from_address = s.address\n    WHERE\n        t.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''\n        AND t.block_timestamp < '\''2020-04-01 00:00:00 UTC'\''\n        AND t.receipt_status = 1\n    GROUP BY\n        1\n),\n\nTotalValueSent AS (\n    -- CTE 3: Scans the '\''traces'\'' table\n    SELECT\n        tr.from_address AS address,\n        SUM(tr.value) AS total_value_sent\n    FROM\n        `bigquery-public-data.crypto_ethereum_classic.traces` AS tr\n    INNER JOIN\n        TopSenders AS s ON tr.from_address = s.address\n    WHERE\n        tr.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''  \n        AND tr.block_timestamp < '\''2020-04-01 00:00:00 UTC'\'' \n    GROUP BY\n        1\n)\n\n-- Final SELECT: Joins the calculated fees and values to find the net ether flow\nSELECT\n    f.address,\n    v.total_value_sent,\n    f.total_fees_paid,\n    v.total_value_sent - f.total_fees_paid AS net_ether_flow_wei\nFROM\n    TotalFees AS f\nINNER JOIN\n    TotalValueSent AS v ON f.address = v.address\nORDER BY\n    net_ether_flow_wei DESC\nLIMIT 100","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anon1a1725b5bb5fe8b9fbffad6cf267cee93229d07b11c4fbbe5b848624cec36afd"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r43d4326465b6a26c_0000019a5dec0c74_1","location":"US"},"statistics":{"creationTime":"1762512342362","startTime":"1762512342489","endTime":"1762512342707","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT","searchStatistics":{"indexUsageMode":"UNUSED","indexUnusedReasons":[{"code":"QUERY_CACHE_HIT","message":"Search indexes are not used because the query was cached."}]}}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ jq -r .statistics.totalBytesProcessed
+ total_bytes_processed=0
++ echo '{"kind":"bigquery#job","etag":"tW2b43T9mtgYUirw2O/1yA==","id":"tony-allen:US.bqjob_r43d4326465b6a26c_0000019a5dec0c74_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r43d4326465b6a26c_0000019a5dec0c74_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"WITH TopSenders AS (\n    -- CTE 1: Identify the top 5 addresses based on the count of successful transactions\n    SELECT\n        t.from_address AS address,\n        COUNT(t.hash) AS transaction_count\n    FROM\n        `bigquery-public-data.crypto_ethereum_classic.transactions` AS t\n    WHERE\n        t.receipt_status = 1 \n        AND t.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\'' \n        AND t.block_timestamp < '\''2020-04-01 00:00:00 UTC'\''  \n    GROUP BY\n        1\n    ORDER BY\n        transaction_count DESC\n    LIMIT 5\n),\n\nTotalFees AS (\n    -- CTE 2: Requires a second scan of the '\''transactions'\'' table unnecessarily\n    SELECT\n        t.from_address AS address,\n        SUM(CAST(t.gas_price AS NUMERIC) * CAST(t.receipt_gas_used AS NUMERIC)) AS total_fees_paid\n    FROM\n        `bigquery-public-data.crypto_ethereum_classic.transactions` AS t\n    INNER JOIN\n        TopSenders AS s ON t.from_address = s.address\n    WHERE\n        t.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''\n        AND t.block_timestamp < '\''2020-04-01 00:00:00 UTC'\''\n        AND t.receipt_status = 1\n    GROUP BY\n        1\n),\n\nTotalValueSent AS (\n    -- CTE 3: Scans the '\''traces'\'' table\n    SELECT\n        tr.from_address AS address,\n        SUM(tr.value) AS total_value_sent\n    FROM\n        `bigquery-public-data.crypto_ethereum_classic.traces` AS tr\n    INNER JOIN\n        TopSenders AS s ON tr.from_address = s.address\n    WHERE\n        tr.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''  \n        AND tr.block_timestamp < '\''2020-04-01 00:00:00 UTC'\'' \n    GROUP BY\n        1\n)\n\n-- Final SELECT: Joins the calculated fees and values to find the net ether flow\nSELECT\n    f.address,\n    v.total_value_sent,\n    f.total_fees_paid,\n    v.total_value_sent - f.total_fees_paid AS net_ether_flow_wei\nFROM\n    TotalFees AS f\nINNER JOIN\n    TotalValueSent AS v ON f.address = v.address\nORDER BY\n    net_ether_flow_wei DESC\nLIMIT 100","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anon1a1725b5bb5fe8b9fbffad6cf267cee93229d07b11c4fbbe5b848624cec36afd"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r43d4326465b6a26c_0000019a5dec0c74_1","location":"US"},"statistics":{"creationTime":"1762512342362","startTime":"1762512342489","endTime":"1762512342707","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT","searchStatistics":{"indexUsageMode":"UNUSED","indexUnusedReasons":[{"code":"QUERY_CACHE_HIT","message":"Search indexes are not used because the query was cached."}]}}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ jq -r .statistics.totalSlotMs
+ total_slot_ms=null
++ echo '{"kind":"bigquery#job","etag":"tW2b43T9mtgYUirw2O/1yA==","id":"tony-allen:US.bqjob_r43d4326465b6a26c_0000019a5dec0c74_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r43d4326465b6a26c_0000019a5dec0c74_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"WITH TopSenders AS (\n    -- CTE 1: Identify the top 5 addresses based on the count of successful transactions\n    SELECT\n        t.from_address AS address,\n        COUNT(t.hash) AS transaction_count\n    FROM\n        `bigquery-public-data.crypto_ethereum_classic.transactions` AS t\n    WHERE\n        t.receipt_status = 1 \n        AND t.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\'' \n        AND t.block_timestamp < '\''2020-04-01 00:00:00 UTC'\''  \n    GROUP BY\n        1\n    ORDER BY\n        transaction_count DESC\n    LIMIT 5\n),\n\nTotalFees AS (\n    -- CTE 2: Requires a second scan of the '\''transactions'\'' table unnecessarily\n    SELECT\n        t.from_address AS address,\n        SUM(CAST(t.gas_price AS NUMERIC) * CAST(t.receipt_gas_used AS NUMERIC)) AS total_fees_paid\n    FROM\n        `bigquery-public-data.crypto_ethereum_classic.transactions` AS t\n    INNER JOIN\n        TopSenders AS s ON t.from_address = s.address\n    WHERE\n        t.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''\n        AND t.block_timestamp < '\''2020-04-01 00:00:00 UTC'\''\n        AND t.receipt_status = 1\n    GROUP BY\n        1\n),\n\nTotalValueSent AS (\n    -- CTE 3: Scans the '\''traces'\'' table\n    SELECT\n        tr.from_address AS address,\n        SUM(tr.value) AS total_value_sent\n    FROM\n        `bigquery-public-data.crypto_ethereum_classic.traces` AS tr\n    INNER JOIN\n        TopSenders AS s ON tr.from_address = s.address\n    WHERE\n        tr.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''  \n        AND tr.block_timestamp < '\''2020-04-01 00:00:00 UTC'\'' \n    GROUP BY\n        1\n)\n\n-- Final SELECT: Joins the calculated fees and values to find the net ether flow\nSELECT\n    f.address,\n    v.total_value_sent,\n    f.total_fees_paid,\n    v.total_value_sent - f.total_fees_paid AS net_ether_flow_wei\nFROM\n    TotalFees AS f\nINNER JOIN\n    TotalValueSent AS v ON f.address = v.address\nORDER BY\n    net_ether_flow_wei DESC\nLIMIT 100","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anon1a1725b5bb5fe8b9fbffad6cf267cee93229d07b11c4fbbe5b848624cec36afd"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r43d4326465b6a26c_0000019a5dec0c74_1","location":"US"},"statistics":{"creationTime":"1762512342362","startTime":"1762512342489","endTime":"1762512342707","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT","searchStatistics":{"indexUsageMode":"UNUSED","indexUnusedReasons":[{"code":"QUERY_CACHE_HIT","message":"Search indexes are not used because the query was cached."}]}}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ jq -r .statistics.startTime
+ start_time=1762512342489
++ echo '{"kind":"bigquery#job","etag":"tW2b43T9mtgYUirw2O/1yA==","id":"tony-allen:US.bqjob_r43d4326465b6a26c_0000019a5dec0c74_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r43d4326465b6a26c_0000019a5dec0c74_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"WITH TopSenders AS (\n    -- CTE 1: Identify the top 5 addresses based on the count of successful transactions\n    SELECT\n        t.from_address AS address,\n        COUNT(t.hash) AS transaction_count\n    FROM\n        `bigquery-public-data.crypto_ethereum_classic.transactions` AS t\n    WHERE\n        t.receipt_status = 1 \n        AND t.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\'' \n        AND t.block_timestamp < '\''2020-04-01 00:00:00 UTC'\''  \n    GROUP BY\n        1\n    ORDER BY\n        transaction_count DESC\n    LIMIT 5\n),\n\nTotalFees AS (\n    -- CTE 2: Requires a second scan of the '\''transactions'\'' table unnecessarily\n    SELECT\n        t.from_address AS address,\n        SUM(CAST(t.gas_price AS NUMERIC) * CAST(t.receipt_gas_used AS NUMERIC)) AS total_fees_paid\n    FROM\n        `bigquery-public-data.crypto_ethereum_classic.transactions` AS t\n    INNER JOIN\n        TopSenders AS s ON t.from_address = s.address\n    WHERE\n        t.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''\n        AND t.block_timestamp < '\''2020-04-01 00:00:00 UTC'\''\n        AND t.receipt_status = 1\n    GROUP BY\n        1\n),\n\nTotalValueSent AS (\n    -- CTE 3: Scans the '\''traces'\'' table\n    SELECT\n        tr.from_address AS address,\n        SUM(tr.value) AS total_value_sent\n    FROM\n        `bigquery-public-data.crypto_ethereum_classic.traces` AS tr\n    INNER JOIN\n        TopSenders AS s ON tr.from_address = s.address\n    WHERE\n        tr.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''  \n        AND tr.block_timestamp < '\''2020-04-01 00:00:00 UTC'\'' \n    GROUP BY\n        1\n)\n\n-- Final SELECT: Joins the calculated fees and values to find the net ether flow\nSELECT\n    f.address,\n    v.total_value_sent,\n    f.total_fees_paid,\n    v.total_value_sent - f.total_fees_paid AS net_ether_flow_wei\nFROM\n    TotalFees AS f\nINNER JOIN\n    TotalValueSent AS v ON f.address = v.address\nORDER BY\n    net_ether_flow_wei DESC\nLIMIT 100","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anon1a1725b5bb5fe8b9fbffad6cf267cee93229d07b11c4fbbe5b848624cec36afd"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r43d4326465b6a26c_0000019a5dec0c74_1","location":"US"},"statistics":{"creationTime":"1762512342362","startTime":"1762512342489","endTime":"1762512342707","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT","searchStatistics":{"indexUsageMode":"UNUSED","indexUnusedReasons":[{"code":"QUERY_CACHE_HIT","message":"Search indexes are not used because the query was cached."}]}}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ jq -r .statistics.endTime
+ end_time=1762512342707
++ echo 1762512342489
++ awk '{print int($1)}'
+ start_ms=1762512342489
++ awk '{print int($1)}'
++ echo 1762512342707
+ end_ms=1762512342707
+ duration_ms=218
+ echo '  --- Execution Statistics ---'
  --- Execution Statistics ---
+ echo '  Duration: 218 ms'
  Duration: 218 ms
+ echo '  Bytes Processed: 0 bytes'
  Bytes Processed: 0 bytes
+ echo '  Slot Milliseconds: null'
  Slot Milliseconds: null
+ echo '  ----------------------------'
  ----------------------------
+ echo -e 'Top Sender Unoptimized\tbqjob_r43d4326465b6a26c_0000019a5dec0c74_1\t218\t0\tnull'
+ echo ''

+ run_query 'Top Sender Optimized' 'WITH TransactionSummary AS (
    -- CTE 1 (Optimized): Single scan of the transactions table to calculate fees and rank all relevant senders.
    SELECT
        t.from_address,
        SUM(CAST(t.gas_price AS NUMERIC) * CAST(t.receipt_gas_used AS NUMERIC)) AS total_fees_paid,
        ROW_NUMBER() OVER (
            ORDER BY COUNT(t.hash) DESC
        ) AS rn_transaction_count
    FROM
        `bigquery-public-data.crypto_ethereum_classic.transactions` AS t
    WHERE
        t.receipt_status = 1 
        AND t.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''
        AND t.block_timestamp < '\''2020-04-01 00:00:00 UTC'\''
    GROUP BY
        1
),

TraceSummary AS (
    -- CTE 2 (Optimized): Single scan of the traces table to calculate the total value sent
    SELECT
        tr.from_address,
        SUM(tr.value) AS total_value_sent
    FROM
        `bigquery-public-data.crypto_ethereum_classic.traces` AS tr
    WHERE
        tr.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''  
        AND tr.block_timestamp < '\''2020-04-01 00:00:00 UTC'\''
    GROUP BY
        1
)

-- Final SELECT: Filter to the top 5 addresses (using the rank) and join the two pre-aggregated summaries.
SELECT
    ts.from_address,
    ts.total_fees_paid,
    vs.total_value_sent,
    vs.total_value_sent - ts.total_fees_paid AS net_ether_flow_wei
FROM
    TransactionSummary AS ts
INNER JOIN
    TraceSummary AS vs ON ts.from_address = vs.from_address
WHERE
    ts.rn_transaction_count <= 5 -- Filter down to the top 5 addresses
ORDER BY
    net_ether_flow_wei DESC
LIMIT 100'
+ local 'query_name=Top Sender Optimized'
+ local 'query=WITH TransactionSummary AS (
    -- CTE 1 (Optimized): Single scan of the transactions table to calculate fees and rank all relevant senders.
    SELECT
        t.from_address,
        SUM(CAST(t.gas_price AS NUMERIC) * CAST(t.receipt_gas_used AS NUMERIC)) AS total_fees_paid,
        ROW_NUMBER() OVER (
            ORDER BY COUNT(t.hash) DESC
        ) AS rn_transaction_count
    FROM
        `bigquery-public-data.crypto_ethereum_classic.transactions` AS t
    WHERE
        t.receipt_status = 1 
        AND t.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''
        AND t.block_timestamp < '\''2020-04-01 00:00:00 UTC'\''
    GROUP BY
        1
),

TraceSummary AS (
    -- CTE 2 (Optimized): Single scan of the traces table to calculate the total value sent
    SELECT
        tr.from_address,
        SUM(tr.value) AS total_value_sent
    FROM
        `bigquery-public-data.crypto_ethereum_classic.traces` AS tr
    WHERE
        tr.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''  
        AND tr.block_timestamp < '\''2020-04-01 00:00:00 UTC'\''
    GROUP BY
        1
)

-- Final SELECT: Filter to the top 5 addresses (using the rank) and join the two pre-aggregated summaries.
SELECT
    ts.from_address,
    ts.total_fees_paid,
    vs.total_value_sent,
    vs.total_value_sent - ts.total_fees_paid AS net_ether_flow_wei
FROM
    TransactionSummary AS ts
INNER JOIN
    TraceSummary AS vs ON ts.from_address = vs.from_address
WHERE
    ts.rn_transaction_count <= 5 -- Filter down to the top 5 addresses
ORDER BY
    net_ether_flow_wei DESC
LIMIT 100'
+ echo ==================================================
==================================================
+ echo 'Executing Top Sender Optimized'
Executing Top Sender Optimized
+ echo ==================================================
==================================================
+ echo Query:
Query:
+ echo 'WITH TransactionSummary AS (
    -- CTE 1 (Optimized): Single scan of the transactions table to calculate fees and rank all relevant senders.
    SELECT
        t.from_address,
        SUM(CAST(t.gas_price AS NUMERIC) * CAST(t.receipt_gas_used AS NUMERIC)) AS total_fees_paid,
        ROW_NUMBER() OVER (
            ORDER BY COUNT(t.hash) DESC
        ) AS rn_transaction_count
    FROM
        `bigquery-public-data.crypto_ethereum_classic.transactions` AS t
    WHERE
        t.receipt_status = 1 
        AND t.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''
        AND t.block_timestamp < '\''2020-04-01 00:00:00 UTC'\''
    GROUP BY
        1
),

TraceSummary AS (
    -- CTE 2 (Optimized): Single scan of the traces table to calculate the total value sent
    SELECT
        tr.from_address,
        SUM(tr.value) AS total_value_sent
    FROM
        `bigquery-public-data.crypto_ethereum_classic.traces` AS tr
    WHERE
        tr.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''  
        AND tr.block_timestamp < '\''2020-04-01 00:00:00 UTC'\''
    GROUP BY
        1
)

-- Final SELECT: Filter to the top 5 addresses (using the rank) and join the two pre-aggregated summaries.
SELECT
    ts.from_address,
    ts.total_fees_paid,
    vs.total_value_sent,
    vs.total_value_sent - ts.total_fees_paid AS net_ether_flow_wei
FROM
    TransactionSummary AS ts
INNER JOIN
    TraceSummary AS vs ON ts.from_address = vs.from_address
WHERE
    ts.rn_transaction_count <= 5 -- Filter down to the top 5 addresses
ORDER BY
    net_ether_flow_wei DESC
LIMIT 100'
WITH TransactionSummary AS (
    -- CTE 1 (Optimized): Single scan of the transactions table to calculate fees and rank all relevant senders.
    SELECT
        t.from_address,
        SUM(CAST(t.gas_price AS NUMERIC) * CAST(t.receipt_gas_used AS NUMERIC)) AS total_fees_paid,
        ROW_NUMBER() OVER (
            ORDER BY COUNT(t.hash) DESC
        ) AS rn_transaction_count
    FROM
        `bigquery-public-data.crypto_ethereum_classic.transactions` AS t
    WHERE
        t.receipt_status = 1 
        AND t.block_timestamp >= '2020-01-01 00:00:00 UTC'
        AND t.block_timestamp < '2020-04-01 00:00:00 UTC'
    GROUP BY
        1
),

TraceSummary AS (
    -- CTE 2 (Optimized): Single scan of the traces table to calculate the total value sent
    SELECT
        tr.from_address,
        SUM(tr.value) AS total_value_sent
    FROM
        `bigquery-public-data.crypto_ethereum_classic.traces` AS tr
    WHERE
        tr.block_timestamp >= '2020-01-01 00:00:00 UTC'  
        AND tr.block_timestamp < '2020-04-01 00:00:00 UTC'
    GROUP BY
        1
)

-- Final SELECT: Filter to the top 5 addresses (using the rank) and join the two pre-aggregated summaries.
SELECT
    ts.from_address,
    ts.total_fees_paid,
    vs.total_value_sent,
    vs.total_value_sent - ts.total_fees_paid AS net_ether_flow_wei
FROM
    TransactionSummary AS ts
INNER JOIN
    TraceSummary AS vs ON ts.from_address = vs.from_address
WHERE
    ts.rn_transaction_count <= 5 -- Filter down to the top 5 addresses
ORDER BY
    net_ether_flow_wei DESC
LIMIT 100
+ echo --------------------------------------------------
--------------------------------------------------
++ bq query --nosync --use_legacy_sql=false --format=json --location=US 'WITH TransactionSummary AS (
    -- CTE 1 (Optimized): Single scan of the transactions table to calculate fees and rank all relevant senders.
    SELECT
        t.from_address,
        SUM(CAST(t.gas_price AS NUMERIC) * CAST(t.receipt_gas_used AS NUMERIC)) AS total_fees_paid,
        ROW_NUMBER() OVER (
            ORDER BY COUNT(t.hash) DESC
        ) AS rn_transaction_count
    FROM
        `bigquery-public-data.crypto_ethereum_classic.transactions` AS t
    WHERE
        t.receipt_status = 1 
        AND t.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''
        AND t.block_timestamp < '\''2020-04-01 00:00:00 UTC'\''
    GROUP BY
        1
),

TraceSummary AS (
    -- CTE 2 (Optimized): Single scan of the traces table to calculate the total value sent
    SELECT
        tr.from_address,
        SUM(tr.value) AS total_value_sent
    FROM
        `bigquery-public-data.crypto_ethereum_classic.traces` AS tr
    WHERE
        tr.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''  
        AND tr.block_timestamp < '\''2020-04-01 00:00:00 UTC'\''
    GROUP BY
        1
)

-- Final SELECT: Filter to the top 5 addresses (using the rank) and join the two pre-aggregated summaries.
SELECT
    ts.from_address,
    ts.total_fees_paid,
    vs.total_value_sent,
    vs.total_value_sent - ts.total_fees_paid AS net_ether_flow_wei
FROM
    TransactionSummary AS ts
INNER JOIN
    TraceSummary AS vs ON ts.from_address = vs.from_address
WHERE
    ts.rn_transaction_count <= 5 -- Filter down to the top 5 addresses
ORDER BY
    net_ether_flow_wei DESC
LIMIT 100'
+ job_submission_output='{"kind":"bigquery#job","etag":"5tW1oZn0KMdBt3U5qo/gnw==","id":"tony-allen:US.bqjob_r28ec2e6703986748_0000019a5dec2975_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r28ec2e6703986748_0000019a5dec2975_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"WITH TransactionSummary AS (\n    -- CTE 1 (Optimized): Single scan of the transactions table to calculate fees and rank all relevant senders.\n    SELECT\n        t.from_address,\n        SUM(CAST(t.gas_price AS NUMERIC) * CAST(t.receipt_gas_used AS NUMERIC)) AS total_fees_paid,\n        ROW_NUMBER() OVER (\n            ORDER BY COUNT(t.hash) DESC\n        ) AS rn_transaction_count\n    FROM\n        `bigquery-public-data.crypto_ethereum_classic.transactions` AS t\n    WHERE\n        t.receipt_status = 1 \n        AND t.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''\n        AND t.block_timestamp < '\''2020-04-01 00:00:00 UTC'\''\n    GROUP BY\n        1\n),\n\nTraceSummary AS (\n    -- CTE 2 (Optimized): Single scan of the traces table to calculate the total value sent\n    SELECT\n        tr.from_address,\n        SUM(tr.value) AS total_value_sent\n    FROM\n        `bigquery-public-data.crypto_ethereum_classic.traces` AS tr\n    WHERE\n        tr.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''  \n        AND tr.block_timestamp < '\''2020-04-01 00:00:00 UTC'\''\n    GROUP BY\n        1\n)\n\n-- Final SELECT: Filter to the top 5 addresses (using the rank) and join the two pre-aggregated summaries.\nSELECT\n    ts.from_address,\n    ts.total_fees_paid,\n    vs.total_value_sent,\n    vs.total_value_sent - ts.total_fees_paid AS net_ether_flow_wei\nFROM\n    TransactionSummary AS ts\nINNER JOIN\n    TraceSummary AS vs ON ts.from_address = vs.from_address\nWHERE\n    ts.rn_transaction_count <= 5 -- Filter down to the top 5 addresses\nORDER BY\n    net_ether_flow_wei DESC\nLIMIT 100","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anon53ef68571140dddd7b4c82f8616942905a44d370f931362a0a200be186caddf9"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r28ec2e6703986748_0000019a5dec2975_1","location":"US"},"statistics":{"creationTime":"1762512349806","startTime":"1762512349928","endTime":"1762512350124","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT","searchStatistics":{"indexUsageMode":"UNUSED","indexUnusedReasons":[{"code":"QUERY_CACHE_HIT","message":"Search indexes are not used because the query was cached."}]}}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ echo '{"kind":"bigquery#job","etag":"5tW1oZn0KMdBt3U5qo/gnw==","id":"tony-allen:US.bqjob_r28ec2e6703986748_0000019a5dec2975_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r28ec2e6703986748_0000019a5dec2975_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"WITH TransactionSummary AS (\n    -- CTE 1 (Optimized): Single scan of the transactions table to calculate fees and rank all relevant senders.\n    SELECT\n        t.from_address,\n        SUM(CAST(t.gas_price AS NUMERIC) * CAST(t.receipt_gas_used AS NUMERIC)) AS total_fees_paid,\n        ROW_NUMBER() OVER (\n            ORDER BY COUNT(t.hash) DESC\n        ) AS rn_transaction_count\n    FROM\n        `bigquery-public-data.crypto_ethereum_classic.transactions` AS t\n    WHERE\n        t.receipt_status = 1 \n        AND t.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''\n        AND t.block_timestamp < '\''2020-04-01 00:00:00 UTC'\''\n    GROUP BY\n        1\n),\n\nTraceSummary AS (\n    -- CTE 2 (Optimized): Single scan of the traces table to calculate the total value sent\n    SELECT\n        tr.from_address,\n        SUM(tr.value) AS total_value_sent\n    FROM\n        `bigquery-public-data.crypto_ethereum_classic.traces` AS tr\n    WHERE\n        tr.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''  \n        AND tr.block_timestamp < '\''2020-04-01 00:00:00 UTC'\''\n    GROUP BY\n        1\n)\n\n-- Final SELECT: Filter to the top 5 addresses (using the rank) and join the two pre-aggregated summaries.\nSELECT\n    ts.from_address,\n    ts.total_fees_paid,\n    vs.total_value_sent,\n    vs.total_value_sent - ts.total_fees_paid AS net_ether_flow_wei\nFROM\n    TransactionSummary AS ts\nINNER JOIN\n    TraceSummary AS vs ON ts.from_address = vs.from_address\nWHERE\n    ts.rn_transaction_count <= 5 -- Filter down to the top 5 addresses\nORDER BY\n    net_ether_flow_wei DESC\nLIMIT 100","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anon53ef68571140dddd7b4c82f8616942905a44d370f931362a0a200be186caddf9"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r28ec2e6703986748_0000019a5dec2975_1","location":"US"},"statistics":{"creationTime":"1762512349806","startTime":"1762512349928","endTime":"1762512350124","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT","searchStatistics":{"indexUsageMode":"UNUSED","indexUnusedReasons":[{"code":"QUERY_CACHE_HIT","message":"Search indexes are not used because the query was cached."}]}}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ jq -r .jobReference.jobId
+ job_id=bqjob_r28ec2e6703986748_0000019a5dec2975_1
+ '[' -n bqjob_r28ec2e6703986748_0000019a5dec2975_1 ']'
+ echo '  [SUCCESS] Query submitted.'
  [SUCCESS] Query submitted.
+ echo '  *** JOB ID FOR Top Sender Optimized: bqjob_r28ec2e6703986748_0000019a5dec2975_1 ***'
  *** JOB ID FOR Top Sender Optimized: bqjob_r28ec2e6703986748_0000019a5dec2975_1 ***
+ echo '  Waiting for job to complete...'
  Waiting for job to complete...
++ bq wait bqjob_r28ec2e6703986748_0000019a5dec2975_1
+ wait_output='Waiting on bqjob_r28ec2e6703986748_0000019a5dec2975_1 ... (0s) Current status: DONE   
Job tony-allen:bqjob_r28ec2e6703986748_0000019a5dec2975_1

  Job Type    State      Start Time         Duration                User Email              Bytes Processed   Bytes Billed   Billing Tier   Labels  
 ---------- --------- ----------------- ---------------- --------------------------------- ----------------- -------------- -------------- -------- 
  query      SUCCESS   07 Nov 10:45:49   0:00:00.196000   admin@bentrollope.altostrat.com   0                 0                                     '
+ '[' 0 -ne 0 ']'
+ echo '  Job completed. Fetching statistics...'
  Job completed. Fetching statistics...
++ bq show --format=json -j bqjob_r28ec2e6703986748_0000019a5dec2975_1
+ job_stats_json='{"kind":"bigquery#job","etag":"5tW1oZn0KMdBt3U5qo/gnw==","id":"tony-allen:US.bqjob_r28ec2e6703986748_0000019a5dec2975_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r28ec2e6703986748_0000019a5dec2975_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"WITH TransactionSummary AS (\n    -- CTE 1 (Optimized): Single scan of the transactions table to calculate fees and rank all relevant senders.\n    SELECT\n        t.from_address,\n        SUM(CAST(t.gas_price AS NUMERIC) * CAST(t.receipt_gas_used AS NUMERIC)) AS total_fees_paid,\n        ROW_NUMBER() OVER (\n            ORDER BY COUNT(t.hash) DESC\n        ) AS rn_transaction_count\n    FROM\n        `bigquery-public-data.crypto_ethereum_classic.transactions` AS t\n    WHERE\n        t.receipt_status = 1 \n        AND t.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''\n        AND t.block_timestamp < '\''2020-04-01 00:00:00 UTC'\''\n    GROUP BY\n        1\n),\n\nTraceSummary AS (\n    -- CTE 2 (Optimized): Single scan of the traces table to calculate the total value sent\n    SELECT\n        tr.from_address,\n        SUM(tr.value) AS total_value_sent\n    FROM\n        `bigquery-public-data.crypto_ethereum_classic.traces` AS tr\n    WHERE\n        tr.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''  \n        AND tr.block_timestamp < '\''2020-04-01 00:00:00 UTC'\''\n    GROUP BY\n        1\n)\n\n-- Final SELECT: Filter to the top 5 addresses (using the rank) and join the two pre-aggregated summaries.\nSELECT\n    ts.from_address,\n    ts.total_fees_paid,\n    vs.total_value_sent,\n    vs.total_value_sent - ts.total_fees_paid AS net_ether_flow_wei\nFROM\n    TransactionSummary AS ts\nINNER JOIN\n    TraceSummary AS vs ON ts.from_address = vs.from_address\nWHERE\n    ts.rn_transaction_count <= 5 -- Filter down to the top 5 addresses\nORDER BY\n    net_ether_flow_wei DESC\nLIMIT 100","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anon53ef68571140dddd7b4c82f8616942905a44d370f931362a0a200be186caddf9"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r28ec2e6703986748_0000019a5dec2975_1","location":"US"},"statistics":{"creationTime":"1762512349806","startTime":"1762512349928","endTime":"1762512350124","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT","searchStatistics":{"indexUsageMode":"UNUSED","indexUnusedReasons":[{"code":"QUERY_CACHE_HIT","message":"Search indexes are not used because the query was cached."}]}}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ echo '{"kind":"bigquery#job","etag":"5tW1oZn0KMdBt3U5qo/gnw==","id":"tony-allen:US.bqjob_r28ec2e6703986748_0000019a5dec2975_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r28ec2e6703986748_0000019a5dec2975_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"WITH TransactionSummary AS (\n    -- CTE 1 (Optimized): Single scan of the transactions table to calculate fees and rank all relevant senders.\n    SELECT\n        t.from_address,\n        SUM(CAST(t.gas_price AS NUMERIC) * CAST(t.receipt_gas_used AS NUMERIC)) AS total_fees_paid,\n        ROW_NUMBER() OVER (\n            ORDER BY COUNT(t.hash) DESC\n        ) AS rn_transaction_count\n    FROM\n        `bigquery-public-data.crypto_ethereum_classic.transactions` AS t\n    WHERE\n        t.receipt_status = 1 \n        AND t.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''\n        AND t.block_timestamp < '\''2020-04-01 00:00:00 UTC'\''\n    GROUP BY\n        1\n),\n\nTraceSummary AS (\n    -- CTE 2 (Optimized): Single scan of the traces table to calculate the total value sent\n    SELECT\n        tr.from_address,\n        SUM(tr.value) AS total_value_sent\n    FROM\n        `bigquery-public-data.crypto_ethereum_classic.traces` AS tr\n    WHERE\n        tr.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''  \n        AND tr.block_timestamp < '\''2020-04-01 00:00:00 UTC'\''\n    GROUP BY\n        1\n)\n\n-- Final SELECT: Filter to the top 5 addresses (using the rank) and join the two pre-aggregated summaries.\nSELECT\n    ts.from_address,\n    ts.total_fees_paid,\n    vs.total_value_sent,\n    vs.total_value_sent - ts.total_fees_paid AS net_ether_flow_wei\nFROM\n    TransactionSummary AS ts\nINNER JOIN\n    TraceSummary AS vs ON ts.from_address = vs.from_address\nWHERE\n    ts.rn_transaction_count <= 5 -- Filter down to the top 5 addresses\nORDER BY\n    net_ether_flow_wei DESC\nLIMIT 100","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anon53ef68571140dddd7b4c82f8616942905a44d370f931362a0a200be186caddf9"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r28ec2e6703986748_0000019a5dec2975_1","location":"US"},"statistics":{"creationTime":"1762512349806","startTime":"1762512349928","endTime":"1762512350124","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT","searchStatistics":{"indexUsageMode":"UNUSED","indexUnusedReasons":[{"code":"QUERY_CACHE_HIT","message":"Search indexes are not used because the query was cached."}]}}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ jq -r .statistics.totalBytesProcessed
+ total_bytes_processed=0
++ jq -r .statistics.totalSlotMs
++ echo '{"kind":"bigquery#job","etag":"5tW1oZn0KMdBt3U5qo/gnw==","id":"tony-allen:US.bqjob_r28ec2e6703986748_0000019a5dec2975_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r28ec2e6703986748_0000019a5dec2975_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"WITH TransactionSummary AS (\n    -- CTE 1 (Optimized): Single scan of the transactions table to calculate fees and rank all relevant senders.\n    SELECT\n        t.from_address,\n        SUM(CAST(t.gas_price AS NUMERIC) * CAST(t.receipt_gas_used AS NUMERIC)) AS total_fees_paid,\n        ROW_NUMBER() OVER (\n            ORDER BY COUNT(t.hash) DESC\n        ) AS rn_transaction_count\n    FROM\n        `bigquery-public-data.crypto_ethereum_classic.transactions` AS t\n    WHERE\n        t.receipt_status = 1 \n        AND t.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''\n        AND t.block_timestamp < '\''2020-04-01 00:00:00 UTC'\''\n    GROUP BY\n        1\n),\n\nTraceSummary AS (\n    -- CTE 2 (Optimized): Single scan of the traces table to calculate the total value sent\n    SELECT\n        tr.from_address,\n        SUM(tr.value) AS total_value_sent\n    FROM\n        `bigquery-public-data.crypto_ethereum_classic.traces` AS tr\n    WHERE\n        tr.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''  \n        AND tr.block_timestamp < '\''2020-04-01 00:00:00 UTC'\''\n    GROUP BY\n        1\n)\n\n-- Final SELECT: Filter to the top 5 addresses (using the rank) and join the two pre-aggregated summaries.\nSELECT\n    ts.from_address,\n    ts.total_fees_paid,\n    vs.total_value_sent,\n    vs.total_value_sent - ts.total_fees_paid AS net_ether_flow_wei\nFROM\n    TransactionSummary AS ts\nINNER JOIN\n    TraceSummary AS vs ON ts.from_address = vs.from_address\nWHERE\n    ts.rn_transaction_count <= 5 -- Filter down to the top 5 addresses\nORDER BY\n    net_ether_flow_wei DESC\nLIMIT 100","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anon53ef68571140dddd7b4c82f8616942905a44d370f931362a0a200be186caddf9"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r28ec2e6703986748_0000019a5dec2975_1","location":"US"},"statistics":{"creationTime":"1762512349806","startTime":"1762512349928","endTime":"1762512350124","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT","searchStatistics":{"indexUsageMode":"UNUSED","indexUnusedReasons":[{"code":"QUERY_CACHE_HIT","message":"Search indexes are not used because the query was cached."}]}}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
+ total_slot_ms=null
++ echo '{"kind":"bigquery#job","etag":"5tW1oZn0KMdBt3U5qo/gnw==","id":"tony-allen:US.bqjob_r28ec2e6703986748_0000019a5dec2975_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r28ec2e6703986748_0000019a5dec2975_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"WITH TransactionSummary AS (\n    -- CTE 1 (Optimized): Single scan of the transactions table to calculate fees and rank all relevant senders.\n    SELECT\n        t.from_address,\n        SUM(CAST(t.gas_price AS NUMERIC) * CAST(t.receipt_gas_used AS NUMERIC)) AS total_fees_paid,\n        ROW_NUMBER() OVER (\n            ORDER BY COUNT(t.hash) DESC\n        ) AS rn_transaction_count\n    FROM\n        `bigquery-public-data.crypto_ethereum_classic.transactions` AS t\n    WHERE\n        t.receipt_status = 1 \n        AND t.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''\n        AND t.block_timestamp < '\''2020-04-01 00:00:00 UTC'\''\n    GROUP BY\n        1\n),\n\nTraceSummary AS (\n    -- CTE 2 (Optimized): Single scan of the traces table to calculate the total value sent\n    SELECT\n        tr.from_address,\n        SUM(tr.value) AS total_value_sent\n    FROM\n        `bigquery-public-data.crypto_ethereum_classic.traces` AS tr\n    WHERE\n        tr.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''  \n        AND tr.block_timestamp < '\''2020-04-01 00:00:00 UTC'\''\n    GROUP BY\n        1\n)\n\n-- Final SELECT: Filter to the top 5 addresses (using the rank) and join the two pre-aggregated summaries.\nSELECT\n    ts.from_address,\n    ts.total_fees_paid,\n    vs.total_value_sent,\n    vs.total_value_sent - ts.total_fees_paid AS net_ether_flow_wei\nFROM\n    TransactionSummary AS ts\nINNER JOIN\n    TraceSummary AS vs ON ts.from_address = vs.from_address\nWHERE\n    ts.rn_transaction_count <= 5 -- Filter down to the top 5 addresses\nORDER BY\n    net_ether_flow_wei DESC\nLIMIT 100","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anon53ef68571140dddd7b4c82f8616942905a44d370f931362a0a200be186caddf9"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r28ec2e6703986748_0000019a5dec2975_1","location":"US"},"statistics":{"creationTime":"1762512349806","startTime":"1762512349928","endTime":"1762512350124","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT","searchStatistics":{"indexUsageMode":"UNUSED","indexUnusedReasons":[{"code":"QUERY_CACHE_HIT","message":"Search indexes are not used because the query was cached."}]}}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
++ jq -r .statistics.startTime
+ start_time=1762512349928
++ jq -r .statistics.endTime
++ echo '{"kind":"bigquery#job","etag":"5tW1oZn0KMdBt3U5qo/gnw==","id":"tony-allen:US.bqjob_r28ec2e6703986748_0000019a5dec2975_1","selfLink":"https://bigquery.googleapis.com/bigquery/v2/projects/tony-allen/jobs/bqjob_r28ec2e6703986748_0000019a5dec2975_1?location=US","user_email":"admin@bentrollope.altostrat.com","configuration":{"query":{"query":"WITH TransactionSummary AS (\n    -- CTE 1 (Optimized): Single scan of the transactions table to calculate fees and rank all relevant senders.\n    SELECT\n        t.from_address,\n        SUM(CAST(t.gas_price AS NUMERIC) * CAST(t.receipt_gas_used AS NUMERIC)) AS total_fees_paid,\n        ROW_NUMBER() OVER (\n            ORDER BY COUNT(t.hash) DESC\n        ) AS rn_transaction_count\n    FROM\n        `bigquery-public-data.crypto_ethereum_classic.transactions` AS t\n    WHERE\n        t.receipt_status = 1 \n        AND t.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''\n        AND t.block_timestamp < '\''2020-04-01 00:00:00 UTC'\''\n    GROUP BY\n        1\n),\n\nTraceSummary AS (\n    -- CTE 2 (Optimized): Single scan of the traces table to calculate the total value sent\n    SELECT\n        tr.from_address,\n        SUM(tr.value) AS total_value_sent\n    FROM\n        `bigquery-public-data.crypto_ethereum_classic.traces` AS tr\n    WHERE\n        tr.block_timestamp >= '\''2020-01-01 00:00:00 UTC'\''  \n        AND tr.block_timestamp < '\''2020-04-01 00:00:00 UTC'\''\n    GROUP BY\n        1\n)\n\n-- Final SELECT: Filter to the top 5 addresses (using the rank) and join the two pre-aggregated summaries.\nSELECT\n    ts.from_address,\n    ts.total_fees_paid,\n    vs.total_value_sent,\n    vs.total_value_sent - ts.total_fees_paid AS net_ether_flow_wei\nFROM\n    TransactionSummary AS ts\nINNER JOIN\n    TraceSummary AS vs ON ts.from_address = vs.from_address\nWHERE\n    ts.rn_transaction_count <= 5 -- Filter down to the top 5 addresses\nORDER BY\n    net_ether_flow_wei DESC\nLIMIT 100","destinationTable":{"projectId":"tony-allen","datasetId":"_e34c49c766e4fd3f5d404c3949b9e19fa7acb372","tableId":"anon53ef68571140dddd7b4c82f8616942905a44d370f931362a0a200be186caddf9"},"writeDisposition":"WRITE_TRUNCATE","priority":"INTERACTIVE","useLegacySql":false},"jobType":"QUERY"},"jobReference":{"projectId":"tony-allen","jobId":"bqjob_r28ec2e6703986748_0000019a5dec2975_1","location":"US"},"statistics":{"creationTime":"1762512349806","startTime":"1762512349928","endTime":"1762512350124","totalBytesProcessed":"0","query":{"totalBytesProcessed":"0","totalBytesBilled":"0","cacheHit":true,"statementType":"SELECT","searchStatistics":{"indexUsageMode":"UNUSED","indexUnusedReasons":[{"code":"QUERY_CACHE_HIT","message":"Search indexes are not used because the query was cached."}]}}},"status":{"state":"DONE"},"principal_subject":"user:admin@bentrollope.altostrat.com","jobCreationReason":{"code":"REQUESTED"}}'
+ end_time=1762512350124
++ echo 1762512349928
++ awk '{print int($1)}'
+ start_ms=1762512349928
++ echo 1762512350124
++ awk '{print int($1)}'
+ end_ms=1762512350124
+ duration_ms=196
+ echo '  --- Execution Statistics ---'
  --- Execution Statistics ---
+ echo '  Duration: 196 ms'
  Duration: 196 ms
+ echo '  Bytes Processed: 0 bytes'
  Bytes Processed: 0 bytes
+ echo '  Slot Milliseconds: null'
  Slot Milliseconds: null
+ echo '  ----------------------------'
  ----------------------------
+ echo -e 'Top Sender Optimized\tbqjob_r28ec2e6703986748_0000019a5dec2975_1\t196\t0\tnull'
+ echo ''

+ set +x
===========================================================
Script finished at Fri Nov  7 10:45:54 AM UTC 2025.
